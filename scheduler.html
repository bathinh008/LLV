<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>L·ªãch l√†m vi·ªác tu·∫ßn</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>

<style>
/* ================= FONTS & RESET ================= */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
    --primary-color: #4a90e2;    /* Xanh d∆∞∆°ng hi·ªán ƒë·∫°i */
    --success-color: #2ecc71;    /* Xanh l√° t∆∞∆°i */
    --warning-color: #f39c12;    /* V√†ng cam */
    --danger-color: #e74c3c;     /* ƒê·ªè */
    --text-color: #2c3e50;
    --bg-color: #f0f2f5;
    --card-bg: #ffffff;
    --border-color: #e1e4e8;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    margin: 0;
    padding: 20px;
    line-height: 1.5;
}

/* ================= LAYOUT HEADER ================= */
h1 {
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 5px;
    letter-spacing: -0.5px;
    text-transform: uppercase;
    font-size: 24px;
}

.header-week {
    font-size: 16px;
    color: #555;
    background: #fff;
    display: inline-block;
    padding: 5px 15px;
    border-radius: 20px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 5px;
    font-weight: 500;
}

.group-label {
    font-size: 14px;
    color: #7f8c8d;
    margin-bottom: 20px;
    font-style: normal;
    font-weight: 600;
}

/* ================= CONTROL BAR ================= */
.control-bar {
    background: var(--card-bg);
    padding: 15px;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    align-items: center;
    border: 1px solid var(--border-color);
}

button {
    font-family: 'Inter', sans-serif;
    padding: 9px 16px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 2px 2px rgba(0,0,0,0.05);
}

button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); filter: brightness(105%); }
button:active { transform: translateY(0); }

.btn-primary { background: var(--primary-color); color: white; }
.btn-success { background: var(--success-color); color: white; }
.btn-warning { background: var(--warning-color); color: white; }
.btn-danger  { background: var(--danger-color); color: white; }
.btn-outline { background: white; border: 1px solid #bdc3c7; color: #555; }
.btn-outline:hover { border-color: var(--primary-color); color: var(--primary-color); }

/* ================= TABLE STYLES ================= */
table {
    width: 100%;
    border-collapse: separate; /* ƒê·ªÉ bo g√≥c */
    border-spacing: 0;
    background: var(--card-bg);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-md);
    margin-bottom: 50px;
}

thead {
    background: #f8f9fa;
    position: sticky; /* C·ªë ƒë·ªãnh header khi scroll */
    top: 0;
    z-index: 5;
}

th {
    padding: 12px 8px;
    font-size: 13px;
    font-weight: 700;
    color: #444;
    text-transform: uppercase;
    border-bottom: 2px solid #dfe6e9;
    border-right: 1px solid #f1f1f1;
    background: #f8f9fa; /* ƒê·ªÉ sticky ho·∫°t ƒë·ªông t·ªët */
}

td {
    padding: 8px 5px;
    border-bottom: 1px solid #eee;
    border-right: 1px solid #f9f9f9;
    font-size: 13px;
    text-align: center;
    height: 40px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh cho √¥ */
    transition: background 0.1s;
}

/* Hover d√≤ng */
tr:hover td { background-color: #fcfcfc; }

/* C√°c c·ªôt th√¥ng tin nh√¢n vi√™n */
.emp-code { color: #888; font-family: monospace; font-size: 12px; }
.emp-name { font-weight: 600; color: #333; text-align: left; padding-left: 10px; }
.emp-role { font-size: 12px; color: #666; background: #f0f3f4; border-radius: 4px; padding: 2px 6px; display: inline-block; }

/* √î L·ªãch (Shift) */
.shift {
    cursor: pointer;
    font-weight: 600;
    position: relative;
    user-select: none;
}
.shift:hover {
    background-color: #ebf5fb !important; /* Highlight khi di chu·ªôt */
    box-shadow: inset 0 0 0 2px var(--primary-color);
}

/* M√†u s·∫Øc c√°c Ca - Tone m√†u Pastel d·ªãu m·∫Øt h∆°n */
.ca-s  { background-color: #e3f2fd; color: #1565c0; }     /* S√°ng: Xanh nh·∫°t */
.ca-c  { background-color: #e8f5e9; color: #2e7d32; }     /* Chi·ªÅu: Xanh l√° nh·∫°t */
.ca-hc { background-color: #f3e5f5; color: #7b1fa2; }     /* HC: T√≠m nh·∫°t */
.ca-nc { background-color: #fff3e0; color: #ef6c00; }     /* CN: Cam nh·∫°t */
.ca-nb { background-color: #ffebee; color: #c62828; }     /* B√π: ƒê·ªè nh·∫°t */
.ca-p  { background-color: #fce4ec; color: #ad1457; }     /* Ph√©p: H·ªìng */
.ca-ct { background-color: #e0f7fa; color: #006064; }     /* C√¥ng t√°c: Cyan */
.ca-s-plus { background-color: #fff9c4; color: #fbc02d; font-weight: 700; border: 1px solid #fff176;} 

/* Hi·ªáu ·ª©ng ch·ªçn √¥ */
.cell-selected {
    box-shadow: inset 0 0 0 2px var(--primary-color) !important;
    background-color: rgba(52, 152, 219, 0.1) !important;
}
.cell-multi-selected {
    background-color: rgba(52, 152, 219, 0.2) !important;
    border: 1px dashed var(--primary-color);
}

/* Header s·ªë d∆∞ */
.col-p-old, .col-p-new, .col-b-old, .col-b-new {
    font-size: 11px; 
    border-radius: 4px;
}

/* ================= POPUP / MODAL ================= */
.popup-bg {
    display: none; /* <--- D√íNG QUAN TR·ªåNG NH·∫§T: M·∫∑c ƒë·ªãnh ph·∫£i ·∫©n ƒëi */
    position: fixed;
    top: 0; 
    left: 0;
    width: 100%; 
    height: 100%;
    z-index: 9999; /* Lu√¥n n·∫±m tr√™n c√πng */
    justify-content: center; /* CƒÉn gi·ªØa ngang */
    align-items: center;     /* CƒÉn gi·ªØa d·ªçc */
    
    background: rgba(44, 62, 80, 0.6); /* M√†u n·ªÅn t·ªëi m·ªù */
    backdrop-filter: blur(2px);        /* Hi·ªáu ·ª©ng l√†m m·ªù ph√≠a sau */
}

.popup-box {
    background: #fff;
    /* M·∫πo: ƒê·∫∑t padding-top = 0 ƒë·ªÉ ti√™u ƒë·ªÅ n·∫±m s√°t m√©p tr√™n c√πng */
    padding: 0 20px 20px 20px; 
    
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    
    /* Animation hi·ªán ra nh·∫π nh√†ng */
    animation: slideIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    
    /* ƒê·∫∑t max-height ƒë·ªÉ n·∫øu danh s√°ch d√†i qu√° th√¨ n√≥ t·ª± cu·ªôn, kh√¥ng b·ªã tr√†n m√†n h√¨nh */
    max-height: 90vh;
    overflow-y: auto;
}

@keyframes slideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.popup-box h3 {
    background: var(--primary-color);
    color: white;
    
    /* QUAN TR·ªåNG: margin-top = 0 (kh√¥ng k√©o l√™n n·ªØa) */
    /* Ch·ªâ k√©o margin tr√°i/ph·∫£i √¢m ƒë·ªÉ tr√†n vi·ªÅn 2 b√™n */
    margin: 0 -20px 20px -20px; 
    
    padding: 15px 20px;
    font-size: 16px;
    font-weight: 600;
    
    /* Bo g√≥c tr√™n ƒë·ªÉ kh·ªõp v·ªõi c√°i h·ªôp */
    border-radius: 16px 16px 0 0;
    
    /* D√≠nh header l√™n ƒë·∫ßu khi cu·ªôn danh s√°ch d√†i */
    position: sticky;
    top: 0;
    z-index: 10;
}

.popup-box input, .popup-box select {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    font-size: 14px;
    transition: 0.2s;
}
.popup-box input:focus, .popup-box select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
}

/* ================= CONTEXT MENU (Shift Menu) ================= */
#shiftMenu {
    border: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    border-radius: 8px;
    padding: 5px;
    min-width: 150px;
}
#shiftMenu button {
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 13px;
    color: #333;
    display: flex;
    align-items: center;
    width: 100%;
    margin-bottom: 2px;
}
#shiftMenu button:hover {
    background-color: var(--primary-color);
    color: white;
}
#shiftMenu button b {
    display: inline-block;
    width: 30px;
    text-align: center;
    margin-right: 8px;
    background: rgba(0,0,0,0.1);
    border-radius: 4px;
    padding: 2px 0;
}

/* CSS Swap */
.swap-selected {
    outline: 2px dashed var(--warning-color) !important;
    background: #fff9e6 !important;
    transform: scale(0.99);
}

.noselect { user-select: none; }
</style>
</head>
<body>

<h1>L·ªäCH L√ÄM VI·ªÜC</h1>
<div class="header-week" id="weekRange"></div>
<div class="group-label" id="groupLabel"></div>

<div class="control-bar">
    <div style="display:flex; gap:5px; border-right:1px solid #ddd; padding-right:10px;">
        <button class="btn-primary" onclick="openRequestsPopup()">
             üîî Y√™u c·∫ßu <span id="badgeCount" style="display:none; background:red; color:white; border-radius:50%; padding:2px 5px; font-size:10px; margin-left:5px;">0</span>
        </button>
        <button class="btn-primary" onclick="openAddEmpPopup()">‚ûï NV</button>
        <button class="btn-primary" onclick="openBulkLeavePopup()">‚ûï Ph√©p/B√π</button>
    </div>

    <div style="display:flex; gap:5px; border-right:1px solid #ddd; padding-right:10px;">
        <button class="btn-success" onclick="autoAssignShifts()">‚ö° Chia ca</button>
        <button class="btn-outline" onclick="enableSwap()">‚áå ƒê·∫£o</button> 
        <button class="btn-outline" onclick="openWeekPopup()">üìÖ Tu·∫ßn m·ªõi</button>
        <button class="btn-outline" onclick="openOldWeekPopup()">üìÇ M·ªü l·∫°i</button>
    </div>

    <div style="display:flex; gap:5px;">
        <button class="btn-warning" onclick="saveSchedule()">üíæ L∆∞u</button>
        <button class="btn-warning" onclick="exportToExcel()">üìä Excel</button>
        <button class="btn-warning" onclick="openExportRangePopup()">üìÖ Xu·∫•t T√πy Ch·ªçn</button>
        <button class="btn-outline" onclick="goBack()">‚Üê V·ªÅ Home</button>
    </div>
</div>

<table id="scheduleTable">
    <thead>
        <tr>
            <th rowspan="2" style="width: 30px;">STT</th>
            <th rowspan="2" style="width: 60px;">M√É NV</th>
            <th rowspan="2" style="width: 150px;">H·ªå T√äN</th>
            <th rowspan="2" style="width: 80px;">CH·ª®C V·ª§</th>
            
            <th>T2</th><th>T3</th><th>T4</th><th>T5</th><th>T6</th><th>T7</th><th>CN</th>
            
            <th rowspan="2" class="col-p-old" style="display:none;">PH√âP C≈®</th>
            <th rowspan="2" class="col-p-new">PH√âP M·ªöI</th>
            <th rowspan="2" class="col-b-old" style="display:none;">B√ô C≈®</th>
            <th rowspan="2" class="col-b-new">B√ô M·ªöI</th>
            
            <th rowspan="2" style="background-color: #fff3cd; color: #d35400;">T·ªîNG</th>

            <th rowspan="2" style="width: 40px;">X√ìA</th>
        </tr>
        <tr id="headerDatesRow"></tr>
    </thead>
    <tbody id="staffRows"></tbody>
</table>

<div id="shiftMenu"></div>

<div id="addEmpPopup" class="popup-bg">
    <div class="popup-box">
        <h3>Th√™m nh√¢n vi√™n</h3>
        <input id="empCode" placeholder="M√£ nh√¢n vi√™n (VD: NV01)">
        <input id="empName" placeholder="H·ªç t√™n nh√¢n vi√™n">
        <input id="empRole" placeholder="Ch·ª©c v·ª•">
        <button class="btn-primary" onclick="saveNewEmployee()">L∆∞u</button>
        <button class="btn-danger" onclick="closeAddEmpPopup()">H·ªßy</button>
    </div>
</div>

<div id="weekPopup" class="popup-bg">
    <div class="popup-box">
        <h3>Ch·ªçn ng√†y b·∫Øt ƒë·∫ßu (Th·ª© 2)</h3>
        <input id="weekStart" type="date">
        <button class="btn-primary" onclick="applyNewWeek()">T·∫°o</button>
        <button class="btn-danger" onclick="closeWeekPopup()">ƒê√≥ng</button>
    </div>
</div>

<div id="oldWeekPopup" class="popup-bg">
    <div class="popup-box">
        <h3>Ch·ªçn tu·∫ßn ƒë√£ l∆∞u</h3>
        <select id="weekSelect"></select>
        <button class="btn-primary" onclick="loadSelectedWeek()">T·∫£i tu·∫ßn</button>
        <button class="btn-danger" onclick="closeOldWeekPopup()">ƒê√≥ng</button>
    </div>
</div>

<div id="bulkLeavePopup" class="popup-bg">
    <div class="popup-box" style="width: 500px;">
        <h3>‚ûï Th√™m Ph√©p / B√π</h3>
        <div style="display:flex; gap:10px;">
            <select id="bulkLeaveType" style="flex:1;">
                <option value="NB">Ng√†y B√π (NB)</option>
                <option value="PN">Ph√©p NƒÉm (PN)</option>
            </select>
            <input id="bulkLeaveAmount" type="number" step="0.5" min="0.5" value="1" style="width: 100px;" title="S·ªë l∆∞·ª£ng">
        </div>
        <input id="bulkLeaveReason" placeholder="L√Ω do (V√≠ d·ª•: Tr·ª±c l·ªÖ, TƒÉng ca...)" style="margin-top: 10px;">
        <div style="margin: 10px 0; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px;">
            <input type="checkbox" id="checkAllBulk" checked onclick="toggleCheckAll(this.checked)"> Ch·ªçn t·∫•t c·∫£
        </div>
        <div id="bulkEmployeeList" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background: #fafafa; border-radius: 4px;"></div>
        <div style="margin-top: 15px; text-align: right;">
            <button class="btn-danger" onclick="closeBulkLeavePopup()">H·ªßy</button>
            <button class="btn-primary" onclick="saveBulkLeave()">X√°c nh·∫≠n</button>
        </div>
    </div>
</div>

<div id="requestsPopup" class="popup-bg">
    <div class="popup-box" style="width: 700px; max-width:95%;">
        <h3>üîî Danh S√°ch Y√™u C·∫ßu Ngh·ªâ</h3>
        <div id="reqListContainer" style="max-height: 400px; overflow-y: auto;">
            <table style="width:100%; font-size:13px;">
                <thead>
                    <tr>
                        <th>Th·ªùi gian</th>
                        <th>NV</th>
                        <th>Lo·∫°i</th>
                        <th>Ng√†y ngh·ªâ</th>
                        <th>L√Ω do</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="reqTableBody"></tbody>
            </table>
            <p id="noReqMsg" style="text-align:center; color:#888; display:none;">Kh√¥ng c√≥ y√™u c·∫ßu n√†o.</p>
        </div>
        <div style="text-align:right; margin-top:15px;">
            <button class="btn-outline" onclick="closeRequestsPopup()">ƒê√≥ng</button>
        </div>
    </div>
</div>

<div id="exportRangePopup" class="popup-bg">
    <div class="popup-box">
        <h3>Xu·∫•t B√°o C√°o Excel</h3>
        <label>T·ª´ ng√†y:</label>
        <input type="date" id="expFrom">
        <label>ƒê·∫øn ng√†y:</label>
        <input type="date" id="expTo">
        
        <div style="margin-top:15px; text-align:right;">
            <button class="btn-danger" onclick="document.getElementById('exportRangePopup').style.display='none'">ƒê√≥ng</button>
            <button class="btn-success" onclick="doExportRange()">T·∫£i v·ªÅ</button>
        </div>
    </div>
</div>

<script>
/* ===========================================================
    CONFIG + KH·ªûI T·∫†O (D√ÄNH CHO SCHEDULER.HTML)
=========================================================== */
const SCRIPT_URL = localStorage.getItem("SCRIPT_URL");

// 1. L·∫•y Group t·ª´ URL (Do Dashboard truy·ªÅn sang)
// V√≠ d·ª•: scheduler.html?group=kinhdoanh
const params = new URLSearchParams(window.location.search);
let currentGroup = params.get("group");

// N·∫øu URL kh√¥ng c√≥ group, th·ª≠ l·∫•y group ch√≠nh c·ªßa user ƒëƒÉng nh·∫≠p
if (!currentGroup) {
    currentGroup = localStorage.getItem("currentGroup") || "";
}

// N·∫øu v·∫´n kh√¥ng c√≥ group n√†o -> B√°o l·ªói quay v·ªÅ Dashboard
if (!currentGroup) {
    alert("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c nh√≥m l√†m vi·ªác! Vui l√≤ng ch·ªçn nh√≥m t·ª´ Dashboard.");
    window.location.href = "dashboard.html";
}

// Hi·ªÉn th·ªã t√™n nh√≥m l√™n giao di·ªán
document.getElementById("groupLabel").innerText = "Nh√≥m: " + currentGroup;

// C√°c bi·∫øn to√†n c·ª•c kh√°c
const staffTbody     = document.getElementById("staffRows");
const headerDatesRow = document.getElementById("headerDatesRow");
const weekRangeEl    = document.getElementById("weekRange");

// Danh s√°ch m√£ ca (Gi·ªØ nguy√™n c·ªßa b·∫°n)
const SHIFTS = [
  { code:"",   label:"(Tr·ªëng)",        className:""      },
  { code:"S",  label:"Ca s√°ng (S)",    className:"ca-s"  },
  { code:"S1", label:"Ca S1",          className:"ca-s"  },
  { code:"S+", label:"Ca s√°ng (Ch√†o c·ªù)", className:"ca-s-plus" },
  { code:"C",  label:"Ca chi·ªÅu (C)",   className:"ca-c"  },
  { code:"HC", label:"H√†nh ch√≠nh",     className:"ca-hc" },
  { code:"NB", label:"Ngh·ªâ b√π (1.0)",  className:"ca-nb" },
  { code:"NB/2", label:"Ngh·ªâ b√π (0.5)",className:"ca-nb" },
  { code:"NC", label:"Ngh·ªâ CN",        className:"ca-nc" },
  { code:"P",  label:"Ngh·ªâ ph√©p (1.0)",className:"ca-p"  },
  { code:"P/2", label:"Ngh·ªâ ph√©p (0.5)",className:"ca-p"  },
  { code:"CT", label:"C√¥ng t√°c",       className:"ca-ct" }
];

let currentEditedCell = null;
const shiftMenu = document.getElementById("shiftMenu");
let swapRow1 = null;

// --- INIT ---
document.addEventListener("DOMContentLoaded", () => {
    if (!SCRIPT_URL) {
        alert("Ch∆∞a ƒëƒÉng nh·∫≠p! Vui l√≤ng quay l·∫°i trang Login.");
        window.location.href = "index.html"; 
        return;
    }
    
    // T·∫£i d·ªØ li·ªáu tu·∫ßn g·∫ßn nh·∫•t c·ªßa nh√≥m n√†y
    loadLastSavedWeek();
    
    // Kh·ªüi t·∫°o th√¥ng b√°o (n·∫øu b·∫°n mu·ªën hi·ªán th√¥ng b√°o ·ªü trang n√†y)
    initNotifications();
});

/* ===========================================================
    INIT
=========================================================== */
document.addEventListener("DOMContentLoaded", () => {
    if (!SCRIPT_URL) {
        alert("Ch∆∞a ƒëƒÉng nh·∫≠p! Vui l√≤ng quay l·∫°i trang Login.");
        window.location.href = "index.html"; 
        return;
    }
    loadLastSavedWeek();
    
    // KH·ªûI T·∫†O CHECK TH√îNG B√ÅO (M·ªöI)
    initNotifications();
});

/* ===========================================================
    1) T·∫†O HEADER NG√ÄY
=========================================================== */
function generateDates(startDate) {
    const arr = [];
    const d = new Date(startDate);
    for (let i = 0; i < 7; i++) {
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        arr.push(`${dd}/${mm}`);
        d.setDate(d.getDate()+1);
    }
    return arr;
}

function initDefaultWeek() {
    const today = new Date();
    const monday = new Date(today);
    monday.setDate(today.getDate() - ((today.getDay() + 6) % 7)); 
    updateWeekHeader(monday);
}

function updateWeekHeader(start) {
    const dates = generateDates(start);
    headerDatesRow.innerHTML = dates.map(d => `<th>${d}</th>`).join("");

    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    const d1 = `${String(start.getDate()).padStart(2,"0")}/${String(start.getMonth()+1).padStart(2,"0")}`;
    const d2 = `${String(end.getDate()).padStart(2,"0")}/${String(end.getMonth()+1).padStart(2,"0")}/${end.getFullYear()}`;
    weekRangeEl.innerText = `Tu·∫ßn t·ª´ ${d1} ƒë·∫øn ${d2}`;
}

function getCurrentWeekStart() {
    const firstTh = headerDatesRow.querySelector("th");
    if (!firstTh) return null;
    const [dd, mm] = firstTh.innerText.split("/");
    const yearMatch = weekRangeEl.innerText.match(/(\d{4})\s*$/);
    const year = yearMatch ? yearMatch[1] : new Date().getFullYear();
    return `${year}-${mm}-${dd}`;
}

/* ===========================================================
    2) H√ÄNG NH√ÇN VI√äN & HI·ªÇN TH·ªä C·ªòT ƒê·ªòNG
=========================================================== */
function appendEmployeeRow(code, name, role, pOld, pNew, bOld, bNew) {
    const tr = document.createElement("tr");
    
    // T√çNH T·ªîNG S·ªê D∆Ø
    const valPOld = Number(pOld) || 0;
    const valPNew = Number(pNew) || 0;
    const valBOld = Number(bOld) || 0;
    const valBNew = Number(bNew) || 0;
    const totalRemaining = valPOld + valPNew + valBOld + valBNew;

    // ƒê√£ x√≥a contenteditable ƒë·ªÉ ReadOnly
    tr.innerHTML = `
        <td class="stt"></td>
        <td class="emp-code">${code || ""}</td>
        <td class="emp-name">${name || ""}</td>
        <td class="emp-role">${role || ""}</td>
        ${[0,1,2,3,4,5,6].map(i => `<td class="shift" data-day="${i}"></td>`).join("")}
        
        <td class="col-p-old" style="display:none; font-weight:bold; color:#c0392b;">${valPOld}</td>
        <td class="col-p-new" style="font-weight:bold; color:#c0392b;">${valPNew}</td>
        <td class="col-b-old" style="display:none; font-weight:bold; color:#2980b9;">${valBOld}</td>
        <td class="col-b-new" style="font-weight:bold; color:#2980b9;">${valBNew}</td>
        
        <td style="font-weight:bold; color:#d35400; background-color: #fff3cd; text-align:center;">
            ${totalRemaining}
        </td>
        
        <td><button class="btn-danger" onclick="deleteEmployee(this)">X</button></td>
    `;
    staffTbody.appendChild(tr);

    tr.querySelectorAll(".shift").forEach(td => {
        td.addEventListener("click", onShiftCellClick);
    });
    
    if (swapRow1) {
        tr.onclick = onSwapRowClick;
        tr.style.cursor = 'pointer';
    }
    updateStt();
}

function updateStt() {
    [...staffTbody.querySelectorAll(".stt")].forEach((td, i) => td.innerText = i + 1);
}

/* ===========================================================
    3) LOAD DATA T·ª™ SERVER
=========================================================== */
async function loadLastSavedWeek() {
    const res = await fetch(`${SCRIPT_URL}?action=getLastSavedWeek&group=${encodeURIComponent(currentGroup)}`);
    let json;
    try { json = await res.json(); } catch(e) { console.error(e); }

    if (!json || !json.weekStart) {
        initDefaultWeek(); 
        loadScheduleOfCurrentWeek(); 
        return;
    }

    const start = new Date(json.weekStart);
    updateWeekHeader(start);
    if (json.weekRange) weekRangeEl.innerText = json.weekRange;
    loadScheduleOfCurrentWeek(json.weekStart);
}

async function loadScheduleOfCurrentWeek(explicitWeekStart) {
    const weekStart = explicitWeekStart || getCurrentWeekStart();
    if (!weekStart) return;

    const res = await fetch(
        `${SCRIPT_URL}?action=getSchedule`
        + `&group=${encodeURIComponent(currentGroup)}`
        + `&weekStart=${encodeURIComponent(weekStart)}`
    );

    const text = await res.text();
    let json;
    try { json = JSON.parse(text); }
    catch(err) {
        console.error("JSON ERROR:", err, text);
        alert("L·ªói d·ªØ li·ªáu t·ª´ server.");
        return;
    }

    if (json.weekRange) weekRangeEl.innerText = json.weekRange;

    staffTbody.innerHTML = "";
    
    // ·∫®n hi·ªán c·ªôt c≈©
    const prevYear = json.prevYear;
    const curYear = json.currentYear;
    const data = json.data || [];

    let showPOld = false;
    let showBOld = false;

    data.forEach(rec => {
        if (Number(rec.phep_old) > 0) showPOld = true;
        if (Number(rec.bu_old) > 0) showBOld = true;
    });

    document.querySelector(".col-p-old").innerText = `PH√âP ${prevYear}`;
    document.querySelector(".col-p-new").innerText = `PH√âP ${curYear}`;
    document.querySelector(".col-b-old").innerText = `B√ô ${prevYear}`;
    document.querySelector(".col-b-new").innerText = `B√ô ${curYear}`;

    const setDisplay = (cls, isShow) => {
        document.querySelectorAll(cls).forEach(el => el.style.display = isShow ? "table-cell" : "none");
    };

    data.forEach(rec => {
        appendEmployeeRow(rec.code, rec.name, rec.role, rec.phep_old, rec.phep_new, rec.bu_old, rec.bu_new);
        
        const tr = staffTbody.lastElementChild;
        const tds = tr.querySelectorAll(".shift");
        const shiftsArr = (rec.shifts && rec.shifts.length === 7) ? rec.shifts : ["","","","","","",""];

        shiftsArr.forEach((code, idx) => {
            if (!tds[idx]) return;
            const shiftObj = SHIFTS.find(s => s.code === code);
            const cls = shiftObj ? shiftObj.className : "";
            setShiftOnCell(tds[idx], code, cls);
        });
    });

    setDisplay(".col-p-old", showPOld);
    setDisplay(".col-b-old", showBOld);
    setDisplay(".col-p-new", true); 
    setDisplay(".col-b-new", true);
    
    updateStt();
}

/* ===========================================================
    4) MENU CH·ªåN CA
=========================================================== */
function onShiftCellClick(e) {
    if (swapRow1) return; // ƒêang swap th√¨ kh√¥ng paste
    e.stopPropagation();
    
    const cell = e.target;

    // --- LOGIC M·ªöI: ƒê√°nh d·∫•u √¥ ƒëang ch·ªçn ƒë·ªÉ Paste ---
    // X√≥a class selected c≈©
    if (lastSelectedCell) lastSelectedCell.classList.remove("cell-selected");
    
    // G√°n √¥ m·ªõi
    lastSelectedCell = cell;
    lastSelectedCell.classList.add("cell-selected");
    // ------------------------------------------------

    currentEditedCell = cell;

    const rect = currentEditedCell.getBoundingClientRect();
    shiftMenu.style.left = (rect.left + window.scrollX) + "px";
    shiftMenu.style.top  = (rect.bottom + window.scrollY) + "px";

    shiftMenu.innerHTML = SHIFTS.map(s => `
        <button onmousedown="selectShift('${s.code}','${s.className}')">
            ${s.code ? `<b>${s.code}</b> ‚Äì ` : ""}${s.label}
        </button>
    `).join("");
    shiftMenu.style.display = "block";
}

// Th√™m s·ª± ki·ªán click ra ngo√†i ƒë·ªÉ b·ªè ch·ªçn √¥
document.addEventListener("click", (e) => { 
    shiftMenu.style.display = "none";
    
    // N·∫øu click ra ngo√†i b·∫£ng th√¨ b·ªè ch·ªçn √¥ (ƒë·ªÉ tr√°nh paste nh·∫ßm)
    if (!e.target.closest("#scheduleTable")) {
        if (lastSelectedCell) lastSelectedCell.classList.remove("cell-selected");
        lastSelectedCell = null;
    }
});

function selectShift(code, cls) {
    setShiftOnCell(currentEditedCell, code, cls);
    shiftMenu.style.display = "none";
}

function setShiftOnCell(td, code, className) {
    td.className = "shift"; 
    if (className) td.classList.add(className);
    td.innerText = code || "";
}

document.addEventListener("click", () => { shiftMenu.style.display = "none"; });

/* ===========================================================
    5) TH√äM/X√ìA NH√ÇN VI√äN
=========================================================== */
function openAddEmpPopup() { document.getElementById("addEmpPopup").style.display = "flex"; }
function closeAddEmpPopup() { document.getElementById("addEmpPopup").style.display = "none"; }

async function saveNewEmployee() {
    const code = document.getElementById("empCode").value.trim();
    const name = document.getElementById("empName").value.trim();
    const role = document.getElementById("empRole").value.trim();

    if (!code || !name || !role) { alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin."); return; }

    appendEmployeeRow(code, name, role, 0, 0, 0, 0);

    const obj = { group: currentGroup, code, name, role };
    await fetch(`${SCRIPT_URL}?action=saveEmployee&data=` + encodeURIComponent(JSON.stringify(obj)));

    alert("ƒê√£ th√™m nh√¢n vi√™n!");
    closeAddEmpPopup();
    document.getElementById("empCode").value = "";
    document.getElementById("empName").value = "";
    document.getElementById("empRole").value = "";
}

async function deleteEmployee(btn) {
    if (swapRow1) return; 
    if (!confirm("Ch·∫Øc ch·∫Øn x√≥a nh√¢n vi√™n n√†y?")) return;
    
    const tr = btn.closest("tr");
    const code = tr.querySelector(".emp-code").innerText.trim();
    
    await fetch(`${SCRIPT_URL}?action=deleteEmployee&group=${encodeURIComponent(currentGroup)}&code=${encodeURIComponent(code)}`);
    tr.remove();
    updateStt();
}

/* ===========================================================
    6) T·∫†O TU·∫¶N M·ªöI & XEM TU·∫¶N C≈®
=========================================================== */
function openWeekPopup() { document.getElementById("weekPopup").style.display = "flex"; }
function closeWeekPopup() { document.getElementById("weekPopup").style.display = "none"; }

/* ===========================================================
   C·∫¨P NH·∫¨T H√ÄM T·∫†O TU·∫¶N M·ªöI (T·∫†O XONG T·ª∞ L∆ØU LU√îN)
=========================================================== */
async function applyNewWeek() {
    const val = document.getElementById("weekStart").value;
    if (!val) { alert("Ch·ªçn ng√†y!"); return; }
    
    const d = new Date(val);
    if (d.getDay() !== 1) { alert("Ph·∫£i ch·ªçn Th·ª© 2!"); return; }

    // 1. C·∫≠p nh·∫≠t giao di·ªán ng√†y th√°ng (Header)
    updateWeekHeader(d);

    // 2. T·∫£i d·ªØ li·ªáu c·ªßa tu·∫ßn ƒë√≥ v·ªÅ giao di·ªán tr∆∞·ªõc
    // (N·∫øu tu·∫ßn m·ªõi ch∆∞a c√≥ g√¨, n√≥ s·∫Ω t·∫£i danh s√°ch nh√¢n vi√™n m·∫∑c ƒë·ªãnh v·ªÅ)
    // D√πng 'await' ƒë·ªÉ ƒë·∫£m b·∫£o t·∫£i xong m·ªõi ƒë∆∞·ª£c L∆∞u
    await loadScheduleOfCurrentWeek(val);

    // 3. G·ªçi h√†m L∆∞u l·ªãch ngay l·∫≠p t·ª©c
    // H√†m n√†y s·∫Ω l·∫•y d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã v√† ghi v√†o Sheet 'weeks' v√† 'schedule'
    await saveSchedule();

    closeWeekPopup();
}

async function openOldWeekPopup() {
    if (swapRow1) disableSwap();
    document.getElementById("oldWeekPopup").style.display = "flex";
    const sel = document.getElementById("weekSelect");
    sel.innerHTML = "<option>ƒêang t·∫£i...</option>";

    const res = await fetch(`${SCRIPT_URL}?action=listWeeks&group=${encodeURIComponent(currentGroup)}`);
    const json = await res.json();
    
    sel.innerHTML = "";
    (json.weeks || []).forEach(w => {
        const opt = document.createElement("option");
        opt.value = w.weekStart;
        opt.textContent = `${w.weekRange} (${w.weekStart})`;
        sel.appendChild(opt);
    });
}
function closeOldWeekPopup() { document.getElementById("oldWeekPopup").style.display = "none"; }
function loadSelectedWeek() {
    const ws = document.getElementById("weekSelect").value;
    if (ws) {
        updateWeekHeader(new Date(ws));
        loadScheduleOfCurrentWeek(ws);
        closeOldWeekPopup();
    }
}

/* ===========================================================
    7) L∆ØU L·ªäCH (SAVE)
=========================================================== */
function collectScheduleData() {
    const rows = [...staffTbody.querySelectorAll("tr")];
    return rows.map(row => {
        const code = row.querySelector(".emp-code").innerText.trim();
        const name = row.querySelector(".emp-name").innerText.trim();
        const role = row.querySelector(".emp-role").innerText.trim();
        const shifts = [...row.querySelectorAll(".shift")].map(td => td.innerText.trim());
        return { code, name, role, shifts };
    });
}

async function saveSchedule() {
    if (swapRow1) disableSwap();
    const weekStart = getCurrentWeekStart();
    const payload = {
        group: currentGroup,
        weekStart: weekStart,
        weekRange: weekRangeEl.innerText,
        data: collectScheduleData()
    };

    const btn = document.querySelector(".btn-warning");
    const oldText = btn.innerText;
    btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;

    await fetch(`${SCRIPT_URL}?action=saveSchedule&data=` + encodeURIComponent(JSON.stringify(payload)));

    alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
    btn.innerText = oldText; btn.disabled = false;
    
    loadScheduleOfCurrentWeek(weekStart);
}

/* ===========================================================
    8) T√çNH NƒÇNG: ƒê·∫¢O V·ªä TR√ç (SWAP)
=========================================================== */
function enableSwap() {
    if (swapRow1) { disableSwap(); return; }
    alert("Ch·∫ø ƒë·ªô ƒê·∫¢O V·ªä TR√ç: Ch·ªçn ng∆∞·ªùi th·ª© 1, sau ƒë√≥ ch·ªçn ng∆∞·ªùi th·ª© 2 ƒë·ªÉ ƒë·ªïi ch·ªó.");
    
    [...staffTbody.querySelectorAll("tr")].forEach(tr => {
        tr.onclick = onSwapRowClick;
        tr.style.cursor = 'pointer';
    });
    swapRow1 = "ready"; 
}

function disableSwap() {
    [...staffTbody.querySelectorAll("tr")].forEach(tr => {
        tr.onclick = null;
        tr.style.cursor = 'default';
        tr.classList.remove("swap-selected");
    });
    swapRow1 = null;
}

function onSwapRowClick(e) {
    const tr = e.currentTarget;
    if (swapRow1 === "ready") {
        swapRow1 = tr;
        tr.classList.add("swap-selected");
    } else if (swapRow1 === tr) {
        tr.classList.remove("swap-selected");
        swapRow1 = "ready";
    } else {
        const tr1 = swapRow1;
        const tr2 = tr;
        
        const parent = tr1.parentNode;
        const next1 = tr1.nextSibling;
        const next2 = tr2.nextSibling;
        
        if (next1 === tr2) parent.insertBefore(tr2, tr1);
        else if (next2 === tr1) parent.insertBefore(tr1, tr2);
        else {
            parent.insertBefore(tr1, tr2);
            parent.insertBefore(tr2, next1);
        }
        
        disableSwap();
        updateStt();
    }
}

/* ===========================================================
    9) T√çNH NƒÇNG: BULK LEAVE
=========================================================== */
function openBulkLeavePopup() {
    if (swapRow1) disableSwap();
    const rows = collectScheduleData();
    const listDiv = document.getElementById("bulkEmployeeList");
    listDiv.innerHTML = "";
    
    rows.forEach(emp => {
        const div = document.createElement("div");
        div.innerHTML = `<label><input type="checkbox" value="${emp.code}" checked> ${emp.code} - ${emp.name}</label>`;
        listDiv.appendChild(div);
    });
    document.getElementById("bulkLeavePopup").style.display = "flex";
}
function closeBulkLeavePopup() { document.getElementById("bulkLeavePopup").style.display = "none"; }

function toggleCheckAll(checked) {
    document.querySelectorAll("#bulkEmployeeList input").forEach(cb => cb.checked = checked);
}

async function saveBulkLeave() {
    const type = document.getElementById("bulkLeaveType").value;
    const amount = document.getElementById("bulkLeaveAmount").value;
    const reason = document.getElementById("bulkLeaveReason").value;
    
    const checkboxes = document.querySelectorAll("#bulkEmployeeList input:checked");
    if (checkboxes.length === 0) { alert("Ch∆∞a ch·ªçn nh√¢n vi√™n!"); return; }
    if (!reason) { alert("Ch∆∞a nh·∫≠p l√Ω do!"); return; }

    const payload = [];
    checkboxes.forEach(cb => {
        payload.push({ code: cb.value, type: type, amount: amount, reason: reason });
    });

    await fetch(`${SCRIPT_URL}?action=addBulkLeave&data=` + encodeURIComponent(JSON.stringify(payload)));
    
    alert("ƒê√£ c·∫≠p nh·∫≠t s·ªë d∆∞!");
    closeBulkLeavePopup();
    loadScheduleOfCurrentWeek(getCurrentWeekStart());
}

/* ===========================================================
    10) C√ÅC TI·ªÜN √çCH KH√ÅC
=========================================================== */
function autoAssignShifts() {
    if (swapRow1) disableSwap();
    const rows = [...staffTbody.querySelectorAll("tr")];
    const pattern = ["S","C","HC"];
    rows.forEach((row, rIdx) => {
        const tds = row.querySelectorAll(".shift");
        tds.forEach((td, dIdx) => {
            const code = pattern[(rIdx + dIdx) % 3];
            let cls = "";
            if (code==="S") cls="ca-s"; if (code==="C") cls="ca-c"; if (code==="HC") cls="ca-hc";
            setShiftOnCell(td, code, cls);
        });
    });
}

function exportToExcel() {
    const table = document.getElementById("scheduleTable");
    const wb = XLSX.utils.table_to_book(table, {sheet:"LichTuan"});
    XLSX.writeFile(wb, `Lich_${currentGroup}.xlsx`);
}

function goBack() { window.location.href = "dashboard.html"; }

/* ===========================================================
    11) LOGIC TH√îNG B√ÅO & DUY·ªÜT Y√äU C·∫¶U (M·ªöI)
=========================================================== */
function initNotifications() {
    checkPendingRequests();
    // T·ª± ƒë·ªông check m·ªói 60 gi√¢y
    setInterval(checkPendingRequests, 60000);
}

async function checkPendingRequests() {
    try {
        const res = await fetch(`${SCRIPT_URL}?action=getPendingRequests&group=${encodeURIComponent(currentGroup)}`);
        const json = await res.json();
        if (json.success) {
            const count = json.data.length;
            const badge = document.getElementById("badgeCount");
            badge.innerText = count;
            badge.style.display = count > 0 ? "inline-block" : "none";
            window.pendingReqs = json.data;
        }
    } catch(e) { console.error(e); }
}

function openRequestsPopup() {
    document.getElementById("requestsPopup").style.display = "flex";
    renderRequestsTable();
}
function closeRequestsPopup() {
    document.getElementById("requestsPopup").style.display = "none";
    loadScheduleOfCurrentWeek();
}

function renderRequestsTable() {
    const tbody = document.getElementById("reqTableBody");
    const msg = document.getElementById("noReqMsg");
    tbody.innerHTML = "";
    
    if (!window.pendingReqs || window.pendingReqs.length === 0) {
        msg.style.display = "block";
        return;
    }
    msg.style.display = "none";

    window.pendingReqs.forEach(req => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${req.time}</td>
            <td><b>${req.code}</b><br>${req.name}</td>
            <td><span class="ca-${req.type === 'NB' ? 'nb' : 'p'}" style="padding:2px 5px; border-radius:4px;">${req.type}</span></td>
            <td style="color:#d35400; font-weight:bold;">${req.displayDate}</td>
            <td style="max-width:200px; text-align:left;">${req.reason}</td>
            <td>
                <button class="btn-success" style="padding:4px 8px; font-size:11px;" onclick="processRequest(${req.row}, 'APPROVE', this)">‚úî Duy·ªát</button>
                <button class="btn-danger" style="padding:4px 8px; font-size:11px;" onclick="processRequest(${req.row}, 'REJECT', this)">‚úò H·ªßy</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function processRequest(rowId, action, btn) {
    if (!confirm(action === 'APPROVE' ? "Duy·ªát y√™u c·∫ßu n√†y v√† t·ª± ƒë·ªông x·∫øp l·ªãch?" : "T·ª´ ch·ªëi y√™u c·∫ßu n√†y?")) return;

    const parentTd = btn.parentNode;
    parentTd.innerHTML = "ƒêang x·ª≠ l√Ω...";

    try {
        // CH√ö √ù: ƒê·ªïi t√™n tham s·ªë cu·ªëi c√πng th√†nh 'decision'
        const res = await fetch(`${SCRIPT_URL}?action=handleLeaveAction&group=${encodeURIComponent(currentGroup)}&row=${rowId}&decision=${action}`);
        const json = await res.json();
        
        if (json.success) {
            alert(json.msg);
            await checkPendingRequests();
            renderRequestsTable();
        } else {
            alert("L·ªói: " + json.message);
            renderRequestsTable();
        }
    } catch(e) {
        alert("L·ªói k·∫øt n·ªëi server!");
        renderRequestsTable();
    }
}

/* ===========================================================
   T√çNH NƒÇNG: COPY PASTE T·ª™ EXCEL (M·ªöI)
=========================================================== */
let lastSelectedCell = null;

// L·∫Øng nghe s·ª± ki·ªán Paste to√†n trang
document.addEventListener('paste', function(e) {
    // Ch·ªâ x·ª≠ l√Ω n·∫øu ƒëang c√≥ m·ªôt √¥ l·ªãch ƒë∆∞·ª£c ch·ªçn
    if (!lastSelectedCell) return;
    
    // NgƒÉn h√†nh ƒë·ªông paste m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát
    e.preventDefault();
    
    // L·∫•y d·ªØ li·ªáu t·ª´ clipboard
    const clipboardData = e.clipboardData || window.clipboardData;
    const pastedData = clipboardData.getData('Text');
    
    // G·ªçi h√†m x·ª≠ l√Ω
    processExcelPaste(pastedData);
});

function processExcelPaste(data) {
    if (!lastSelectedCell) return;

    // 1. Ph√¢n t√≠ch d·ªØ li·ªáu Excel (D√≤ng t√°ch b·ªüi \n, C·ªôt t√°ch b·ªüi \t)
    // Lo·∫°i b·ªè d√≤ng tr·ªëng ·ªü cu·ªëi n·∫øu c√≥
    const rows = data.split(/\r\n|\n|\r/).filter(row => row.trim() !== "");
    
    // 2. X√°c ƒë·ªãnh v·ªã tr√≠ b·∫Øt ƒë·∫ßu
    const startRow = lastSelectedCell.closest("tr");
    const startRowIndex = Array.from(staffTbody.children).indexOf(startRow);
    const startColIndex = parseInt(lastSelectedCell.getAttribute("data-day")); // 0-6

    // 3. Duy·ªát qua d·ªØ li·ªáu v√† ƒëi·ªÅn v√†o b·∫£ng
    rows.forEach((rowStr, rIdx) => {
        const cols = rowStr.split('\t');
        
        // T√¨m d√≤ng t∆∞∆°ng ·ª©ng tr√™n b·∫£ng
        const targetRow = staffTbody.children[startRowIndex + rIdx];
        if (!targetRow) return; // H·∫øt d√≤ng b·∫£ng

        cols.forEach((val, cIdx) => {
            // T√¨m √¥ (cell) t∆∞∆°ng ·ª©ng: data-day = startCol + cIdx
            const targetDayIndex = startColIndex + cIdx;
            
            // Ch·ªâ x·ª≠ l√Ω n·∫øu n·∫±m trong ph·∫°m vi 7 ng√†y (0-6)
            if (targetDayIndex <= 6) {
                const targetCell = targetRow.querySelector(`.shift[data-day="${targetDayIndex}"]`);
                
                if (targetCell) {
                    // Chu·∫©n h√≥a d·ªØ li·ªáu (X√≥a kho·∫£ng tr·∫Øng th·ª´a, vi·∫øt hoa ƒë·ªÉ kh·ªõp m√£)
                    let cleanVal = val.trim().toUpperCase();
                    
                    // N·∫øu Excel ƒë·ªÉ tr·ªëng, coi l√† x√≥a ca (ho·∫∑c gi·ªØ nguy√™n t√πy logic)
                    // ·ªû ƒë√¢y ta cho ph√©p paste √¥ tr·ªëng ƒë·ªÉ x√≥a ca
                    if (cleanVal === "") cleanVal = "_"; // Ho·∫∑c "" t√πy logic save c·ªßa b·∫°n

                    // T√¨m class m√†u s·∫Øc t∆∞∆°ng ·ª©ng trong SHIFTS
                    const shiftObj = SHIFTS.find(s => s.code === cleanVal);
                    
                    // N·∫øu m√£ kh√¥ng h·ª£p l·ªá (v√≠ d·ª• nh·∫≠p b·∫≠y), c√≥ th·ªÉ b·ªè qua ho·∫∑c ƒëi·ªÅn text th√¥
                    // ·ªû ƒë√¢y ta ∆∞u ti√™n ƒëi·ªÅn text th√¥ nh∆∞ng kh√¥ng c√≥ m√†u
                    const className = shiftObj ? shiftObj.className : "";
                    
                    // C·∫≠p nh·∫≠t giao di·ªán
                    setShiftOnCell(targetCell, cleanVal, className);
                }
            }
        });
    });
    
    alert(`ƒê√£ d√°n d·ªØ li·ªáu t·ª´ Excel (${rows.length} d√≤ng)! Nh·ªõ b·∫•m L∆ØU.`);
}

/* ===========================================================
   T√çNH NƒÇNG: QU√âT CHU·ªòT NHI·ªÄU √î & X√ìA (MULTI-SELECT DELETE)
=========================================================== */
let isDragging = false;
let startCell = null;

// 1. G·∫Øn s·ª± ki·ªán chu·ªôt v√†o b·∫£ng
const tableGrid = document.getElementById("scheduleTable");

tableGrid.addEventListener("mousedown", function(e) {
    // Ch·ªâ b·∫Øt s·ª± ki·ªán n·∫øu click v√†o √¥ l·ªãch (.shift)
    const cell = e.target.closest(".shift");
    if (!cell) {
        clearSelection(); // Click ra ngo√†i th√¨ b·ªè ch·ªçn
        return;
    }

    // N·∫øu click chu·ªôt tr√°i
    if (e.button === 0) {
        isDragging = true;
        startCell = cell;
        clearSelection(); // X√≥a v√πng ch·ªçn c≈©
        toggleCellSelection(cell, true); // Ch·ªçn √¥ b·∫Øt ƒë·∫ßu
        document.body.classList.add("noselect"); // Ch·∫∑n b√¥i ƒëen vƒÉn b·∫£n
    }
});

tableGrid.addEventListener("mouseover", function(e) {
    if (!isDragging) return;
    
    const currentCell = e.target.closest(".shift");
    if (currentCell && startCell) {
        selectRange(startCell, currentCell);
    }
});

document.addEventListener("mouseup", function() {
    isDragging = false;
    document.body.classList.remove("noselect");
});

// 2. H√†m t√≠nh to√°n v√πng ch·ªçn (H√¨nh ch·ªØ nh·∫≠t)
function selectRange(start, end) {
    clearSelection();

    // L·∫•y t·ªça ƒë·ªô (Row Index v√† Cell Index trong row)
    const startRow = start.closest("tr").rowIndex;
    const endRow = end.closest("tr").rowIndex;
    
    // Index c·ªßa √¥ shift t√≠nh theo data-day (0-6)
    const startCol = parseInt(start.getAttribute("data-day"));
    const endCol = parseInt(end.getAttribute("data-day"));

    // T√¨m gi·ªõi h·∫°n h√¨nh ch·ªØ nh·∫≠t (Min/Max)
    const minRow = Math.min(startRow, endRow);
    const maxRow = Math.max(startRow, endRow);
    const minCol = Math.min(startCol, endCol);
    const maxCol = Math.max(startCol, endCol);

    // Duy·ªát qua c√°c d√≤ng trong ph·∫°m vi
    const rows = tableGrid.rows;
    for (let r = minRow; r <= maxRow; r++) {
        const row = rows[r];
        // T√¨m c√°c √¥ .shift trong d√≤ng n√†y
        // L∆∞u √Ω: C·∫•u tr√∫c HTML c·ªßa b·∫°n c√≥ c√°c √¥ stt, code, name... tr∆∞·ªõc
        // N√™n ta querySelectorAll b√™n trong row ƒë·ªÉ an to√†n
        const cells = row.querySelectorAll(".shift");
        
        cells.forEach(cell => {
            const colIdx = parseInt(cell.getAttribute("data-day"));
            if (colIdx >= minCol && colIdx <= maxCol) {
                toggleCellSelection(cell, true);
            }
        });
    }
}

// Helper: B·∫≠t/T·∫Øt class ch·ªçn
function toggleCellSelection(cell, isSelected) {
    if (isSelected) cell.classList.add("cell-multi-selected");
    else cell.classList.remove("cell-multi-selected");
}

// Helper: X√≥a to√†n b·ªô v√πng ch·ªçn
function clearSelection() {
    const selected = document.querySelectorAll(".cell-multi-selected");
    selected.forEach(cell => toggleCellSelection(cell, false));
}

// 3. G·∫Øn s·ª± ki·ªán ph√≠m DELETE / BACKSPACE
document.addEventListener("keydown", function(e) {
    // N·∫øu ƒëang nh·∫≠p li·ªáu trong √¥ input/textarea th√¨ kh√¥ng x√≥a l·ªãch
    if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;

    if (e.key === "Delete" || e.key === "Backspace") {
        const selectedCells = document.querySelectorAll(".cell-multi-selected");
        
        if (selectedCells.length > 0) {
            e.preventDefault(); // NgƒÉn backspace quay l·∫°i trang
            
            if (confirm(`B·∫°n mu·ªën x√≥a ${selectedCells.length} √¥ ƒë√£ ch·ªçn?`)) {
                selectedCells.forEach(cell => {
                    // ƒê·∫∑t v·ªÅ "_" theo logic chu·∫©n h√≥a c·ªßa b·∫°n
                    setShiftOnCell(cell, "_", ""); 
                });
                // clearSelection(); // C√≥ th·ªÉ gi·ªØ v√πng ch·ªçn ho·∫∑c x√≥a t√πy th√≠ch
            }
        }
    }
});

/* ===========================================================
   T√çNH NƒÇNG: XU·∫§T EXCEL THEO KHO·∫¢NG TH·ªúI GIAN
=========================================================== */
function openExportRangePopup() {
    document.getElementById("exportRangePopup").style.display = "flex";
    // M·∫∑c ƒë·ªãnh ch·ªçn ng√†y 1 ƒë·∫øn cu·ªëi th√°ng hi·ªán t·∫°i
    const date = new Date();
    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
    const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    
    // Format yyyy-MM-dd ƒë·ªÉ g√°n v√†o input type=date
    const toInputStr = (d) => d.toISOString().split('T')[0];
    
    if(!document.getElementById("expFrom").value) document.getElementById("expFrom").value = toInputStr(firstDay);
    if(!document.getElementById("expTo").value) document.getElementById("expTo").value = toInputStr(lastDay);
}

async function doExportRange() {
    const fromD = document.getElementById("expFrom").value;
    const toD = document.getElementById("expTo").value;
    
    if (!fromD || !toD) return alert("Vui l√≤ng ch·ªçn ng√†y!");
    if (fromD > toD) return alert("Ng√†y b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ng√†y k·∫øt th√∫c!");

    const btn = document.querySelector("#exportRangePopup .btn-success");
    const oldText = btn.innerText;
    btn.innerText = "ƒêang x·ª≠ l√Ω..."; btn.disabled = true;

    try {
        const res = await fetch(`${SCRIPT_URL}?action=exportScheduleRange&group=${encodeURIComponent(currentGroup)}&fromDate=${fromD}&toDate=${toD}`);
        const json = await res.json();

        if (json.success) {
            // T·∫°o Workbook m·ªõi
            const wb = XLSX.utils.book_new();
            
            // G·ªôp Header v√† Data th√†nh m·ªôt m·∫£ng l·ªõn (Array of Arrays)
            const wsData = [json.headers, ...json.data];
            
            // T·∫°o Sheet t·ª´ m·∫£ng
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // --- T√ôY CH·ªàNH STYLE (T√¥ m√†u) ---
            // Duy·ªát qua c√°c √¥ ƒë·ªÉ t√¥ m√†u n·ªÅn d·ª±a v√†o m√£ ca
            // (Ph·∫ßn n√†y d√πng th∆∞ vi·ªán xlsx-js-style)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                    const cell = ws[cellAddress];
                    
                    if (!cell) continue;

                    // Style cho Header (D√≤ng 0)
                    if (R === 0) {
                        cell.s = { font: { bold: true }, fill: { fgColor: { rgb: "EEEEEE" } }, border: { bottom: { style: "thin" } } };
                    } 
                    // Style cho Data (C√°c d√≤ng sau)
                    else {
                        // C·ªôt 0,1,2 l√† th√¥ng tin nh√¢n vi√™n, C > 2 l√† l·ªãch
                        if (C > 2) {
                            const val = String(cell.v).trim();
                            // Map m√†u t∆∞∆°ng ·ª©ng (L·∫•y t·ª´ bi·∫øn COLOR_MAP c√≥ s·∫µn trong code c≈©)
                            // L∆∞u √Ω: COLOR_MAP trong code c≈© key l√† class (ca-s), ta c·∫ßn map t·ª´ Code (S)
                            // Ta l√†m map nhanh ·ªü ƒë√¢y:
                            let color = "FFFFFF"; // M·∫∑c ƒë·ªãnh tr·∫Øng
                            if (val === "S" || val === "S1") color = "FFF2AC";
                            else if (val === "C") color = "B7FF9D";
                            else if (val === "HC") color = "FFB3B3";
                            else if (val === "NB" || val.includes("NB")) color = "FF7A7A";
                            else if (val === "P" || val.includes("P")) color = "FF6666";
                            
                            // G√°n m√†u n·ªÅn
                            if (color !== "FFFFFF") {
                                cell.s = { fill: { fgColor: { rgb: color } }, border: { top: {style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} } };
                            } else {
                                // Vi·ªÅn cho √¥ th∆∞·ªùng
                                cell.s = { border: { top: {style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} } };
                            }
                        }
                    }
                }
            }

            // Ch·ªânh ƒë·ªô r·ªông c·ªôt
            const wscols = [{wch:10}, {wch:20}, {wch:15}]; // 3 c·ªôt ƒë·∫ßu
            // C√°c c·ªôt ng√†y cho nh·ªè l·∫°i
            for(let k=3; k<json.headers.length; k++) wscols.push({wch:5});
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, "BaoCaoLich");
            XLSX.writeFile(wb, `Lich_${fromD}_${toD}.xlsx`);
            
            document.getElementById("exportRangePopup").style.display = "none";
        }
    } catch(e) {
        console.error(e);
        alert("L·ªói khi xu·∫•t file!");
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
}
</script>
</body>
</html>