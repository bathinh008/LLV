<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>L·ªãch l√†m vi·ªác tu·∫ßn</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>

<style>
/* ================= CSS CHUNG ================= */
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 1400px;
    margin: auto;
    background: #f4f6f9;
}
h1 { text-align: center; margin-bottom: 5px; }
.header-week { text-align: center; margin-bottom: 10px; font-size: 18px; }
.group-label { text-align:center; margin-bottom:15px; font-style:italic; }

/* Control Bar */
.control-bar {
    display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;
    justify-content: center;
}
button {
    padding:8px 12px;
    border-radius:6px;
    border:none;
    cursor:pointer;
    font-size:13px;
    transition: 0.2s;
}
button:hover { opacity: 0.9; transform: translateY(-1px); }
.btn-primary { background:#3498db; color:#fff; }
.btn-success { background:#27ae60; color:#fff; }
.btn-warning { background:#f39c12; color:#fff; }
.btn-outline { background:#fff; border:1px solid #7f8c8d; color:#2c3e50; }
.btn-danger { background:#e74c3c; color:#fff; }

/* Table Styles */
table {
    width:100%; border-collapse:collapse; background:#fff; font-size:13px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
th, td {
    border:1px solid #ddd;
    padding:6px 4px;
    text-align:center;
    vertical-align: middle;
}
thead th { background:#f2f2f2; color: #333; font-weight: bold; }

/* M√†u s·∫Øc c√°c c·ªôt s·ªë d∆∞ (Header) */
.col-p-old { background-color: #ffe6e6 !important; color: #c0392b; } 
.col-p-new { background-color: #ffcccc !important; color: #c0392b; } 
.col-b-old { background-color: #e6f2ff !important; color: #2980b9; } 
.col-b-new { background-color: #cce6ff !important; color: #2980b9; } 

/* Class Ca k√≠p */
.ca-s  { background:#fff2ac; }
.ca-c  { background:#b7ff9d; }
.ca-hc { background:#ffb3b3; }
.ca-nc { background:#f6ff82; }
.ca-p  { background:#ff6666; color: white; }
.ca-nb { background:#ff7a7a; color: white; }
.ca-ct { background:#9dd3ff; }

.shift { min-width:40px; cursor:pointer; }
.emp-code, .emp-name, .emp-role { font-weight: 500; }

/* Popup */
.popup-bg {
    display:none; position:fixed; left:0; top:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.5);
    align-items:center; justify-content:center;
    z-index:9999;
}
.popup-box {
    background:#fff; padding:20px;
    border-radius:10px; width:350px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.popup-box h3 { margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;}
.popup-box input, .popup-box select {
    width:100%; padding:8px; margin-bottom:10px;
    border-radius:6px; border:1px solid #ccc; box-sizing: border-box;
}

/* Menu ch·ªçn ca */
#shiftMenu {
    position:absolute;
    background:#fff;
    border:1px solid #bdc3c7;
    border-radius:6px;
    box-shadow:0 2px 8px rgba(0,0,0,0.2);
    padding:4px;
    display:none;
    z-index:999;
    font-size:13px;
}
#shiftMenu button {
    display:block; width:100%; text-align:left;
    border:none; background:transparent; padding:6px 10px; cursor:pointer;
}
#shiftMenu button:hover { background:#ecf0f1; }

/* CSS Swap */
.swap-selected {
    border: 2px solid #3498db !important;
    background: #e9f2fb !important;
}
</style>
</head>
<body>

<h1>L·ªäCH L√ÄM VI·ªÜC</h1>
<div class="header-week" id="weekRange"></div>
<div class="group-label" id="groupLabel"></div>

<div class="control-bar">
    <button class="btn-primary" style="position:relative;" onclick="openRequestsPopup()">
        üîî Y√™u c·∫ßu <span id="badgeCount" style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:11px; position:absolute; top:-5px; right:-5px; display:none;">0</span>
    </button>

    <button class="btn-primary" onclick="openAddEmpPopup()">‚ûï Th√™m nh√¢n vi√™n</button>
    <button class="btn-primary" onclick="openBulkLeavePopup()">‚ûï Th√™m Ph√©p/B√π</button>
    <button class="btn-success" onclick="autoAssignShifts()">Chia ca t·ª± ƒë·ªông</button>
    <button class="btn-outline" onclick="enableSwap()">‚áå ƒê·∫£o v·ªã tr√≠</button> 
    <button class="btn-outline" onclick="openWeekPopup()">T·∫°o tu·∫ßn m·ªõi</button>
    <button class="btn-outline" onclick="openOldWeekPopup()">Xem tu·∫ßn ƒë√£ l∆∞u</button>
    <button class="btn-warning" onclick="saveSchedule()">üíæ L∆∞u l·ªãch tu·∫ßn</button>
    <button class="btn-warning" onclick="exportToExcel()">üìä Xu·∫•t Excel</button>
    <button class="btn-outline" onclick="goBack()">‚Üê V·ªÅ trang ch·ªß</button>
</div>

<table id="scheduleTable">
    <thead>
        <tr>
            <th rowspan="2" style="width: 30px;">STT</th>
            <th rowspan="2" style="width: 60px;">M√É NV</th>
            <th rowspan="2" style="width: 150px;">H·ªå T√äN</th>
            <th rowspan="2" style="width: 80px;">CH·ª®C V·ª§</th>
            
            <th>T2</th><th>T3</th><th>T4</th><th>T5</th><th>T6</th><th>T7</th><th>CN</th>
            
            <th rowspan="2" class="col-p-old" style="display:none;">PH√âP C≈®</th>
            <th rowspan="2" class="col-p-new">PH√âP M·ªöI</th>
            <th rowspan="2" class="col-b-old" style="display:none;">B√ô C≈®</th>
            <th rowspan="2" class="col-b-new">B√ô M·ªöI</th>
            
            <th rowspan="2" style="background-color: #fff3cd; color: #d35400;">T·ªîNG</th>

            <th rowspan="2" style="width: 40px;">X√ìA</th>
        </tr>
        <tr id="headerDatesRow"></tr>
    </thead>
    <tbody id="staffRows"></tbody>
</table>

<div id="shiftMenu"></div>

<div id="addEmpPopup" class="popup-bg">
    <div class="popup-box">
        <h3>Th√™m nh√¢n vi√™n</h3>
        <input id="empCode" placeholder="M√£ nh√¢n vi√™n (VD: NV01)">
        <input id="empName" placeholder="H·ªç t√™n nh√¢n vi√™n">
        <input id="empRole" placeholder="Ch·ª©c v·ª•">
        <button class="btn-primary" onclick="saveNewEmployee()">L∆∞u</button>
        <button class="btn-danger" onclick="closeAddEmpPopup()">H·ªßy</button>
    </div>
</div>

<div id="weekPopup" class="popup-bg">
    <div class="popup-box">
        <h3>Ch·ªçn ng√†y b·∫Øt ƒë·∫ßu (Th·ª© 2)</h3>
        <input id="weekStart" type="date">
        <button class="btn-primary" onclick="applyNewWeek()">T·∫°o</button>
        <button class="btn-danger" onclick="closeWeekPopup()">ƒê√≥ng</button>
    </div>
</div>

<div id="oldWeekPopup" class="popup-bg">
    <div class="popup-box">
        <h3>Ch·ªçn tu·∫ßn ƒë√£ l∆∞u</h3>
        <select id="weekSelect"></select>
        <button class="btn-primary" onclick="loadSelectedWeek()">T·∫£i tu·∫ßn</button>
        <button class="btn-danger" onclick="closeOldWeekPopup()">ƒê√≥ng</button>
    </div>
</div>

<div id="bulkLeavePopup" class="popup-bg">
    <div class="popup-box" style="width: 500px;">
        <h3>‚ûï Th√™m Ph√©p / B√π</h3>
        <div style="display:flex; gap:10px;">
            <select id="bulkLeaveType" style="flex:1;">
                <option value="NB">Ng√†y B√π (NB)</option>
                <option value="PN">Ph√©p NƒÉm (PN)</option>
            </select>
            <input id="bulkLeaveAmount" type="number" step="0.5" min="0.5" value="1" style="width: 100px;" title="S·ªë l∆∞·ª£ng">
        </div>
        <input id="bulkLeaveReason" placeholder="L√Ω do (V√≠ d·ª•: Tr·ª±c l·ªÖ, TƒÉng ca...)" style="margin-top: 10px;">
        <div style="margin: 10px 0; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px;">
            <input type="checkbox" id="checkAllBulk" checked onclick="toggleCheckAll(this.checked)"> Ch·ªçn t·∫•t c·∫£
        </div>
        <div id="bulkEmployeeList" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background: #fafafa; border-radius: 4px;"></div>
        <div style="margin-top: 15px; text-align: right;">
            <button class="btn-danger" onclick="closeBulkLeavePopup()">H·ªßy</button>
            <button class="btn-primary" onclick="saveBulkLeave()">X√°c nh·∫≠n</button>
        </div>
    </div>
</div>

<div id="requestsPopup" class="popup-bg">
    <div class="popup-box" style="width: 700px; max-width:95%;">
        <h3>üîî Danh S√°ch Y√™u C·∫ßu Ngh·ªâ</h3>
        <div id="reqListContainer" style="max-height: 400px; overflow-y: auto;">
            <table style="width:100%; font-size:13px;">
                <thead>
                    <tr>
                        <th>Th·ªùi gian</th>
                        <th>NV</th>
                        <th>Lo·∫°i</th>
                        <th>Ng√†y ngh·ªâ</th>
                        <th>L√Ω do</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="reqTableBody"></tbody>
            </table>
            <p id="noReqMsg" style="text-align:center; color:#888; display:none;">Kh√¥ng c√≥ y√™u c·∫ßu n√†o.</p>
        </div>
        <div style="text-align:right; margin-top:15px;">
            <button class="btn-outline" onclick="closeRequestsPopup()">ƒê√≥ng</button>
        </div>
    </div>
</div>

<script>
/* ===========================================================
    CONFIG + KH·ªûI T·∫†O
=========================================================== */
const SCRIPT_URL = localStorage.getItem("SCRIPT_URL");
const params = new URLSearchParams(window.location.search);
const currentGroup = params.get("group") || localStorage.getItem("group") || "";

document.getElementById("groupLabel").innerText = "Nh√≥m: " + currentGroup;

const staffTbody     = document.getElementById("staffRows");
const headerDatesRow = document.getElementById("headerDatesRow");
const weekRangeEl    = document.getElementById("weekRange");

// Danh s√°ch m√£ ca (ƒê√£ c√≥ P/2 v√† NB/2)
const SHIFTS = [
  { code:"",   label:"(Tr·ªëng)",        className:""      },
  { code:"S",  label:"Ca s√°ng (S)",    className:"ca-s"  },
  { code:"S1", label:"Ca S1",          className:"ca-s"  },
  { code:"C",  label:"Ca chi·ªÅu (C)",   className:"ca-c"  },
  { code:"HC", label:"H√†nh ch√≠nh",     className:"ca-hc" },
  { code:"NB", label:"Ngh·ªâ b√π (1.0)",  className:"ca-nb" },
  { code:"NB/2", label:"Ngh·ªâ b√π (0.5)",className:"ca-nb" },
  { code:"NC", label:"Ngh·ªâ CN",        className:"ca-nc" },
  { code:"P",  label:"Ngh·ªâ ph√©p (1.0)",className:"ca-p"  },
  { code:"P/2", label:"Ngh·ªâ ph√©p (0.5)",className:"ca-p"  },
  { code:"CT", label:"C√¥ng t√°c",       className:"ca-ct" }
];

let currentEditedCell = null;
const shiftMenu = document.getElementById("shiftMenu");
let swapRow1 = null;

/* ===========================================================
    INIT
=========================================================== */
document.addEventListener("DOMContentLoaded", () => {
    if (!SCRIPT_URL) {
        alert("Ch∆∞a ƒëƒÉng nh·∫≠p! Vui l√≤ng quay l·∫°i trang Login.");
        window.location.href = "index.html"; 
        return;
    }
    loadLastSavedWeek();
    
    // KH·ªûI T·∫†O CHECK TH√îNG B√ÅO (M·ªöI)
    initNotifications();
});

/* ===========================================================
    1) T·∫†O HEADER NG√ÄY
=========================================================== */
function generateDates(startDate) {
    const arr = [];
    const d = new Date(startDate);
    for (let i = 0; i < 7; i++) {
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        arr.push(`${dd}/${mm}`);
        d.setDate(d.getDate()+1);
    }
    return arr;
}

function initDefaultWeek() {
    const today = new Date();
    const monday = new Date(today);
    monday.setDate(today.getDate() - ((today.getDay() + 6) % 7)); 
    updateWeekHeader(monday);
}

function updateWeekHeader(start) {
    const dates = generateDates(start);
    headerDatesRow.innerHTML = dates.map(d => `<th>${d}</th>`).join("");

    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    const d1 = `${String(start.getDate()).padStart(2,"0")}/${String(start.getMonth()+1).padStart(2,"0")}`;
    const d2 = `${String(end.getDate()).padStart(2,"0")}/${String(end.getMonth()+1).padStart(2,"0")}/${end.getFullYear()}`;
    weekRangeEl.innerText = `Tu·∫ßn t·ª´ ${d1} ƒë·∫øn ${d2}`;
}

function getCurrentWeekStart() {
    const firstTh = headerDatesRow.querySelector("th");
    if (!firstTh) return null;
    const [dd, mm] = firstTh.innerText.split("/");
    const yearMatch = weekRangeEl.innerText.match(/(\d{4})\s*$/);
    const year = yearMatch ? yearMatch[1] : new Date().getFullYear();
    return `${year}-${mm}-${dd}`;
}

/* ===========================================================
    2) H√ÄNG NH√ÇN VI√äN & HI·ªÇN TH·ªä C·ªòT ƒê·ªòNG
=========================================================== */
function appendEmployeeRow(code, name, role, pOld, pNew, bOld, bNew) {
    const tr = document.createElement("tr");
    
    // T√çNH T·ªîNG S·ªê D∆Ø
    const valPOld = Number(pOld) || 0;
    const valPNew = Number(pNew) || 0;
    const valBOld = Number(bOld) || 0;
    const valBNew = Number(bNew) || 0;
    const totalRemaining = valPOld + valPNew + valBOld + valBNew;

    // ƒê√£ x√≥a contenteditable ƒë·ªÉ ReadOnly
    tr.innerHTML = `
        <td class="stt"></td>
        <td class="emp-code">${code || ""}</td>
        <td class="emp-name">${name || ""}</td>
        <td class="emp-role">${role || ""}</td>
        ${[0,1,2,3,4,5,6].map(i => `<td class="shift" data-day="${i}"></td>`).join("")}
        
        <td class="col-p-old" style="display:none; font-weight:bold; color:#c0392b;">${valPOld}</td>
        <td class="col-p-new" style="font-weight:bold; color:#c0392b;">${valPNew}</td>
        <td class="col-b-old" style="display:none; font-weight:bold; color:#2980b9;">${valBOld}</td>
        <td class="col-b-new" style="font-weight:bold; color:#2980b9;">${valBNew}</td>
        
        <td style="font-weight:bold; color:#d35400; background-color: #fff3cd; text-align:center;">
            ${totalRemaining}
        </td>
        
        <td><button class="btn-danger" onclick="deleteEmployee(this)">X</button></td>
    `;
    staffTbody.appendChild(tr);

    tr.querySelectorAll(".shift").forEach(td => {
        td.addEventListener("click", onShiftCellClick);
    });
    
    if (swapRow1) {
        tr.onclick = onSwapRowClick;
        tr.style.cursor = 'pointer';
    }
    updateStt();
}

function updateStt() {
    [...staffTbody.querySelectorAll(".stt")].forEach((td, i) => td.innerText = i + 1);
}

/* ===========================================================
    3) LOAD DATA T·ª™ SERVER
=========================================================== */
async function loadLastSavedWeek() {
    const res = await fetch(`${SCRIPT_URL}?action=getLastSavedWeek&group=${encodeURIComponent(currentGroup)}`);
    let json;
    try { json = await res.json(); } catch(e) { console.error(e); }

    if (!json || !json.weekStart) {
        initDefaultWeek(); 
        loadScheduleOfCurrentWeek(); 
        return;
    }

    const start = new Date(json.weekStart);
    updateWeekHeader(start);
    if (json.weekRange) weekRangeEl.innerText = json.weekRange;
    loadScheduleOfCurrentWeek(json.weekStart);
}

async function loadScheduleOfCurrentWeek(explicitWeekStart) {
    const weekStart = explicitWeekStart || getCurrentWeekStart();
    if (!weekStart) return;

    const res = await fetch(
        `${SCRIPT_URL}?action=getSchedule`
        + `&group=${encodeURIComponent(currentGroup)}`
        + `&weekStart=${encodeURIComponent(weekStart)}`
    );

    const text = await res.text();
    let json;
    try { json = JSON.parse(text); }
    catch(err) {
        console.error("JSON ERROR:", err, text);
        alert("L·ªói d·ªØ li·ªáu t·ª´ server.");
        return;
    }

    if (json.weekRange) weekRangeEl.innerText = json.weekRange;

    staffTbody.innerHTML = "";
    
    // ·∫®n hi·ªán c·ªôt c≈©
    const prevYear = json.prevYear;
    const curYear = json.currentYear;
    const data = json.data || [];

    let showPOld = false;
    let showBOld = false;

    data.forEach(rec => {
        if (Number(rec.phep_old) > 0) showPOld = true;
        if (Number(rec.bu_old) > 0) showBOld = true;
    });

    document.querySelector(".col-p-old").innerText = `PH√âP ${prevYear}`;
    document.querySelector(".col-p-new").innerText = `PH√âP ${curYear}`;
    document.querySelector(".col-b-old").innerText = `B√ô ${prevYear}`;
    document.querySelector(".col-b-new").innerText = `B√ô ${curYear}`;

    const setDisplay = (cls, isShow) => {
        document.querySelectorAll(cls).forEach(el => el.style.display = isShow ? "table-cell" : "none");
    };

    data.forEach(rec => {
        appendEmployeeRow(rec.code, rec.name, rec.role, rec.phep_old, rec.phep_new, rec.bu_old, rec.bu_new);
        
        const tr = staffTbody.lastElementChild;
        const tds = tr.querySelectorAll(".shift");
        const shiftsArr = (rec.shifts && rec.shifts.length === 7) ? rec.shifts : ["","","","","","",""];

        shiftsArr.forEach((code, idx) => {
            if (!tds[idx]) return;
            const shiftObj = SHIFTS.find(s => s.code === code);
            const cls = shiftObj ? shiftObj.className : "";
            setShiftOnCell(tds[idx], code, cls);
        });
    });

    setDisplay(".col-p-old", showPOld);
    setDisplay(".col-b-old", showBOld);
    setDisplay(".col-p-new", true); 
    setDisplay(".col-b-new", true);
    
    updateStt();
}

/* ===========================================================
    4) MENU CH·ªåN CA
=========================================================== */
function onShiftCellClick(e) {
    if (swapRow1) return; 
    e.stopPropagation();
    currentEditedCell = e.target;

    const rect = currentEditedCell.getBoundingClientRect();
    shiftMenu.style.left = (rect.left + window.scrollX) + "px";
    shiftMenu.style.top  = (rect.bottom + window.scrollY) + "px";

    shiftMenu.innerHTML = SHIFTS.map(s => `
        <button onmousedown="selectShift('${s.code}','${s.className}')">
            ${s.code ? `<b>${s.code}</b> ‚Äì ` : ""}${s.label}
        </button>
    `).join("");
    shiftMenu.style.display = "block";
}

function selectShift(code, cls) {
    setShiftOnCell(currentEditedCell, code, cls);
    shiftMenu.style.display = "none";
}

function setShiftOnCell(td, code, className) {
    td.className = "shift"; 
    if (className) td.classList.add(className);
    td.innerText = code || "";
}

document.addEventListener("click", () => { shiftMenu.style.display = "none"; });

/* ===========================================================
    5) TH√äM/X√ìA NH√ÇN VI√äN
=========================================================== */
function openAddEmpPopup() { document.getElementById("addEmpPopup").style.display = "flex"; }
function closeAddEmpPopup() { document.getElementById("addEmpPopup").style.display = "none"; }

async function saveNewEmployee() {
    const code = document.getElementById("empCode").value.trim();
    const name = document.getElementById("empName").value.trim();
    const role = document.getElementById("empRole").value.trim();

    if (!code || !name || !role) { alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin."); return; }

    appendEmployeeRow(code, name, role, 0, 0, 0, 0);

    const obj = { group: currentGroup, code, name, role };
    await fetch(`${SCRIPT_URL}?action=saveEmployee&data=` + encodeURIComponent(JSON.stringify(obj)));

    alert("ƒê√£ th√™m nh√¢n vi√™n!");
    closeAddEmpPopup();
    document.getElementById("empCode").value = "";
    document.getElementById("empName").value = "";
    document.getElementById("empRole").value = "";
}

async function deleteEmployee(btn) {
    if (swapRow1) return; 
    if (!confirm("Ch·∫Øc ch·∫Øn x√≥a nh√¢n vi√™n n√†y?")) return;
    
    const tr = btn.closest("tr");
    const code = tr.querySelector(".emp-code").innerText.trim();
    
    await fetch(`${SCRIPT_URL}?action=deleteEmployee&group=${encodeURIComponent(currentGroup)}&code=${encodeURIComponent(code)}`);
    tr.remove();
    updateStt();
}

/* ===========================================================
    6) T·∫†O TU·∫¶N M·ªöI & XEM TU·∫¶N C≈®
=========================================================== */
function openWeekPopup() { document.getElementById("weekPopup").style.display = "flex"; }
function closeWeekPopup() { document.getElementById("weekPopup").style.display = "none"; }

/* ===========================================================
   C·∫¨P NH·∫¨T H√ÄM T·∫†O TU·∫¶N M·ªöI (T·∫†O XONG T·ª∞ L∆ØU LU√îN)
=========================================================== */
async function applyNewWeek() {
    const val = document.getElementById("weekStart").value;
    if (!val) { alert("Ch·ªçn ng√†y!"); return; }
    
    const d = new Date(val);
    if (d.getDay() !== 1) { alert("Ph·∫£i ch·ªçn Th·ª© 2!"); return; }

    // 1. C·∫≠p nh·∫≠t giao di·ªán ng√†y th√°ng (Header)
    updateWeekHeader(d);

    // 2. T·∫£i d·ªØ li·ªáu c·ªßa tu·∫ßn ƒë√≥ v·ªÅ giao di·ªán tr∆∞·ªõc
    // (N·∫øu tu·∫ßn m·ªõi ch∆∞a c√≥ g√¨, n√≥ s·∫Ω t·∫£i danh s√°ch nh√¢n vi√™n m·∫∑c ƒë·ªãnh v·ªÅ)
    // D√πng 'await' ƒë·ªÉ ƒë·∫£m b·∫£o t·∫£i xong m·ªõi ƒë∆∞·ª£c L∆∞u
    await loadScheduleOfCurrentWeek(val);

    // 3. G·ªçi h√†m L∆∞u l·ªãch ngay l·∫≠p t·ª©c
    // H√†m n√†y s·∫Ω l·∫•y d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã v√† ghi v√†o Sheet 'weeks' v√† 'schedule'
    await saveSchedule();

    closeWeekPopup();
}

async function openOldWeekPopup() {
    if (swapRow1) disableSwap();
    document.getElementById("oldWeekPopup").style.display = "flex";
    const sel = document.getElementById("weekSelect");
    sel.innerHTML = "<option>ƒêang t·∫£i...</option>";

    const res = await fetch(`${SCRIPT_URL}?action=listWeeks&group=${encodeURIComponent(currentGroup)}`);
    const json = await res.json();
    
    sel.innerHTML = "";
    (json.weeks || []).forEach(w => {
        const opt = document.createElement("option");
        opt.value = w.weekStart;
        opt.textContent = `${w.weekRange} (${w.weekStart})`;
        sel.appendChild(opt);
    });
}
function closeOldWeekPopup() { document.getElementById("oldWeekPopup").style.display = "none"; }
function loadSelectedWeek() {
    const ws = document.getElementById("weekSelect").value;
    if (ws) {
        updateWeekHeader(new Date(ws));
        loadScheduleOfCurrentWeek(ws);
        closeOldWeekPopup();
    }
}

/* ===========================================================
    7) L∆ØU L·ªäCH (SAVE)
=========================================================== */
function collectScheduleData() {
    const rows = [...staffTbody.querySelectorAll("tr")];
    return rows.map(row => {
        const code = row.querySelector(".emp-code").innerText.trim();
        const name = row.querySelector(".emp-name").innerText.trim();
        const role = row.querySelector(".emp-role").innerText.trim();
        const shifts = [...row.querySelectorAll(".shift")].map(td => td.innerText.trim());
        return { code, name, role, shifts };
    });
}

async function saveSchedule() {
    if (swapRow1) disableSwap();
    const weekStart = getCurrentWeekStart();
    const payload = {
        group: currentGroup,
        weekStart: weekStart,
        weekRange: weekRangeEl.innerText,
        data: collectScheduleData()
    };

    const btn = document.querySelector(".btn-warning");
    const oldText = btn.innerText;
    btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;

    await fetch(`${SCRIPT_URL}?action=saveSchedule&data=` + encodeURIComponent(JSON.stringify(payload)));

    alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
    btn.innerText = oldText; btn.disabled = false;
    
    loadScheduleOfCurrentWeek(weekStart);
}

/* ===========================================================
    8) T√çNH NƒÇNG: ƒê·∫¢O V·ªä TR√ç (SWAP)
=========================================================== */
function enableSwap() {
    if (swapRow1) { disableSwap(); return; }
    alert("Ch·∫ø ƒë·ªô ƒê·∫¢O V·ªä TR√ç: Ch·ªçn ng∆∞·ªùi th·ª© 1, sau ƒë√≥ ch·ªçn ng∆∞·ªùi th·ª© 2 ƒë·ªÉ ƒë·ªïi ch·ªó.");
    
    [...staffTbody.querySelectorAll("tr")].forEach(tr => {
        tr.onclick = onSwapRowClick;
        tr.style.cursor = 'pointer';
    });
    swapRow1 = "ready"; 
}

function disableSwap() {
    [...staffTbody.querySelectorAll("tr")].forEach(tr => {
        tr.onclick = null;
        tr.style.cursor = 'default';
        tr.classList.remove("swap-selected");
    });
    swapRow1 = null;
}

function onSwapRowClick(e) {
    const tr = e.currentTarget;
    if (swapRow1 === "ready") {
        swapRow1 = tr;
        tr.classList.add("swap-selected");
    } else if (swapRow1 === tr) {
        tr.classList.remove("swap-selected");
        swapRow1 = "ready";
    } else {
        const tr1 = swapRow1;
        const tr2 = tr;
        
        const parent = tr1.parentNode;
        const next1 = tr1.nextSibling;
        const next2 = tr2.nextSibling;
        
        if (next1 === tr2) parent.insertBefore(tr2, tr1);
        else if (next2 === tr1) parent.insertBefore(tr1, tr2);
        else {
            parent.insertBefore(tr1, tr2);
            parent.insertBefore(tr2, next1);
        }
        
        disableSwap();
        updateStt();
    }
}

/* ===========================================================
    9) T√çNH NƒÇNG: BULK LEAVE
=========================================================== */
function openBulkLeavePopup() {
    if (swapRow1) disableSwap();
    const rows = collectScheduleData();
    const listDiv = document.getElementById("bulkEmployeeList");
    listDiv.innerHTML = "";
    
    rows.forEach(emp => {
        const div = document.createElement("div");
        div.innerHTML = `<label><input type="checkbox" value="${emp.code}" checked> ${emp.code} - ${emp.name}</label>`;
        listDiv.appendChild(div);
    });
    document.getElementById("bulkLeavePopup").style.display = "flex";
}
function closeBulkLeavePopup() { document.getElementById("bulkLeavePopup").style.display = "none"; }

function toggleCheckAll(checked) {
    document.querySelectorAll("#bulkEmployeeList input").forEach(cb => cb.checked = checked);
}

async function saveBulkLeave() {
    const type = document.getElementById("bulkLeaveType").value;
    const amount = document.getElementById("bulkLeaveAmount").value;
    const reason = document.getElementById("bulkLeaveReason").value;
    
    const checkboxes = document.querySelectorAll("#bulkEmployeeList input:checked");
    if (checkboxes.length === 0) { alert("Ch∆∞a ch·ªçn nh√¢n vi√™n!"); return; }
    if (!reason) { alert("Ch∆∞a nh·∫≠p l√Ω do!"); return; }

    const payload = [];
    checkboxes.forEach(cb => {
        payload.push({ code: cb.value, type: type, amount: amount, reason: reason });
    });

    await fetch(`${SCRIPT_URL}?action=addBulkLeave&data=` + encodeURIComponent(JSON.stringify(payload)));
    
    alert("ƒê√£ c·∫≠p nh·∫≠t s·ªë d∆∞!");
    closeBulkLeavePopup();
    loadScheduleOfCurrentWeek(getCurrentWeekStart());
}

/* ===========================================================
    10) C√ÅC TI·ªÜN √çCH KH√ÅC
=========================================================== */
function autoAssignShifts() {
    if (swapRow1) disableSwap();
    const rows = [...staffTbody.querySelectorAll("tr")];
    const pattern = ["S","C","HC"];
    rows.forEach((row, rIdx) => {
        const tds = row.querySelectorAll(".shift");
        tds.forEach((td, dIdx) => {
            const code = pattern[(rIdx + dIdx) % 3];
            let cls = "";
            if (code==="S") cls="ca-s"; if (code==="C") cls="ca-c"; if (code==="HC") cls="ca-hc";
            setShiftOnCell(td, code, cls);
        });
    });
}

function exportToExcel() {
    const table = document.getElementById("scheduleTable");
    const wb = XLSX.utils.table_to_book(table, {sheet:"LichTuan"});
    XLSX.writeFile(wb, `Lich_${currentGroup}.xlsx`);
}

function goBack() { window.location.href = "dashboard.html"; }

/* ===========================================================
    11) LOGIC TH√îNG B√ÅO & DUY·ªÜT Y√äU C·∫¶U (M·ªöI)
=========================================================== */
function initNotifications() {
    checkPendingRequests();
    // T·ª± ƒë·ªông check m·ªói 60 gi√¢y
    setInterval(checkPendingRequests, 60000);
}

async function checkPendingRequests() {
    try {
        const res = await fetch(`${SCRIPT_URL}?action=getPendingRequests&group=${encodeURIComponent(currentGroup)}`);
        const json = await res.json();
        if (json.success) {
            const count = json.data.length;
            const badge = document.getElementById("badgeCount");
            badge.innerText = count;
            badge.style.display = count > 0 ? "inline-block" : "none";
            window.pendingReqs = json.data;
        }
    } catch(e) { console.error(e); }
}

function openRequestsPopup() {
    document.getElementById("requestsPopup").style.display = "flex";
    renderRequestsTable();
}
function closeRequestsPopup() {
    document.getElementById("requestsPopup").style.display = "none";
    loadScheduleOfCurrentWeek();
}

function renderRequestsTable() {
    const tbody = document.getElementById("reqTableBody");
    const msg = document.getElementById("noReqMsg");
    tbody.innerHTML = "";
    
    if (!window.pendingReqs || window.pendingReqs.length === 0) {
        msg.style.display = "block";
        return;
    }
    msg.style.display = "none";

    window.pendingReqs.forEach(req => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${req.time}</td>
            <td><b>${req.code}</b><br>${req.name}</td>
            <td><span class="ca-${req.type === 'NB' ? 'nb' : 'p'}" style="padding:2px 5px; border-radius:4px;">${req.type}</span></td>
            <td style="color:#d35400; font-weight:bold;">${req.displayDate}</td>
            <td style="max-width:200px; text-align:left;">${req.reason}</td>
            <td>
                <button class="btn-success" style="padding:4px 8px; font-size:11px;" onclick="processRequest(${req.row}, 'APPROVE', this)">‚úî Duy·ªát</button>
                <button class="btn-danger" style="padding:4px 8px; font-size:11px;" onclick="processRequest(${req.row}, 'REJECT', this)">‚úò H·ªßy</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function processRequest(rowId, action, btn) {
    if (!confirm(action === 'APPROVE' ? "Duy·ªát y√™u c·∫ßu n√†y v√† t·ª± ƒë·ªông x·∫øp l·ªãch?" : "T·ª´ ch·ªëi y√™u c·∫ßu n√†y?")) return;

    const parentTd = btn.parentNode;
    parentTd.innerHTML = "ƒêang x·ª≠ l√Ω...";

    try {
        // CH√ö √ù: ƒê·ªïi t√™n tham s·ªë cu·ªëi c√πng th√†nh 'decision'
        const res = await fetch(`${SCRIPT_URL}?action=handleLeaveAction&group=${encodeURIComponent(currentGroup)}&row=${rowId}&decision=${action}`);
        const json = await res.json();
        
        if (json.success) {
            alert(json.msg);
            await checkPendingRequests();
            renderRequestsTable();
        } else {
            alert("L·ªói: " + json.message);
            renderRequestsTable();
        }
    } catch(e) {
        alert("L·ªói k·∫øt n·ªëi server!");
        renderRequestsTable();
    }
}
</script>
</body>
</html>