<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>L·ªäCH L√ÄM VI·ªÜC</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

<script src="config.js"></script>

<style>
    /* ================= STYLE CHU·∫®N ================= */
    :root { --primary: #4a90e2; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f0f2f5; --border: #d1d5db; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: #2c3e50; margin: 0; padding: 20px; }

    .container { max-width: 1350px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); min-height: 85vh; }
    
    .header-bar { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 20px; 
        background: white;
        padding: 15px 20px;
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }
    
    /* Khung ch·ª©a n√∫t ƒëi·ªÅu h∆∞·ªõng */
    .week-navigator {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f8f9fa;
        padding: 5px;
        border-radius: 300px; /* Bo tr√≤n nh∆∞ vi√™n thu·ªëc */
        border: 1px solid #eee;
    }

    /* Ph·∫ßn hi·ªÉn th·ªã ch·ªØ ·ªü gi·ªØa */
    .week-display {
        font-size: 150px;
        font-weight: 1000;
        color: #2c3e50;
        padding: 0 15px;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .week-display:hover { color: var(--primary); }
    h2 { margin: 0; color: var(--primary); font-weight: 700; font-size: 24px; text-transform: uppercase; }
    .week-badge { background: #e0f2fe; color: var(--primary); padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 20px; }
    
    .control-bar { display: flex; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 12px; border: 1px solid var(--border); flex-wrap: wrap; align-items: center;}
    
    button { padding: 9px 14px; border-radius: 8px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-family: 'Inter'; transition: 0.2s; }
    button:hover { transform: translateY(-2px); filter: brightness(105%); }
    .btn-p { background: var(--primary); color: white; }
    .btn-s { background: var(--success); color: white; }
    .btn-w { background: var(--warning); color: white; }
    .btn-d { background: var(--danger); color: white; }
    .btn-o { background: white; border: 1px solid var(--border); color: #555; }
    
    /* Style ri√™ng cho n√∫t ƒê·∫£o khi Active */
    .btn-swap-active { background: #f39c12; color: white; border: 1px solid #e67e22; animation: pulseBtn 1.5s infinite; }
    @keyframes pulseBtn { 0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(243, 156, 18, 0); } 100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); } }

    table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid var(--border); margin-bottom: 50px; }
    thead { position: sticky; top: 0; z-index: 10; }
    th { background: #f8f9fa; padding: 10px 5px; font-size: 12px; font-weight: 700; color: #444; border-bottom: 2px solid var(--border); border-right: 1px solid var(--border); text-transform: uppercase; }
    td { padding: 5px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); font-size: 13px; text-align: center; height: 38px; vertical-align: middle; position: relative; }
    
    th:last-child, td:last-child { border-right: none; }
    #headerDatesRow th:last-child { border-right: 1px solid var(--border) !important; }

    /* Cells */
    .shift { cursor: pointer; font-weight: 700; user-select: none; }
    .shift:hover { background-color: #ebf5fb !important; box-shadow: inset 0 0 0 2px var(--primary); }
    .selected { box-shadow: inset 0 0 0 2px var(--primary) !important; background: rgba(74,144,226,0.1); }
    .copy-source { outline: 2px dashed var(--primary); animation: pulse 1s infinite; }
    @keyframes pulse { 50% { outline-color: transparent; } }

    /* Hi·ªáu ·ª©ng khi ch·ªçn d√≤ng ƒë·ªÉ ƒê·∫£o */
    .row-swap-selected { background-color: #fff3cd !important; border: 2px dashed #f39c12; }
    tr.swap-mode-hover:hover td { background-color: #fcf8e3; cursor: pointer; }

    .ca-s { background:#e3f2fd; color:#1565c0; } .ca-c { background:#e8f5e9; color:#2e7d32; }
    .ca-hc { background:#f3e5f5; color:#7b1fa2; } .ca-nb { background:#ffebee; color:#c62828; }
    .ca-p { background:#fce4ec; color:#ad1457; } .ca-ct { background:#e0f7fa; color:#006064; }
	
	/* --- M√ÄU S·∫ÆC CHO C√ÅC CA M·ªöI --- */
    .ca-s-plus { background: #bbdefb; color: #0d47a1; border: 1px solid #90caf9; } /* S√°ng ƒë·∫≠m h∆°n ch√∫t */
    .ca-nc { 
        background: #fff9c4;       /* N·ªÅn v√†ng kem (ƒë·ªÉ kh√¥ng b·ªã ch√≥i m·∫Øt) */
        color: #f57f17;            /* Ch·ªØ v√†ng ƒë·∫≠m (T√¥ng Gold/Cam) */
        border: 1px solid #fbc02d; /* Vi·ªÅn v√†ng ƒë·∫≠m bao quanh */
        font-weight: bold;         /* In ƒë·∫≠m cho n·ªïi b·∫≠t */
    }
    
    .ca-o  { background: #fff3e0; color: #e67e22; } /* M√†u cam nh·∫°t cho Con ·ªëm */
    .ca-te { background: #fef9c3; color: #b45309; border: 1px solid #fde047; } /* M√†u v√†ng t·∫øt */
    .ca-l  { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; } /* M√†u ƒë·ªè l·ªÖ (kh√°c NB ch√∫t) */
    .ca-nm { background: #ccfbf1; color: #0f766e; } /* M√†u xanh ng·ªçc ngh·ªâ m√°t */
	.ca-kl { background: #e0e0e0; color: #636e72; border: 1px solid #b2bec3; font-weight: bold; }

    /* Popups */
    .popup-bg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.6); backdrop-filter: blur(2px); z-index: 1000; justify-content: center; align-items: center; }
    .popup-box { background: white; padding: 0 25px 25px 25px; width: 450px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideIn 0.3s; }
    .popup-box h3 { background: var(--primary); color: white; margin: 0 -25px 20px -25px; padding: 15px 25px; border-radius: 16px 16px 0 0; font-size: 16px; }
    
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; }
    label { font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 5px; }

    .emp-list-container { max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 5px; background: #f9fafb; margin-bottom: 15px; }
    .emp-item { display: flex; align-items: center; padding: 8px; border-radius: 6px; cursor: pointer; border-bottom: 1px solid #eee; }
    .emp-item:hover { background: #e0f2fe; }
    .emp-item:last-child { border-bottom: none; }
    .emp-item input { width: 16px; height: 16px; margin-right: 10px; cursor: pointer; margin-bottom: 0; }

    #shiftMenu { position: absolute; display: none; background: white; border: 1px solid #ddd; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-radius: 8px; padding: 5px; width: 160px; z-index: 100; max-height: 300px; overflow-y: auto; }
    #shiftMenu button { width: 100%; text-align: left; background: none; margin: 1px 0; border-radius: 4px; }
    #shiftMenu button:hover { background: #f0f2f5; }
    .menu-badge { display: inline-block; width: 30px; text-align: center; border-radius: 4px; font-size: 11px; margin-right: 8px; border: 1px solid #eee; }
    
    #loading { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 10px 20px; border-radius: 30px; display: none; z-index: 2000; font-size: 13px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
	
	/* Hi·ªáu ·ª©ng khi qu√©t ch·ªçn nhi·ªÅu √¥ */
    .cell-multi-selected {
        background-color: rgba(74, 144, 226, 0.2) !important;
        border: 1px double var(--primary);
    }
    
    /* Hi·ªáu ·ª©ng √¥ ƒëang ƒë∆∞·ª£c Copy (Ki·∫øn b√≤) */
    .copy-source {
        outline: 2px dashed var(--primary);
        animation: pulseBorder 1s infinite;
        background-color: #fff !important;
    }
    @keyframes pulseBorder { 50% { outline-color: transparent; } }
	
	/* --- B·∫¢NG DUY·ªÜT Y√äU C·∫¶U (CHU·∫®N UI) --- */
    .req-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    
    .req-table th { 
        background: #f8f9fa;           /* N·ªÅn x√°m nh·∫°t */
        color: #444;                   /* Ch·ªØ m√†u x√°m ƒë·∫≠m */
        font-size: 12px;               /* C·ª° ch·ªØ chu·∫©n */
        font-weight: 700;              /* In ƒë·∫≠m */
        text-transform: uppercase;     /* Vi·∫øt hoa */
        padding: 12px 5px;             /* Kho·∫£ng c√°ch ƒë·ªám */
        
        border-bottom: 2px solid #d1d5db; /* K·∫ª d∆∞·ªõi ƒë·∫≠m */
        border-right: 1px solid #d1d5db;  /* K·∫ª ph·∫£i (ngƒÉn c√°ch c·ªôt) */
        
        text-align: center;            /* M·∫∑c ƒë·ªãnh cƒÉn gi·ªØa ti√™u ƒë·ªÅ */
        vertical-align: middle;
        position: sticky; top: 0; z-index: 10; /* Ghim ti√™u ƒë·ªÅ khi cu·ªôn */
    }
    
    /* B·ªè k·∫ª ph·∫£i ·ªü c·ªôt cu·ªëi c√πng */
    .req-table th:last-child { border-right: none; }

    .req-table td { 
        padding: 8px 5px; 
        border-bottom: 1px solid #d1d5db; 
        border-right: 1px solid #d1d5db; /* K·∫ª d·ªçc cho ph·∫ßn th√¢n lu√¥n */
        font-size: 13px; 
        color: #333; 
        vertical-align: middle;
    }
    .req-table td:last-child { border-right: none; }
	
	/* Th√™m v√†o th·∫ª style */
	.status-ok { color: #27ae60 !important; } /* M√†u xanh */
	.status-lack { color: #e74c3c !important; } /* M√†u ƒë·ªè */
	.src-item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
	.src-item-row:hover { background-color: #f0f9ff; cursor: pointer; }
	
	/* Th√™m class m·ªõi cho n√∫t Excel */
	.btn-excel { 
		background-color: #1D6F42; /* M√†u xanh Excel ƒë·∫≠m */
		color: white;
	}
	.btn-excel:hover {
		background-color: #155b34; /* M√†u khi di chu·ªôt v√†o */
	}
	
	.btn-purple { 
		background-color: #8e44ad; 
		color: white; 
	}
	.btn-purple:hover { 
		background-color: #732d91; /* T√≠m ƒë·∫≠m h∆°n khi di chu·ªôt */
	}
	
	/* --- HI·ªÜU ·ª®NG HIGHLIGHT D√íNG & C·ªòT (CROSSHAIR) --- */
    
    /* Class d√πng ƒë·ªÉ l√†m t·ªëi c√°c √¥ trong d√≤ng/c·ªôt ƒëang ch·ªçn */
    .crosshair-highlight {
        background-color: rgba(0, 0, 0, 0.08) !important; /* Ph·ªß l·ªõp ƒëen m·ªù 8% */
        transition: background-color 0.1s ease;
    }

    /* Ri√™ng √¥ con tr·ªè chu·ªôt ƒëang ƒë·ª©ng th√¨ l√†m t·ªëi ƒë·∫≠m h∆°n */
    .crosshair-center {
        background-color: rgba(0, 0, 0, 0.15) !important; /* Ph·ªß l·ªõp ƒëen m·ªù 15% */
        outline: 2px solid #666; /* Vi·ªÅn bao quanh √¥ */
        outline-offset: -2px;
        cursor: crosshair;
    }

    /* ƒê·∫£m b·∫£o hi·ªáu ·ª©ng ƒë√® l√™n ƒë∆∞·ª£c m√†u n·ªÅn c·ªßa c√°c ca l√†m vi·ªác */
    td.shift {
        position: relative; /* ƒê·ªÉ z-index ho·∫°t ƒë·ªông n·∫øu c·∫ßn */
    }
	
	/* --- CSS CHO N√öT V√Ä MODAL C√ÄI ƒê·∫∂T --- */
    .btn-setting {
        background: #f1f1f1;
        color: #555;
        border: 1px solid #ddd;
        padding: 8px 12px;
        font-size: 14px;
        margin-left: 10px; /* C√°ch c√°c n√∫t kh√°c */
    }

    /* Modal n·ªÅn t·ªëi */
    .settings-modal {
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0; top: 0; 
        width: 100%; height: 100%;
        overflow: auto; 
        background-color: rgba(0,0,0,0.4);
    }

    /* N·ªôi dung modal */
    .settings-modal-content {
        background-color: #fefefe;
        margin: 10% auto; 
        padding: 25px;
        border: 1px solid #888;
        width: 80%; 
        max-width: 400px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        animation: animatetop 0.4s;
    }

    /* Animation m·ªü modal */
    @keyframes animatetop {
        from { top: -300px; opacity: 0 }
        to { top: 0; opacity: 1 }
    }

    .modal-close {
        color: #aaa; float: right; font-size: 28px; font-weight: bold;
    }
    .modal-close:hover, .modal-close:focus {
        color: black; text-decoration: none; cursor: pointer;
    }

    /* Style cho Toggle Switch */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px; height: 34px;
        vertical-align: middle;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #ccc; transition: .4s; border-radius: 34px;
    }
    .slider:before {
        position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px;
        background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: #2196F3; }
    input:checked + .slider:before { transform: translateX(26px); }
	
	/* Style cho √¥ Input khi ƒëang nh·∫≠p li·ªáu gi·ªëng Excel */
	.cell-editor {
		width: 100%;
		height: 100%;
		border: none;
		outline: 2px solid #0078d4; /* Vi·ªÅn xanh khi ƒëang nh·∫≠p */
		background: white;
		font-size: 14px;
		font-family: inherit;
		font-weight: bold;
		text-align: center;
		padding: 0;
		margin: 0;
		position: absolute; /* ƒê√® l√™n √¥ c≈© */
		top: 0;
		left: 0;
		z-index: 100;
	}

	.shift {
		position: relative; /* ƒê·ªÉ √¥ input ƒë√® l√™n ch√≠nh x√°c */
	}
	
	/* D·∫•u hi·ªáu c√≥ ƒë∆°n xin ngh·ªâ ch∆∞a duy·ªát */
	.cell-request-pending {
		position: relative;
		/* Vi·ªÅn cam nh·∫•p nh√°y ƒë·ªÉ g√¢y ch√∫ √Ω */
		box-shadow: inset 0 0 0 2px #f39c12; 
	}

	/* Tam gi√°c nh·ªè ·ªü g√≥c */
	.cell-request-pending::after {
		content: '';
		position: absolute;
		top: 0; right: 0;
		width: 0; height: 0;
		border-style: solid;
		border-width: 0 12px 12px 0;
		border-color: transparent #f39c12 transparent transparent;
	}

	/* N√∫t duy·ªát nhanh trong Menu */
	.btn-approve-quick {
		background-color: #e3f2fd !important;
		color: #1976d2 !important;
		border: 1px dashed #1976d2 !important;
		font-weight: bold;
		margin-bottom: 5px;
	}
</style>
</head>
<body>

<div class="container">
    <div class="header-bar">
        <div>
            <h2 style="font-weight:bold; font-size:35px;">L·ªäCH L√ÄM VI·ªÜC</h2>
            <div style="font-size:15px; color:#666; margin-top:5px;">Nh√≥m: <b id="groupNameDisplay">...</b></div>
        </div>
        <div class="week-badge" id="weekRangeDisplay">ƒêang t·∫£i...</div>
    </div>

    <div class="control-bar">
        <div style="display:flex; gap:10px; border-right:1px solid #ddd; padding-right:10px;">
            <button class="btn-p" onclick="openAddEmpPopup()">‚ûï Nh√¢n vi√™n</button>
            <button class="btn-p" onclick="openBulkLeavePopup()">‚ûï Ph√©p/B√π</button>
			<button class="btn-purple" onclick="openApprovalPopup()" style="position:relative;">
				üîî Y√™u c·∫ßu 
				<span id="badgeReq" style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:10px; position:absolute; top:-5px; right:-5px; display:none;">0</span>
			</button>
        </div>
		<div style="display:inline-flex; gap:5px; margin-right:10px;">
			<button class="btn-w" onclick="saveSchedule(false)">üíæ L∆∞u l·ªãch</button>
			<button id="btnUndoUI" class="btn-s" onclick="performUndo()" title="Ph√≠m t·∫Øt: Undo (Ctrl+Z)" disabled style="opacity:0.5">‚Ü©Ô∏è Undo</button>
			<button id="btnRedoUI" class="btn-s" onclick="performRedo()" title="Ph√≠m t·∫Øt: Redo (Ctrl+Y)" disabled style="opacity:0.5">‚Ü™Ô∏è Redo</button>
		</div>
        <div style="display:flex; gap:10px; border-right:1px solid #ddd; padding-right:10px;">
            <button class="btn-o" id="btnSwap" onclick="toggleSwapMode()">‚áå ƒê·∫£o</button>
            <button class="btn-o" onclick="openWeekPopup()">üìÖ Ch·ªçn Tu·∫ßn</button>
            <button class="btn-o" onclick="loadSchedule()">üîÑ T·∫£i l·∫°i</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-s" onclick="exportToExcel()">üìä Xu·∫•t Excel</button>
			<button class="btn-excel" onclick="openExportRangePopup()">üìÖ Xu·∫•t Excel(T√πy ch·ªçn)</button>
        </div>
		<div style="display:flex; gap:10px;">
			<button class="btn-setting" onclick="document.getElementById('settingsModal').style.display='block'">‚öôÔ∏è C√†i ƒë·∫∑t</button>
            <button class="btn-d" onclick="window.location.href='dashboard.html'">‚Üê Tho√°t</button>
        </div>
    </div>

    <table id="scheduleTable">
        <thead>
            <tr>
                <th rowspan="2" style="width:40px; font-weight:bold; font-size:18px;">STT</th>
                <th rowspan="2" style="width:60px; font-size:18px;">M√É NV</th>
                <th rowspan="2" style="min-width:150px; font-weight:bold; font-size:18px;">H·ªå T√äN</th>
                <th rowspan="2" style="min-width:100px; font-weight:bold; font-size:18px;">CH·ª®C V·ª§</th>
                
                <th>T2</th><th>T3</th><th>T4</th><th>T5</th><th>T6</th><th>T7</th><th style="color:#e74c3c;">CN</th>
                
                <th rowspan="2" id="th_p_old" class="col-p-old" style="width:45px; color:#7f8c8d; font-size:11px;">P.C≈®</th>
				<th rowspan="2" id="th_p_new" style="width:45px;">P.M·ªöI</th>
				<th rowspan="2" id="th_b_old" class="col-b-old" style="width:45px; color:#7f8c8d; font-size:11px;">B.C≈®</th>
				<th rowspan="2" id="th_b_new" style="width:45px;">B.M·ªöI</th>
                
                <th rowspan="2" style="width:50px; background:#fffcf5; color:#d35400;">T·ªîNG</th>
				<th rowspan="2" style="width: 50px;">Ghi ch√∫</th>
                <th rowspan="2" style="width:40px;">X√ìA</th>
            </tr>
            <tr id="headerDatesRow"></tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
    </table>
	
	<div style="margin-top: 20px; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; background: white;">
        
        <button onclick="toggleSummaryTable()" style="width: 100%; text-align: left; padding: 12px 20px; background: #e9ecef; border: none; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <span>üìã B·∫¢NG T·ªîNG H·ª¢P CHI TI·∫æT (NOTE)</span>
            <span id="summaryIcon">‚ñº</span>
        </button>

        <div id="summaryContainer" style="display: none; padding: 15px;">
            <table class="summary-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background-color: #f8f9fa;">
                        <th style="text-align: left; padding: 8px; border: 1px solid #ddd;">LO·∫†I CA / NGH·ªà</th>
                        <th style="width: 50px; border: 1px solid #ddd;">T2</th>
                        <th style="width: 50px; border: 1px solid #ddd;">T3</th>
                        <th style="width: 50px; border: 1px solid #ddd;">T4</th>
                        <th style="width: 50px; border: 1px solid #ddd;">T5</th>
                        <th style="width: 50px; border: 1px solid #ddd;">T6</th>
                        <th style="width: 50px; border: 1px solid #ddd;">T7</th>
                        <th style="width: 50px; border: 1px solid #ddd; color: red;">CN</th>
                    </tr>
                </thead>
                <tbody id="summaryBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="shiftMenu"></div>

<div id="weekPopup" class="popup-bg">
    <div class="popup-box">
        <h3>Ch·ªçn Tu·∫ßn L√†m Vi·ªác</h3>
        
        <label style="color:#2980b9;">üìÇ M·ªü tu·∫ßn ƒë√£ l∆∞u:</label>
        <select id="weekSelect" onchange="document.getElementById('newWeekPicker').value = ''">
            <option value="">-- ƒêang t·∫£i d·ªØ li·ªáu... --</option>
        </select>

        <div style="text-align:center; color:#999; margin: 10px 0; font-size:12px;">--- HO·∫∂C ---</div>

        <label style="color:#27ae60;">üÜï T·∫°o tu·∫ßn m·ªõi (Ch·ªçn Th·ª© 2):</label>
        <input type="date" id="newWeekPicker" onchange="document.getElementById('weekSelect').value = ''">

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn-d" onclick="closePopup('weekPopup')">ƒê√≥ng</button>
            <button class="btn-p" onclick="confirmWeekSelection()">M·ªü L·ªãch</button>
        </div>
    </div>
</div>

<div id="addEmpPopup" class="popup-bg">
    <div class="popup-box" style="width: 500px;"> 
        <h3>Th√™m Nh√¢n Vi√™n</h3>
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>M√£ NV:</label><input id="newEmpCode" placeholder="VD: NV01"></div>
            <div style="flex:2"><label>H·ªç T√™n:</label><input id="newEmpName" placeholder="Nh·∫≠p t√™n"></div>
        </div>
        <label>Ch·ª©c v·ª•:</label><input id="newEmpRole" placeholder="VD: Nh√¢n vi√™n">
        
        <div style="display:flex; justify-content:flex-end; gap:10px; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn-d" onclick="closePopup('addEmpPopup')">H·ªßy</button> 
            <button class="btn-p" onclick="confirmAddEmployee()">L∆∞u v√†o L·ªãch</button>
        </div>
    </div>
</div>

<div id="bulkLeavePopup" class="popup-bg">
    <div class="popup-box">
        <h3>C·ªông Ph√©p / B√π</h3>
        <label>Lo·∫°i:</label>
        <select id="blType" style="margin-bottom:10px;"><option value="PN">Ph√©p NƒÉm (PN)</option><option value="NB">Ngh·ªâ B√π (NB)</option></select>
        
        <label>S·ªë l∆∞·ª£ng:</label>
        <input type="number" id="blAmount" value="1" style="margin-bottom:10px;">
        
        <label>L√Ω do:</label>
        <input id="blReason" placeholder="L√Ω do (VD: Th∆∞·ªüng l·ªÖ)" style="margin-bottom:10px;">
        
        <label>Ch·ªçn nh√¢n vi√™n:</label>
        <div style="border:1px solid #d1d5db; border-radius:8px; padding:10px; background:white;">
            <div style="padding-bottom:5px; border-bottom:1px solid #eee; margin-bottom:5px;">
                <label style="display:flex; align-items:center; cursor:pointer; font-weight:700; color:var(--primary);">
                    <input type="checkbox" id="checkAllBox" onchange="toggleCheckAll(this)" style="width:16px; height:16px; margin:0 10px 0 0;"> Ch·ªçn t·∫•t c·∫£
                </label>
            </div>
            <div id="blEmpList" class="emp-list-container" style="border:none; margin:0; padding:0; background:white;"></div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button class="btn-d" onclick="closePopup('bulkLeavePopup')">H·ªßy</button> 
            <button class="btn-p" onclick="submitBulkLeave()">L∆∞u</button>
        </div>
    </div>
</div>

<div id="approvalPopup" class="popup-bg">
    <div class="popup-box" style="width: 900px;"> <h3>üîî Duy·ªát Y√™u C·∫ßu Ngh·ªâ Ph√©p</h3>
        
        <div style="">
            <table class="req-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">M√£ NV</th>
                        <th style="width: 100px; text-align: left; padding-left: 10px;">H·ªç T√™n</th>
                        <th style="width: 100px;">Ng√†y</th>
                        <th style="width: 80px;">Lo·∫°i</th>
                        <th style="text-align: left; padding-left: 10px;">L√Ω Do / Ghi Ch√∫</th>
                        <th style="width: 140px;">Thao T√°c</th>
                    </tr>
                </thead>
                <tbody id="reqListBody"></tbody>
            </table>
            
            <div id="noReqMsg" style="text-align:center; padding:30px; color:#999; display:none;">
                Kh√¥ng c√≥ y√™u c·∫ßu n√†o ƒëang ch·ªù duy·ªát.
            </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button class="btn-d" onclick="closePopup('approvalPopup')">ƒê√≥ng</button>
        </div>
    </div>
</div>

<div id="nbSourcePopup" class="popup-bg">
    <div class="popup-box" style="width: 500px;">
        <h3 id="nbSourceTitle">Ch·ªçn ngu·ªìn c√¥ng b√π</h3>
        
        <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:15px;">
            <div style="font-size:13px; color:#555;">ƒêang ch·ªçn cho m√£: <b id="nbTargetCode" style="color:#2980b9;">...</b></div>
            <div style="font-size:13px; color:#555;">Ng√†y ngh·ªâ: <b id="nbTargetDate" style="color:#e74c3c;">...</b></div>
            <div style="font-size:13px; color:#555;">Lo·∫°i ngh·ªâ: <b id="nbTargetType" style="color:#27ae60;">...</b></div>
        </div>

        <label style="color:#1967d2;">Danh s√°ch ngu·ªìn b√π kh·∫£ d·ª•ng:</label>
        <div id="nbSourceList" class="emp-list-container" style="height:200px; background:white;">
            <div style="padding:10px; text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>

        <div id="nbCalcStatus" style="text-align:right; font-weight:bold; font-size:13px; margin-top:10px; color:#e74c3c;">
            ...
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn-d" onclick="closePopup('nbSourcePopup')">H·ªßy</button> 
            <button class="btn-p" onclick="confirmNbSelection()">X√°c nh·∫≠n & L∆∞u</button>
        </div>
    </div>
</div>

<div id="exportRangePopup" class="popup-bg">
    <div class="popup-box">
        <h3>Xu·∫•t B√°o C√°o Excel</h3>
        
        <label>T·ª´ ng√†y:</label>
        <input type="date" id="expFrom">
        
        <label>ƒê·∫øn ng√†y:</label>
        <input type="date" id="expTo">
        
        <div style="margin-top:15px; background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #eee;">
            <label style="display:flex; align-items:center; cursor:pointer; font-weight:normal; margin-bottom:0; color:#333;">
                <input type="checkbox" id="chkIncludeInactive" style="width:18px; height:18px; margin-right:8px; margin-bottom:0;">
                Xu·∫•t c·∫£ nh√¢n vi√™n ƒë√£ ngh·ªâ (Inactive)
            </label>
            <div style="font-size:11px; color:#888; margin-top:4px; padding-left:26px;">
                (D√πng ƒë·ªÉ t√≠nh l∆∞∆°ng cho ng∆∞·ªùi ngh·ªâ vi·ªác gi·ªØa ch·ª´ng)
            </div>
        </div>
        
        <div style="margin-top:15px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn-d" onclick="document.getElementById('exportRangePopup').style.display='none'">ƒê√≥ng</button>
            <button class="btn-s" onclick="doExportRange()">T·∫£i v·ªÅ</button>
        </div>
    </div>
</div>

<div id="settingsModal" class="settings-modal">
    <div class="settings-modal-content">
        <span class="modal-close" onclick="document.getElementById('settingsModal').style.display='none'">&times;</span>
        <h2>‚öôÔ∏è C√†i ƒë·∫∑t ·ª®ng d·ª•ng</h2>
        <hr style="border:none; border-top: 1px solid #eee; margin:15px 0;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <label style="font-weight: 500;">B·∫≠t Highlight D√≤ng & C·ªôt:</label>
            <label class="toggle-switch">
                <input type="checkbox" id="toggleCrosshair" onchange="toggleCrosshairFeature(this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        
        <p style="font-size:12px; color:#888;">*T√≠nh nƒÉng Highlight gi√∫p d·ªÖ d√†ng theo d√µi d√≤ng/c·ªôt khi r√™ chu·ªôt.</p>
    </div>
</div>

<div id="editEmpPopup" class="popup-bg">
    <div class="popup-box" style="width: 400px;">
        <h3>‚úèÔ∏è S·ª≠a Th√¥ng Tin Nh√¢n Vi√™n</h3>
        
        <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #eee;">
            <label style="margin:0; color:#888; font-size:12px;">M√£ Nh√¢n Vi√™n (Kh√¥ng th·ªÉ s·ª≠a):</label>
            <div id="lblEditCode" style="font-weight:bold; font-size:18px; color:var(--primary);">...</div>
        </div>

        <label>H·ªç T√™n:</label>
        <input id="txtEditName" placeholder="Nh·∫≠p h·ªç t√™n m·ªõi">
        
        <label>Ch·ª©c v·ª•:</label>
        <input id="txtEditRole" placeholder="Nh·∫≠p ch·ª©c v·ª• m·ªõi">

        <label>Tr·∫°ng th√°i:</label>
        <select id="selEditStatus">
            <option value="active">üü¢ ƒêang l√†m vi·ªác</option>
            <option value="inactive">üî¥ ƒê√£ ngh·ªâ vi·ªác (·∫®n kh·ªèi l·ªãch)</option>
        </select>
        
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn-d" onclick="closePopup('editEmpPopup')">H·ªßy</button> 
            <button class="btn-p" onclick="submitEditEmployee()">L∆∞u Thay ƒê·ªïi</button>
        </div>
    </div>
</div>

<div id="loading">‚è≥ ƒêang x·ª≠ l√Ω...</div>

<script>
	// bi·∫øn ph·∫ßn c√†i ƒë·∫∑t
	let isCrosshairEnabled = true; // Bi·∫øn tr·∫°ng th√°i to√†n c·ª•c
    const SETTINGS_KEY = 'scheduler_settings';

    // ================= 2. BI·∫æN TO√ÄN C·ª§C & C·∫§U H√åNH CA =================
    const urlParams = new URLSearchParams(window.location.search);
    const currentGroup = urlParams.get('group') || "Gia d·ª•ng";
    let currentWeekStart = ""; 
    let employeesData = []; 
    
	// T·∫°o ID ƒë·ªãnh danh cho tr√¨nh duy·ªát hi·ªán t·∫°i
	const MY_CLIENT_ID = "client_" + Math.random().toString(36).substr(2, 9);
	console.log("Client ID c·ªßa t√¥i l√†:", MY_CLIENT_ID);
	
    // BI·∫æN CHO CH·ª®C NƒÇNG ƒê·∫¢O
    let isSwapMode = false;
    let swapSourceIdx = -1;

    // DANH S√ÅCH CA L√ÄM VI·ªÜC (ƒê√É C·∫¨P NH·∫¨T)
    const SHIFTS = [
        {code:"", label:"(X√≥a/Tr·ªëng)", cls:""},
        
        // --- Nh√≥m L√†m vi·ªác ---
        {code:"S",  label:"Ca S√°ng",     cls:"ca-s"},
        {code:"S1", label:"Ca S1",       cls:"ca-s"},
        {code:"S+", label:"S√°ng (+CC)",  cls:"ca-s-plus"}, // Ca m·ªõi
        {code:"C",  label:"Ca Chi·ªÅu",    cls:"ca-c"},
        {code:"HC", label:"H√†nh ch√≠nh",  cls:"ca-hc"},
        {code:"CT", label:"C√¥ng t√°c",    cls:"ca-ct"},

        // --- Nh√≥m Ngh·ªâ Ph√©p/B√π ---
        {code:"P",    label:"Ph√©p (1.0)", cls:"ca-p"},
        {code:"P/2",  label:"Ph√©p (0.5)", cls:"ca-p"},
        {code:"NB",   label:"Ngh·ªâ B√π (1.0)", cls:"ca-nb"},
        {code:"NB/2", label:"Ngh·ªâ B√π (0.5)", cls:"ca-nb"},

        // --- Nh√≥m Ngh·ªâ Kh√°c (M·ªõi th√™m) ---
        {code:"NC", label:"Ngh·ªâ CN",   cls:"ca-nc"},
        {code:"√î",  label:"Con ·ªëm",    cls:"ca-o"},
        {code:"Te", label:"Ngh·ªâ T·∫øt",  cls:"ca-te"},
        {code:"L",  label:"Ngh·ªâ L·ªÖ",   cls:"ca-l"},
        {code:"NM", label:"Ngh·ªâ M√°t",  cls:"ca-nm"},
		
		// --- NH√ìM M·ªöI ---
		{code:"KL", label:"Kh√¥ng l∆∞∆°ng", cls:"ca-kl"}
    ];

    // ================= 3. KH·ªûI T·∫†O =================
    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("groupNameDisplay").innerText = currentGroup;
        
        // --- [M·ªöI] KI·ªÇM TRA L·ªäCH S·ª¨ TRUY C·∫¨P ---
        const lastViewedWeek = localStorage.getItem("LAST_WEEK_" + currentGroup);
        
        if (lastViewedWeek) {
            // N·∫øu c√≥ l·ªãch s·ª≠ -> M·ªü tu·∫ßn ƒë√£ l√†m vi·ªác g·∫ßn nh·∫•t
            currentWeekStart = lastViewedWeek;
        } else {
            // N·∫øu ch∆∞a c√≥ (l·∫ßn ƒë·∫ßu v√†o) -> T√≠nh tu·∫ßn hi·ªán t·∫°i
            const d = new Date();
            const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            currentWeekStart = formatDateISO(monday);
        }
        
        loadSchedule();
    });

    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u requests (d√πng cho vi·ªác hi·ªÉn th·ªã ch·∫•m ƒë·ªè ·ªü renderTable)
	let requestsData = []; 

	// ================= 4. T·∫¢I D·ªÆ LI·ªÜU (ƒê√É S·ª¨A L·ªåC NH√ìM & G·ªåI CHECK Y√äU C·∫¶U) =================
	async function loadSchedule() {
		showLoading(true, "‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...");
		try {
			// 1. X√ÅC ƒê·ªäNH TH·ªúI GIAN
			const viewDate = new Date(currentWeekStart);
			const viewYear = viewDate.getFullYear(); 
			const prevYear = viewYear - 1;            

			// C·∫≠p nh·∫≠t Ti√™u ƒë·ªÅ c·ªôt
			const elPOld = document.getElementById("th_p_old");
			const elPNew = document.getElementById("th_p_new");
			const elBOld = document.getElementById("th_b_old");
			const elBNew = document.getElementById("th_b_new");
			
			if(elPOld) elPOld.innerText = `Ph√©p ${prevYear}`;
			if(elPNew) elPNew.innerText = `Ph√©p ${viewYear}`;
			if(elBOld) elBOld.innerText = `B√π ${prevYear}`;
			if(elBNew) elBNew.innerText = `B√π ${viewYear}`;

			// 2. T·∫¢I D·ªÆ LI·ªÜU SONG SONG
			const [schRes, empRes, balRes, reqRes] = await Promise.all([
				_supabase.from('schedule').select('*').eq('group_name', currentGroup).eq('week_start', currentWeekStart).order('stt', { ascending: true }),
				_supabase.from('employees').select('*').eq('group_name', currentGroup).eq('status', 'active').order('stt', { ascending: true }),
				_supabase.from('leave_balance').select('*').in('year', [viewYear, prevYear]),
				// T·∫£i y√™u c·∫ßu ngh·ªâ ƒë·ªÉ hi·ªán ch·∫•m ƒë·ªè (L·∫•y r·ªông ra ch√∫t ƒë·ªÉ ch·∫Øc ch·∫Øn)
				_supabase.from('leave_requests').select('*').eq('status', 'Ch·ªù duy·ªát').gte('date', currentWeekStart)
			]);

			const schData = schRes.data || [];
			const allEmps = empRes.data || [];
			const balances = balRes.data || [];
			
			// [S·ª¨A L·ªñI NH·∫¶M NH√ìM CHO CH·∫§M ƒê·ªé]
			// Ch·ªâ l·∫•y nh·ªØng requests thu·ªôc v·ªÅ nh√¢n vi√™n c√≥ trong nh√≥m n√†y
			const groupEmpCodes = allEmps.map(e => e.code);
			requestsData = (reqRes.data || []).filter(r => groupEmpCodes.includes(r.emp_code)); 

			// Map s·ªë d∆∞
			const balCurrent = {}; 
			const balPrev = {};    
			if(balances) {
				balances.forEach(b => {
					if (b.year === viewYear) balCurrent[b.emp_code] = b;
					if (b.year === prevYear) balPrev[b.emp_code] = b;
				});
			}

			// 3. X·ª¨ L√ù D·ªÆ LI·ªÜU
			employeesData = [];
			const processedCodes = new Set();
			const hasSchedule = schData && schData.length > 0;

			const getFreshBalance = (empCode, empProfile) => {
				let pNew=0, bNew=0, pOld=0, bOld=0;
				if (balCurrent[empCode]) {
					const b = balCurrent[empCode];
					pNew = Number(b.pn_val)||0; bNew = Number(b.nb_val)||0;
					pOld = Number(b.pn_old_val)||0; bOld = Number(b.nb_old_val)||0; 
				} else if (balPrev[empCode]) {
					const bPrev = balPrev[empCode];
					pOld = Number(bPrev.pn_val)||0; bOld = Number(bPrev.nb_val)||0;
				}
				if (empProfile) {
					const pnExpireDate = empProfile.pn_expire ? new Date(empProfile.pn_expire) : null;
					const nbExpireDate = empProfile.nb_expire ? new Date(empProfile.nb_expire) : null;
					if (pnExpireDate && viewDate > pnExpireDate) pOld = 0;
					if (nbExpireDate && viewDate > nbExpireDate) bOld = 0;
				}
				return { pNew, bNew, pOld, bOld };
			};

			if (hasSchedule) {
				schData.forEach(s => {
					const empProfile = allEmps ? allEmps.find(e => e.code === s.emp_code) : null;
					let pOld = Number(s.pn_old)||0; let bOld = Number(s.nb_old)||0;
					if (empProfile) {
						const pnExpireDate = empProfile.pn_expire ? new Date(empProfile.pn_expire) : null;
						const nbExpireDate = empProfile.nb_expire ? new Date(empProfile.nb_expire) : null;
						if (pnExpireDate && viewDate > pnExpireDate) pOld = 0;
						if (nbExpireDate && viewDate > nbExpireDate) bOld = 0;
					}
					employeesData.push({
						code: s.emp_code, name: s.emp_name, role: s.emp_role, 
						join_date: empProfile ? empProfile.created_at : null,
						stt: (s.stt !== null && s.stt !== undefined) ? s.stt : (empProfile ? (empProfile.stt || 9999) : 9999),
						shifts: s.shifts || Array(7).fill(""),
						pn: Number(s.pn_new)||0, nb: Number(s.nb_new)||0,
						pn_old: pOld, nb_old: bOld, note: s.note || ""
					});
					processedCodes.add(s.emp_code);
				});
			}

			if (allEmps) {
				const weekEndDate = new Date(currentWeekStart); weekEndDate.setDate(weekEndDate.getDate() + 7); 
				allEmps.forEach(e => {
					if (!processedCodes.has(e.code)) {
						const joinDate = new Date(e.created_at);
						if (joinDate > weekEndDate) return;
						const bal = getFreshBalance(e.code, e);
						employeesData.push({
							code: e.code, name: e.name, role: e.role,
							stt: (e.stt !== undefined && e.stt !== null) ? e.stt : 9999,
							shifts: Array(7).fill(""),
							pn: bal.pNew, nb: bal.bNew, pn_old: bal.pOld, nb_old: bal.bOld, note: ""
						});
					}
				});
			}
			
			employeesData.sort((a, b) => {
				const sttA = (a.stt !== undefined && a.stt !== null) ? a.stt : 9999;
				const sttB = (b.stt !== undefined && b.stt !== null) ? b.stt : 9999;
				if (sttA !== sttB) return sttA - sttB;
				if (a.code && b.code) return a.code.localeCompare(b.code);
				return 0;
			});
			
			renderTable();
			updateHeaderDates();

			// [QUAN TR·ªåNG] G·ªåI H√ÄM CHECK Y√äU C·∫¶U ·ªû ƒê√ÇY (SAU KHI C√ì employeesData)
			// Vi·ªác n√†y gi√∫p Badge ƒë·∫øm ƒë√∫ng s·ªë l∆∞·ª£ng c·ªßa nh√≥m hi·ªán t·∫°i
			checkPendingRequests();

		} catch (e) { console.error(e); alert("L·ªói t·∫£i d·ªØ li·ªáu: " + e.message); }
		showLoading(false);
	}

    // ================= 5. RENDER UI =================
    function updateHeaderDates() {
        const row = document.getElementById("headerDatesRow");
        row.innerHTML = "";
        const start = new Date(currentWeekStart);
        let txt = "";
        for(let i=0; i<7; i++) {
            const d = new Date(start); d.setDate(start.getDate() + i);
            const s = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
            row.innerHTML += `<th>${s}</th>`;
            if(i==0) txt += "Tu·∫ßn t·ª´ " + s; if(i==6) txt += " ƒë·∫øn " + s + "/" + d.getFullYear();
        }
        document.getElementById("weekRangeDisplay").innerText = txt;
    }

    // ================= 5. RENDER UI (C√ì C·∫¢NH B√ÅO ƒê∆†N NGH·ªà + ·∫®N/HI·ªÜN C·ªòT) =================
	function renderTable() {
		const tbody = document.getElementById("scheduleBody");
		tbody.innerHTML = "";
		
		// --- 1. LOGIC KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN HI·ªÇN TH·ªä ---
		const showPOld = employeesData.some(e => e.pn_old > 0);
		const showPNew = employeesData.some(e => e.pn > 0);      
		const showBOld = employeesData.some(e => e.nb_old > 0);
		const showBNew = employeesData.some(e => e.nb > 0);      

		// --- 2. ·∫®N/HI·ªÜN TI√äU ƒê·ªÄ C·ªòT (THEADER) ---
		if(document.getElementById("th_p_old")) document.getElementById("th_p_old").style.display = showPOld ? "table-cell" : "none";
		if(document.getElementById("th_p_new")) document.getElementById("th_p_new").style.display = showPNew ? "table-cell" : "none";
		if(document.getElementById("th_b_old")) document.getElementById("th_b_old").style.display = showBOld ? "table-cell" : "none";
		if(document.getElementById("th_b_new")) document.getElementById("th_b_new").style.display = showBNew ? "table-cell" : "none";

		// --- 3. T√çNH NG√ÄY TH√ÅNG ƒê·ªÇ SO S√ÅNH (Cho t√≠nh nƒÉng C·∫£nh b√°o ƒë∆°n ngh·ªâ) ---
		const [yStr, mStr, dStr] = currentWeekStart.split('-');
		const yVal = parseInt(yStr), mVal = parseInt(mStr), dVal = parseInt(dStr);

		// --- 4. V·∫º D√íNG D·ªÆ LI·ªÜU ---
		employeesData.forEach((emp, rIdx) => {
			const tr = document.createElement("tr");
			tr.setAttribute("data-code", emp.code);
			tr.onclick = () => handleRowClick(rIdx);
			if(isSwapMode) tr.classList.add("swap-mode-hover");
			if(isSwapMode && rIdx === swapSourceIdx) tr.classList.add("row-swap-selected");

			let html = `
				<td style="text-align:center;">${rIdx+1}</td>
				
				<td class="emp-code" 
					title="Nh·∫•p ƒë√∫p chu·ªôt ƒë·ªÉ s·ª≠a th√¥ng tin" 
					ondblclick="openEditEmpPopup(${rIdx}, event)" 
					style="font-weight:600; font-family:monospace; color:#555; font-size:20px; cursor:pointer;">
					${emp.code}
				</td>
				
				<td class="emp-name" 
					title="Nh·∫•p ƒë√∫p chu·ªôt ƒë·ªÉ s·ª≠a th√¥ng tin" 
					ondblclick="openEditEmpPopup(${rIdx}, event)" 
					style="text-align:left; padding-left:10px; font-weight:600; font-size:20px; cursor:pointer;">
					${emp.name}
				</td>
				
				<td ondblclick="openEditEmpPopup(${rIdx}, event)" style="cursor:pointer;">
					<span style="background:#eef2ff; color:#4f46e5; padding:2px 6px; border-radius:4px; font-size:20px; font-weight:600;">${emp.role||""}</span>
				</td>
			`;
			
			// --- [QUAN TR·ªåNG] V√íNG L·∫∂P RENDER 7 NG√ÄY ---
			emp.shifts.forEach((s, cIdx) => {
				const conf = SHIFTS.find(x => x.code === s) || {cls:""};
				
				// A. X√°c ƒë·ªãnh ng√†y c·ªßa √¥ n√†y ƒë·ªÉ ƒë·ªëi chi·∫øu v·ªõi requestsData
				const dObj = new Date(yVal, mVal - 1, dVal + cIdx);
				const dateISO = `${dObj.getFullYear()}-${String(dObj.getMonth()+1).padStart(2,'0')}-${String(dObj.getDate()).padStart(2,'0')}`;

				// B. T√¨m xem c√≥ ƒë∆°n ch·ªù duy·ªát n√†o kh√¥ng (requestsData ƒë√£ l·∫•y ·ªü h√†m loadSchedule)
				const pendingReq = (typeof requestsData !== 'undefined') 
					? requestsData.find(r => r.emp_code === emp.code && r.date === dateISO) 
					: null;

				// C. T·∫°o c√°c thu·ªôc t√≠nh HTML cho c·∫£nh b√°o
				let extraClass = "";
				let extraAttrs = "";
				let tooltip = "";

				if (pendingReq) {
					extraClass = "cell-request-pending"; // Class t·∫°o tam gi√°c cam
					extraAttrs = `data-req-id="${pendingReq.id}" data-req-type="${pendingReq.type}" data-req-reason="${pendingReq.reason}"`;
					tooltip = ` title="üìù C√≥ ƒë∆°n xin ngh·ªâ: ${pendingReq.type} - L√Ω do: ${pendingReq.reason}"`;
				}

				// D. Render √¥
				html += `<td class="shift ${conf.cls} ${extraClass}" 
							${extraAttrs} ${tooltip}
							onclick="openMenu(this, ${rIdx}, ${cIdx})"
						>${s}</td>`;
			});
			
			const total = parseFloat((emp.pn + emp.nb + emp.pn_old + emp.nb_old).toFixed(2));

			// --- RENDER C√ÅC √î S·ªê LI·ªÜU ---
			html += `
				<td style="color:#7f8c8d; background:#f8f9fa; font-weight:500; display: ${showPOld ? 'table-cell' : 'none'}">
					${emp.pn_old}
				</td>
				
				<td style="color:#d35400; font-weight:bold; display: ${showPNew ? 'table-cell' : 'none'}">
					${emp.pn}
				</td>
				
				<td style="color:#7f8c8d; background:#f8f9fa; font-weight:500; display: ${showBOld ? 'table-cell' : 'none'}">
					${emp.nb_old}
				</td>
				
				<td style="color:#2980b9; font-weight:bold; display: ${showBNew ? 'table-cell' : 'none'}">
					${emp.nb}
				</td>
				
				<td style="background-color:#fffcf5; color:#c0392b; font-weight:900;">${total}</td>
				
				<td style="padding: 0; height: 100%;">
					<input type="text" 
						value="${emp.note || ''}" 
						onchange="updateEmpNote(${rIdx}, this.value)" 
						placeholder="..."
						style="
							width: 100%; 
							height: 100%;       
							border: none; 
							outline: none; 
							background: transparent; 
							padding: 0 5px;     
							text-align: center; 
							box-sizing: border-box;
							margin: 0;          
							display: block;     
							line-height: 38px;  
						">
				</td>
				
				<td><button class="btn-d" style="padding:2px 6px;" onclick="removeRow(${rIdx}); event.stopPropagation();">X</button></td>
			`;
			tr.innerHTML = html;
			tbody.appendChild(tr);
		});
	}

    // ================= 6. T√çNH NƒÇNG ƒê·∫¢O (SWAP) =================
    function toggleSwapMode() {
        isSwapMode = !isSwapMode;
        swapSourceIdx = -1; // Reset
        
        const btn = document.getElementById("btnSwap");
        if(isSwapMode) {
            btn.classList.add("btn-swap-active");
            alert("ƒê√£ b·∫≠t ch·∫ø ƒë·ªô ƒê·∫¢O V·ªä TR√ç.\n\nC√°ch d√πng: B·∫•m v√†o ng∆∞·ªùi th·ª© 1, sau ƒë√≥ b·∫•m v√†o ng∆∞·ªùi th·ª© 2 ƒë·ªÉ ƒë·ªïi ch·ªó.");
        } else {
            btn.classList.remove("btn-swap-active");
        }
        renderTable();
    }

    async function handleRowClick(idx) {
        if(!isSwapMode) return;

        if (swapSourceIdx === -1) {
            // --- CH·ªåN NG∆Ø·ªúI TH·ª® 1 ---
            swapSourceIdx = idx;
            renderTable(); // ƒê·ªÉ hi·ªÉn th·ªã highlight
        } else if (swapSourceIdx === idx) {
            // B·∫•m l·∫°i ng∆∞·ªùi ƒë√≥ -> B·ªè ch·ªçn
            swapSourceIdx = -1;
            renderTable();
        } else {
			// --- CH·ªåN NG∆Ø·ªúI TH·ª® 2 -> TH·ª∞C HI·ªÜN ƒê·∫¢O ---
			saveUndoState();
			
			const emp1 = employeesData[swapSourceIdx];
			const emp2 = employeesData[idx];

			// 1. ƒê·ªïi v·ªã tr√≠ trong m·∫£ng hi·ªÉn th·ªã (Local - ƒë·ªÉ UI c·∫≠p nh·∫≠t ngay)
			employeesData[swapSourceIdx] = emp2;
			employeesData[idx] = emp1;

			// 2. T√≠nh to√°n STT c·∫ßn tr√°o ƒë·ªïi
			// (N·∫øu stt b·ªã null th√¨ g√°n t·∫°m b·∫±ng index ƒë·ªÉ kh√¥ng b·ªã l·ªói)
			const stt1 = (emp1.stt !== null && emp1.stt !== undefined) ? emp1.stt : swapSourceIdx;
			const stt2 = (emp2.stt !== null && emp2.stt !== undefined) ? emp2.stt : idx;

			// Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang l∆∞u
			const btn = document.getElementById("btnSwap");
			const oldText = btn.innerText;
			btn.innerText = "‚è≥ ƒêang l∆∞u...";

			try {
				// --- C·∫¨P NH·∫¨T ƒê·ªíNG TH·ªúI C·∫¢ 2 B·∫¢NG ---
				
				// A. C·∫≠p nh·∫≠t b·∫£ng G·ªëc (Employees) -> ƒê·ªÉ tu·∫ßn sau t·∫°o m·ªõi s·∫Ω ƒë√∫ng th·ª© t·ª± n√†y
				const p1 = _supabase.from('employees').update({ stt: stt2 }).eq('code', emp1.code);
				const p2 = _supabase.from('employees').update({ stt: stt1 }).eq('code', emp2.code);

				// B. C·∫≠p nh·∫≠t b·∫£ng L·ªãch (Schedule) -> ƒê·ªÉ tu·∫ßn hi·ªán t·∫°i F5 l·∫°i v·∫´n ƒë√∫ng
				// Quan tr·ªçng: Ph·∫£i c√≥ ƒëi·ªÅu ki·ªán .eq('week_start', currentWeekStart)
				const p3 = _supabase.from('schedule')
					.update({ stt: stt2 })
					.eq('week_start', currentWeekStart)
					.eq('emp_code', emp1.code);
					
				const p4 = _supabase.from('schedule')
					.update({ stt: stt1 })
					.eq('week_start', currentWeekStart)
					.eq('emp_code', emp2.code);

				// Ch·∫°y t·∫•t c·∫£ song song ƒë·ªÉ t·ªëc ƒë·ªô nhanh nh·∫•t
				await Promise.all([p1, p2, p3, p4]);

				// C·∫≠p nh·∫≠t l·∫°i stt trong bi·∫øn c·ª•c b·ªô (RAM)
				emp1.stt = stt2;
				emp2.stt = stt1;

				showToastNotification("‚úÖ ƒê√£ ƒë·∫£o v·ªã tr√≠ v√† l∆∞u th√†nh c√¥ng!");

			} catch (e) {
				console.error(e);
				alert("L·ªói khi l∆∞u v·ªã tr√≠: " + e.message);
				// N·∫øu l·ªói DB th√¨ load l·∫°i b·∫£ng ƒë·ªÉ ho√†n t√°c giao di·ªán v·ªÅ c≈© (tr√°nh sai l·ªách)
				loadSchedule();
			} finally {
				// Reset tr·∫°ng th√°i
				swapSourceIdx = -1;
				isSwapMode = false;
				btn.classList.remove("btn-swap-active");
				btn.innerText = oldText; 
				renderTable();
			}
		}
    }

    // ================= 6. L∆ØU L·ªäCH (C√ì TR·ª™ PH√âP/B√ô KHI S·ª¨ D·ª§NG) =================
	const LEAVE_CODES_LIST = ["P", "P/2", "NB", "NB/2", "0.5NB", "NC", "√î", "Te", "L", "NM"];

	// H√†m ph·ª• tr·ª£: T√≠nh t·ªïng s·ªë c√¥ng Ph√©p/B√π (ƒê·∫∑t h√†m n√†y RA NGO√ÄI h√†m saveSchedule)
	function calculateUsage(shifts) {
		let p = 0, b = 0;
		if (Array.isArray(shifts)) {
			shifts.forEach(s => {
				const code = s ? s.toUpperCase() : "";
				// T√≠nh P
				if (code === "P" || code === "P (1.0)") p += 1.0;
				if (code === "P/2" || code === "0.5P") p += 0.5;
				
				// T√≠nh NB
				if (code === "NB" || code === "NB (1.0)") b += 1.0;
				if (code === "NB/2" || code === "0.5NB") b += 0.5;
			});
		}
		return { p, b };
	}

	// ==========================================
	// H√ÄM L∆ØU L·ªäCH (ƒê√É S·ª¨A L·ªñI LOGIC & TH·ª® T·ª∞)
	// ==========================================
	async function saveSchedule(isSilent = false) {
		// --- [M·ªöI] KI·ªÇM TRA C·∫¢NH B√ÅO L√ÄM VI·ªÜC LI√äN T·ª§C ---
		if (!isSilent) { 
			const warningList = checkContinuousWorkWarning();
			if (warningList.length > 0) {
				const msg = "‚ö†Ô∏è C·∫¢NH B√ÅO QU√Å S·ª®C!\n\n" +
							"C√°c nh√¢n vi√™n sau ƒëang l√†m vi·ªác 7 ng√†y li√™n t·ª•c:\n" +
							warningList.join("\n") + 
							"\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u kh√¥ng?";
				if (!confirm(msg)) return; 
			}
		}
		
		if (!isSilent) showLoading(true);
		const statusSpan = document.getElementById("autoSaveStatus");
		if (statusSpan) statusSpan.innerText = "‚è≥ ƒêang ƒë·ªìng b·ªô...";

		try {
			console.log("--- B·∫ÆT ƒê·∫¶U L∆ØU ---");

			// 1. T·∫£i d·ªØ li·ªáu tham chi·∫øu
			const [y, m, d] = currentWeekStart.split('-').map(Number);
			const currentYear = y;
			const prevYear = currentYear - 1;
			
			const nextYear = currentYear + 1;
			const pnExpireDate = `${nextYear}-03-31`; 
			const nbExpireDate = `${nextYear}-06-30`;

			// --- [QUAN TR·ªåNG] T·∫¢I D·ªÆ LI·ªÜU TR∆Ø·ªöC KHI D√ôNG ---
			const [holidaysRes, historyRes, oldScheduleRes, balancesRes] = await Promise.all([
				_supabase.from('holidays').select('*'),
				_supabase.from('supplemental_leave').select('reason, emp_code, type'),
				_supabase.from('schedule').select('emp_code, shifts').eq('week_start', currentWeekStart).eq('group_name', currentGroup),
				// L·∫•y s·ªë d∆∞ c·ªßa c·∫£ NƒÇM NAY v√† NƒÇM NGO√ÅI
				_supabase.from('leave_balance').select('*').in('year', [currentYear, prevYear])
			]);

			const holidays = holidaysRes.data || [];
			const history = historyRes.data || [];
			const oldScheduleData = oldScheduleRes.data || [];
			const balances = balancesRes.data || []; // ƒê·ªãnh nghƒ©a balances ·ªü ƒë√¢y

			// --- [QUAN TR·ªåNG] T·∫†O MAP D·ªÆ LI·ªÜU SAU KHI ƒê√É T·∫¢I ---
			const balCurrent = {}; 
			const prevBalMap = {};   
			
			if (balances.length > 0) {
				balances.forEach(b => {
					if (b.year === currentYear) balCurrent[b.emp_code] = b;
					if (b.year === prevYear) prevBalMap[b.emp_code] = b;
				});
			}

			// Map Ng√†y l·ªÖ
			const hMap = {};
			holidays.forEach(h => {
				const parts = h.date.split('-'); 
				const d = parseInt(parts[2], 10);
				const m = parseInt(parts[1], 10);
				hMap[`${d}/${m}`] = { val: Number(h.value)||1, note: h.note };
			});

			// Check ng√†y 15
			let autoPhepReason = null; 
			let target15Date = null;

			for(let i=0; i<7; i++) {
				const dLoop = new Date(y, m - 1, d + i); 
				if (dLoop.getDate() === 15) {
					autoPhepReason = `Ph√©p th√°ng ${dLoop.getMonth()+1}/${dLoop.getFullYear()}`;
					target15Date = new Date(dLoop);
					target15Date.setHours(0,0,0,0);
					break; 
				}
			}

			const schUpsert = [], supInsert = [], balUpsert = [];
			const requestsToCancel = [];

			// 3. DUY·ªÜT T·ª™NG NH√ÇN VI√äN
			employeesData.forEach(emp => {
				// A. L·∫§Y D·ªÆ LI·ªÜU THAM CHI·∫æU
				const oldRec = oldScheduleData.find(x => x.emp_code === emp.code);
				const oldShifts = oldRec ? oldRec.shifts : [];

				// L·∫•y s·ªë d∆∞ hi·ªán t·∫°i (Live) t·ª´ Map ƒë√£ t·∫°o ·ªü tr√™n
				let liveBal = balCurrent[emp.code] || { pn_val: 0, nb_val: 0, pn_old_val: 0, nb_old_val: 0 };
				
				const prevData = prevBalMap[emp.code];
				const maxPNOld = prevData ? (Number(prevData.pn_val) || 0) : 0;
				const maxNBOld = prevData ? (Number(prevData.nb_val) || 0) : 0;

				// ==========================================
				// LOGIC T√çNH TO√ÅN "HO√ÄN T√ÅC & T√çNH L·∫†I"
				// ==========================================

				// B. B∆Ø·ªöC 1: HO√ÄN T√ÅC (REVERT) - C·ªông tr·∫£ l·∫°i nh·ªØng g√¨ ƒë√£ tr·ª´
				const usedOld = calculateUsage(oldShifts);
				
				let basePNOld = Number(liveBal.pn_old_val) || 0;
				let basePNNew = Number(liveBal.pn_val) || 0;
				
				// Ho√†n t√°c Ph√©p (PN)
				let totalPRefund = usedOld.p; 
				const spaceInOldP = maxPNOld - basePNOld; 
				if (spaceInOldP > 0) {
					const amountToOld = Math.min(totalPRefund, spaceInOldP);
					basePNOld += amountToOld;
					totalPRefund -= amountToOld;
				}
				basePNNew += totalPRefund;

				// Ho√†n t√°c B√π (NB)
				let baseNBOld = Number(liveBal.nb_old_val) || 0;
				let baseNBNew = Number(liveBal.nb_val) || 0;
				let totalBRefund = usedOld.b;
				
				const spaceInOldB = maxNBOld - baseNBOld;
				if (spaceInOldB > 0) {
					const amountToOld = Math.min(totalBRefund, spaceInOldB);
					baseNBOld += amountToOld;
					totalBRefund -= amountToOld;
				}
				baseNBNew += totalBRefund;
				
				// --- X·ª¨ L√ù C·ªòNG PH√âP TH√ÅNG / B√ô L·ªÑ ---
				// (ƒêo·∫°n n√†y th√™m v√†o base... tr∆∞·ªõc khi tr·ª´ ƒëi c√°i m·ªõi)
				let addedNB = 0, addedPN = 0;

				// Logic c·ªông ph√©p th√°ng 15
				if (autoPhepReason && target15Date) {
					let isEligible = true;
					if (emp.join_date) {
						const joinDate = new Date(emp.join_date);
						joinDate.setHours(0,0,0,0);
						const diffDays = Math.ceil((target15Date - joinDate) / (1000 * 60 * 60 * 24));
						if (diffDays < 15) isEligible = false;
					}
					if (isEligible) {
						const hasMonthlyLeave = history.some(h => h.emp_code === emp.code && h.type === 'PN' && h.reason && h.reason.includes(autoPhepReason));
						if (!hasMonthlyLeave) {
							addedPN += 1.0;
							supInsert.push({ emp_code: emp.code, type: 'PN', amount: 1.0, reason: autoPhepReason, date: new Date() });
						}
					}
				}

				// Logic c·ªông b√π l·ªÖ
				emp.shifts.forEach((s, idx) => {
					const dObj = new Date(y, m - 1, d + idx);
					const key = `${dObj.getDate()}/${dObj.getMonth()+1}`;
					const fullDateStr = `${String(dObj.getDate()).padStart(2,'0')}/${String(dObj.getMonth()+1).padStart(2,'0')}/${dObj.getFullYear()}`;
					
					// C√°c m√£ ca ƒë∆∞·ª£c t√≠nh c√¥ng l·ªÖ
					if(hMap[key] && ["S","C","HC","S1","CT","S+","NC"].includes(s)) {
						const hInfo = hMap[key];
						const reasonCheck = `(${fullDateStr})-(${hInfo.note})`; 
						const isPaid = history.some(h => h.emp_code === emp.code && h.type === 'NB' && h.reason && h.reason.includes(reasonCheck));
						if(!isPaid) {
							addedNB += hInfo.val;
							supInsert.push({ emp_code: emp.code, type: 'NB', amount: hInfo.val, reason: `B√π Ng√†y L·ªÖ ${reasonCheck}`, date: new Date() });
						}
					}
				});

				// C·ªông th√™m v√†o qu·ªπ
				basePNNew += addedPN;
				baseNBNew += addedNB;

				// --- X·ª¨ L√ù H·ª¶Y ƒê∆†N KHI S·ª¨A L·ªäCH ---
				emp.shifts.forEach((newS, idx) => {
					const oldS = oldShifts[idx] || "";
					// N·∫øu c≈© l√† Ngh·ªâ, m√† m·ªõi kh√°c c≈© -> H·ªßy ƒë∆°n
					const LEAVE_CODES = ["P", "P/2", "NB", "NB/2", "0.5NB", "NC", "√î", "Te", "L", "NM"];
					const wasLeave = LEAVE_CODES.some(c => oldS === c || oldS.startsWith(c));
					
					if (wasLeave && newS !== oldS) {
						const dObj = new Date(y, m - 1, d + idx);
						const dateISO = `${dObj.getFullYear()}-${String(dObj.getMonth()+1).padStart(2,'0')}-${String(dObj.getDate()).padStart(2,'0')}`;
						requestsToCancel.push({ emp_code: emp.code, date: dateISO });
					}
				});

				// C. B∆Ø·ªöC 2: T√çNH TO√ÅN TI√äU TH·ª§ M·ªöI (APPLY NEW)
				const usedNew = calculateUsage(emp.shifts);

				// --- Tr·ª´ Ph√©p (PN) ---
				if (basePNOld >= usedNew.p) {
					basePNOld -= usedNew.p;
				} else {
					const remain = usedNew.p - basePNOld;
					basePNOld = 0;
					basePNNew -= remain;
				}

				// --- Tr·ª´ B√π (NB) ---
				if (baseNBOld >= usedNew.b) {
					baseNBOld -= usedNew.b;
				} else {
					const remain = usedNew.b - baseNBOld;
					baseNBOld = 0;
					baseNBNew -= remain;
				}

				// D. G√ÅN GI√Å TR·ªä CU·ªêI C√ôNG V√ÄO OBJECT
				emp.pn = parseFloat(basePNNew.toFixed(2));
				emp.pn_old = parseFloat(basePNOld.toFixed(2));
				emp.nb = parseFloat(baseNBNew.toFixed(2));
				emp.nb_old = parseFloat(baseNBOld.toFixed(2));

				// E. ƒê·∫®Y V√ÄO M·∫¢NG UPDATE
				schUpsert.push({
					week_start: currentWeekStart, 
					group_name: currentGroup,
					emp_code: emp.code, 
					emp_name: emp.name, 
					emp_role: emp.role,
					shifts: emp.shifts, 
					nb_new: emp.nb, 
					pn_new: emp.pn,
					nb_old: emp.nb_old, 
					pn_old: emp.pn_old,
					stt: (emp.stt !== undefined && emp.stt !== null) ? emp.stt : 9999,
					note: emp.note || "",
					last_modifier_id: MY_CLIENT_ID
				});

				balUpsert.push({ 
					emp_code: emp.code, year: currentYear, 
					nb_val: emp.nb, pn_val: emp.pn,
					pn_old_val: emp.pn_old, nb_old_val: emp.nb_old,
					pn_expire: pnExpireDate, nb_expire: nbExpireDate
				});
			});

			const promises = [
				_supabase.from('weeks').upsert({ group_name: currentGroup, week_start: currentWeekStart, week_range: document.getElementById("weekRangeDisplay").innerText }, { onConflict: 'group_name, week_start' }),
				_supabase.from('schedule').upsert(schUpsert, { onConflict: 'week_start, emp_code' }),
				_supabase.from('leave_balance').upsert(balUpsert, { onConflict: 'emp_code, year' })
			];

			if (supInsert.length > 0) promises.push(_supabase.from('supplemental_leave').insert(supInsert));

			await Promise.all(promises);

			// H·ªßy ƒë∆°n
			if (requestsToCancel.length > 0) {
				const cancelPromises = requestsToCancel.map(req => 
					_supabase.from('leave_requests')
						.update({ 
							status: 'H·ªßy b·ªüi Admin',
							reason: `Admin s·ª≠a l·ªãch tr·ª±c ti·∫øp (H·ªßy)`
						})
						.eq('emp_code', req.emp_code)
						.eq('date', req.date)
						.in('status', ['Ch·ªù duy·ªát', 'ƒê√£ duy·ªát']) 
				);
				await Promise.all(cancelPromises);
			}

			if (statusSpan) {
				statusSpan.innerText = "‚úÖ ƒê√£ l∆∞u t·ª± ƒë·ªông";
				setTimeout(() => statusSpan.innerText = "", 3000);
			}

			if (!isSilent) {
				let msg = "ƒê√£ l∆∞u th√†nh c√¥ng!";
				if (autoPhepReason) msg += `\n(+1.0 Ph√©p th√°ng 15)`;
				alert(msg);
			}
			
			localStorage.setItem("LAST_WEEK_" + currentGroup, currentWeekStart);
			if (!isSilent) loadSchedule(); 

		} catch(e) { 
			console.error(e); 
			if (statusSpan) statusSpan.innerText = "‚ùå L·ªói l∆∞u!";
			if (!isSilent) alert("L·ªói l∆∞u: " + e.message); 
		}
		if (!isSilent) showLoading(false);
		
		// C·∫≠p nh·∫≠t b·∫£ng t·ªïng h·ª£p (n·∫øu ƒëang m·ªü)
		const container = document.getElementById("summaryContainer");
		if (container && container.style.display !== 'none') {
			updateDetailSummary();
		}
	}
	
	// H√†m ph·ª• tr·ª£: T√≠nh t·ªïng s·ªë c√¥ng Ph√©p/B√π trong danh s√°ch ca
	function calculateUsage(shifts) {
		let p = 0, b = 0;
		if (Array.isArray(shifts)) {
			shifts.forEach(s => {
				const code = s ? s.toUpperCase() : "";
				// T√≠nh P
				if (code === "P" || code === "P (1.0)") p += 1.0;
				if (code === "P/2" || code === "0.5P") p += 0.5;
				
				// T√≠nh NB
				if (code === "NB" || code === "NB (1.0)") b += 1.0;
				if (code === "NB/2" || code === "0.5NB") b += 0.5;
			});
		}
		return { p, b };
	}

    // ================= 8. MENU & KEYBOARD =================
    //let currentCell = null, selectedR = -1, selectedC = -1;
    //let copiedVal = null;

    // ================= 8. MENU & KEYBOARD (ƒê√É N√ÇNG C·∫§P DUY·ªÜT NHANH) =================
	function openMenu(cell, r, c) {
		if(isSwapMode) return; // ƒêang ƒë·∫£o th√¨ kh√¥ng hi·ªán menu

		currentCell = cell; selectedR = r; selectedC = c;

		// Highlight √¥ ƒëang ch·ªçn
		if(document.querySelector('.selected')) document.querySelector('.selected').classList.remove('selected');
		cell.classList.add('selected');

		const menu = document.getElementById("shiftMenu");
		let html = ""; // Kh·ªüi t·∫°o chu·ªói HTML

		// --- [PH·∫¶N M·ªöI] 1. KI·ªÇM TRA & HI·ªÇN TH·ªä N√öT DUY·ªÜT ƒê∆†N ---
		// Ki·ªÉm tra xem √¥ n√†y c√≥ ƒë∆°n ch·ªù duy·ªát kh√¥ng (d·ª±a v√†o class m√† renderTable ƒë√£ th√™m)
		if (cell.classList.contains("cell-request-pending")) {
			// L·∫•y d·ªØ li·ªáu t·ª´ dataset (ƒë√£ g√°n trong renderTable)
			const type = cell.dataset.reqType || "P";
			const reason = cell.dataset.reqReason || "Kh√¥ng c√≥ l√Ω do";
			const reqId = cell.dataset.reqId;

			// Ch√®n HTML hi·ªÉn th·ªã th√¥ng tin ƒë∆°n + N√∫t duy·ªát
			html += `
			<div style="padding: 10px; font-size: 13px; color: #d35400; background: #fff8e1; border-bottom: 1px solid #f0e6ce; line-height: 1.4; text-align: left;">
				<div style="font-weight:bold; margin-bottom:4px;">üîî C√≥ ƒë∆°n xin ngh·ªâ: <span style="color:#c0392b">${type}</span></div>
				<div style="font-style:italic; color:#555;">"${reason}"</div>
			</div>
			
			<button onclick="approveAndSet('${type}', '${reqId}')" class="btn-approve-quick" style="
				background-color: #e3f2fd !important;
				color: #1976d2 !important;
				border: 1px dashed #1976d2 !important;
				font-weight: bold;
				margin: 5px;
				width: calc(100% - 10px); /* Tr·ª´ margin ƒë·ªÉ n√∫t c√¢n ƒë·ªëi */
				text-align: left;
				padding-left: 10px;
			">
				‚úÖ Duy·ªát & G√°n ${type} ngay
			</button>
			
			<div style="height: 1px; background: #eee; margin: 5px 0;"></div>
			`;
		}
		// -------------------------------------------------------

		// --- 2. HI·ªÇN TH·ªä DANH S√ÅCH C√ÅC CA (SHIFTS) ---
		html += SHIFTS.map(s => 
			`<button onclick="setShift('${s.code}', '${s.cls}')">
				<span class="menu-badge ${s.cls}">${s.code||'X'}</span> ${s.label}
			</button>`
		).join("");
		
		// G√°n n·ªôi dung v√†o menu
		menu.innerHTML = html;
		
		// --- 3. ƒê·ªäNH V·ªä MENU ---
		const rect = cell.getBoundingClientRect();
		
		// Logic: N·∫øu menu m·ªü ·ªü g·∫ßn ƒë√°y m√†n h√¨nh qu√° th√¨ ƒë·∫©y n√≥ l√™n tr√™n √¥ ƒë·ªÉ kh√¥ng b·ªã che
		menu.style.display = "block"; // Ph·∫£i hi·ªán tr∆∞·ªõc m·ªõi t√≠nh ƒë∆∞·ª£c chi·ªÅu cao
		const menuHeight = menu.offsetHeight;
		const windowHeight = window.innerHeight;
		
		let topPos = rect.bottom + window.scrollY;
		
		// N·∫øu menu b·ªã tr√†n xu·ªëng d∆∞·ªõi m√†n h√¨nh -> Hi·ªÉn th·ªã ph√≠a tr√™n √¥
		if (rect.bottom + menuHeight > windowHeight) {
			topPos = (rect.top + window.scrollY) - menuHeight;
		}

		menu.style.left = rect.left + "px";
		menu.style.top = topPos + "px";
		
		// [QUAN TR·ªåNG] Focus v√†o n√∫t ƒë·∫ßu ti√™n ngay khi m·ªü
		// (N·∫øu c√≥ n√∫t Duy·ªát th√¨ n√≥ s·∫Ω focus n√∫t Duy·ªát, n·∫øu kh√¥ng th√¨ focus n√∫t ca ƒë·∫ßu ti√™n)
		const firstBtn = menu.querySelector("button");
		if(firstBtn) firstBtn.focus();
	}


	// ch·ªçn ca
	
	// Th√™m c√°c bi·∫øn t·∫°m ƒë·ªÉ l∆∞u tr·∫°ng th√°i khi m·ªü popup
	let pendingNbCode = "";
	let pendingNbCls = "";
	let pendingNbDateStr = "";
	
    // Danh s√°ch c√°c m√£ c·∫ßn c·∫£nh b√°o khi b·ªã thay ƒë·ªïi
    const WARN_CODES = ["NB", "NB/2", "P", "P/2"];

    function setShift(code, cls) {
		if(!currentCell) return;

        // [M·ªöI] B∆Ø·ªöC 0: KI·ªÇM TRA S·ªê D∆Ø TR∆Ø·ªöC KHI G√ÅN
        // N·∫øu ch·ªçn P ho·∫∑c NB th√¨ check xem c√≥ ƒë·ªß kh√¥ng
        const safetyCheck = checkBalanceSafe(selectedR, code);
        if (!safetyCheck.ok) {
            // Hi·ªán c·∫£nh b√°o. N·∫øu user b·∫•m Cancel (H·ªßy) th√¨ d·ª´ng l·∫°i.
            if (!confirm(safetyCheck.msg + "\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën g√°n kh√¥ng?")) {
                return; // D·ª´ng, kh√¥ng l√†m g√¨ c·∫£
            }
        }

		// --- B∆Ø·ªöC 1: T√çNH TO√ÅN NG√ÄY ƒêANG CH·ªåN ---
		const wDate = new Date(currentWeekStart);
		const targetDate = new Date(wDate);
		targetDate.setDate(wDate.getDate() + selectedC);
		pendingNbDateStr = formatDateISO(targetDate); 

		// C·∫≠p nh·∫≠t b·∫£ng t·ªïng h·ª£p (n·∫øu ƒëang m·ªü)
        const container = document.getElementById("summaryContainer");
        if (container && container.style.display !== 'none') {
            updateDetailSummary();
        }

		// --- B∆Ø·ªöC 2: PH√ÇN LO·∫†I X·ª¨ L√ù ---
		if (code.includes("NB")) {
			pendingNbCode = code;
			pendingNbCls = cls;
			const emp = employeesData[selectedR];
			openNbSourcePopup(emp.code, emp.name, pendingNbDateStr, code);
			document.getElementById("shiftMenu").style.display = "none";
			return; 
		}

		if (code.includes("P")) {
			const val = (code.includes("/2") || code.includes("0.5")) ? 0.5 : 1.0;
			const reason = "Admin nh·∫≠p tr·ª±c ti·∫øp (Ph√©p nƒÉm)";
			applyShiftToCell(code, cls, reason, val);
			document.getElementById("shiftMenu").style.display = "none";
			return;
		}

		applyShiftToCell(code, cls);
		document.getElementById("shiftMenu").style.display = "none";
	}

	// ================= T√çNH NƒÇNG CH·ªåN NGU·ªíN B√ô (ADMIN) =================

	async function openNbSourcePopup(empCode, empName, dateStr, type) {
		console.log("--- B·∫ÆT ƒê·∫¶U M·ªû POPUP NGU·ªíN B√ô (FIXED) ---");
		// ... (Gi·ªØ nguy√™n ph·∫ßn reset giao di·ªán) ...
		const popup = document.getElementById("nbSourcePopup");
		const listDiv = document.getElementById("nbSourceList");
		
		document.getElementById("nbTargetCode").innerText = `${empName} (${empCode})`;
		document.getElementById("nbTargetDate").innerText = dateStr.split('-').reverse().join('/');
		document.getElementById("nbTargetType").innerText = type;
		document.getElementById("nbCalcStatus").innerText = "...";
		
		popup.style.display = "flex";
		listDiv.innerHTML = '<div style="padding:10px; text-align:center;">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>';

		try {
			// --- QUERY 1 & 2: GI·ªÆ NGUY√äN ---
			const resSource = await _supabase.from('supplemental_leave').select('*').eq('emp_code', empCode).eq('type', 'NB');
			const resHistory = await _supabase.from('leave_requests').select('reason, type, status, val').eq('emp_code', empCode); // L·∫•y th√™m c·ªôt 'val' n·∫øu c√≥

			if (resSource.error || resHistory.error) {
				listDiv.innerHTML = `<div style="color:red; padding:10px;">L·ªói t·∫£i d·ªØ li·ªáu.</div>`; return;
			}

			// --- X·ª¨ L√ù D·ªÆ LI·ªÜU (ƒê√É S·ª¨A) ---
			listDiv.innerHTML = "";
			const sources = resSource.data || [];
			const history = resHistory.data || [];

			if (sources.length === 0) {
				listDiv.innerHTML = '<div style="padding:15px; color:#999; text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu ngu·ªìn.</div>'; return;
			}

			let countAvailable = 0;

			sources.forEach(src => {
				let used = 0;
				const d = new Date(src.date);
				const dKey = `${d.getDate()}/${d.getMonth()+1}`; // VD: 14/12
				
				// 1. T·∫°o 2 lo·∫°i ch·ªØ k√Ω ƒë·ªÉ ki·ªÉm tra
				const signatureText = `${dKey} - ${src.reason}`; // C√°ch c≈©: Theo t√™n
				const signatureID = `[REF:${src.id}]`;           // C√°ch m·ªõi: Theo ID (Ch√≠nh x√°c 100%)

				// 2. Qu√©t l·ªãch s·ª≠ ƒë·ªÉ t√≠nh ƒë√£ d√πng bao nhi√™u
				history.forEach(h => {
					if (h.status !== 'T·ª´ ch·ªëi' && h.reason) {
						// Ki·ªÉm tra: N·∫øu l√Ω do ch·ª©a ID HO·∫∂C ch·ª©a T√™n c≈©
						const isMatchID = h.reason.includes(signatureID);
						const isMatchText = h.reason.includes(signatureText);

						if (isMatchID || isMatchText) {
							// ∆Øu ti√™n l·∫•y gi√° tr·ªã th·ª±c t·ª´ DB (h.val) n·∫øu c√≥, kh√¥ng th√¨ ƒëo√°n theo type
							let val = h.val !== undefined ? h.val : (h.type.includes("/2") || h.type.includes("0.5") ? 0.5 : 1.0);
							used += val;
						}
					}
				});

				const remaining = parseFloat(src.amount) - used;
				// console.log(`Src: ${src.id} | Used: ${used} | Remain: ${remaining}`);

				if (remaining > 0) {
					countAvailable++;
					const div = document.createElement("div");
					div.className = "src-item-row";
					div.style.cssText = "display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee; cursor:pointer;";
					
					// Click v√†o div c≈©ng ch·ªçn ƒë∆∞·ª£c checkbox
					div.onclick = (e) => {
						if (e.target.type !== 'checkbox') {
							const cb = div.querySelector('input');
							cb.checked = !cb.checked;
							calcNbSelection(); // H√†m t√≠nh to√°n t·ªïng
						}
					};

					div.innerHTML = `
						<div style="display:flex; align-items:center; width: 100%;">
							<input type="checkbox" class="nb-src-cb" 
								value="${src.id}" 
								data-text="${signatureText}" 
								data-amt="${remaining}" 
								onchange="calcNbSelection()" 
								style="margin: 0 12px 0 0; cursor: pointer; width: 18px; height: 18px; flex-shrink: 0;">
							
							<div style="display:flex; flex-direction: column;">
								<span style="font-weight:600; font-size:14px; color:#2c3e50; line-height: 1.4;">
									${signatureText} </span>
								<span style="font-weight:500; color:${remaining < 1 ? '#e67e22' : '#27ae60'}; font-size:12px;">
									(C√≤n: ${remaining} ng√†y)
								</span>
							</div>
						</div>
					`;
					listDiv.appendChild(div);
				}
			});

			if (countAvailable === 0) listDiv.innerHTML = '<div style="padding:15px; color:#e67e22; text-align:center;">ƒê√£ d√πng h·∫øt c√°c ngu·ªìn b√π!</div>';
			
			calcNbSelection();

		} catch (e) {
			console.error("‚ùå L·ªói JS:", e);
		}
	}

	// H√†m t√≠nh to√°n Realtime (ƒê·ªß/Thi·∫øu) - ƒê√É C·∫¨P NH·∫¨T T·ª∞ ƒê·ªòNG CHIA
	function calcNbSelection() {
		const statusDiv = document.getElementById("nbCalcStatus");
		
		// 1. X√°c ƒë·ªãnh l∆∞·ª£ng c·∫ßn (Needed)
		let needed = 1.0;
		if (pendingNbCode.includes("/2") || pendingNbCode.includes("0.5")) needed = 0.5;

		// 2. T√≠nh l∆∞·ª£ng ƒë√£ tick
		let selected = 0;
		const checkedBoxes = document.querySelectorAll(".nb-src-cb:checked");
		checkedBoxes.forEach(cb => {
			selected += parseFloat(cb.getAttribute("data-amt"));
		});
		
		// L√†m tr√≤n s·ªë ƒë·ªÉ tr√°nh l·ªói th·∫≠p ph√¢n
		selected = parseFloat(selected.toFixed(2));

		// 3. HI·ªÇN TH·ªä TR·∫†NG TH√ÅI (LOGIC M·ªöI)
		
		// Tr∆∞·ªùng h·ª£p A: Ch·ªçn v·ª´a ƒë·ªß (Ho√†n h·∫£o)
		if (selected === needed) {
			statusDiv.innerHTML = `‚úÖ ƒê√£ ch·ªçn: ${selected} / C·∫ßn: ${needed} (H·ª£p l·ªá)`;
			statusDiv.className = "status-ok";
		} 
		// Tr∆∞·ªùng h·ª£p B: Ch·ªçn 1 ngu·ªìn l·ªõn h∆°n nhu c·∫ßu (H·ªá th·ªëng s·∫Ω t·ª± c·∫Øt)
		// V√≠ d·ª•: C·∫ßn 0.5 nh∆∞ng ch·ªçn ngu·ªìn 1.0 -> OK
		else if (checkedBoxes.length === 1 && selected > needed) {
			const remain = selected - needed;
			statusDiv.innerHTML = `‚úÇÔ∏è T·ª± ƒë·ªông c·∫Øt: D√πng ${needed}, c√≤n d∆∞ ${remain} (H·ª£p l·ªá)`;
			statusDiv.className = "status-ok"; // Cho ph√©p m√†u xanh
		}
		// Tr∆∞·ªùng h·ª£p C: Ch·ªçn nhi·ªÅu ngu·ªìn b·ªã d∆∞ (Kh√¥ng cho ph√©p v√¨ kh√≥ ki·ªÉm so√°t)
		else if (checkedBoxes.length > 1 && selected > needed) {
			statusDiv.innerHTML = `‚ö†Ô∏è D∆∞: ${selected} / C·∫ßn: ${needed} (Vui l√≤ng b·ªè b·ªõt)`;
			statusDiv.className = "status-lack";
		} 
		// Tr∆∞·ªùng h·ª£p D: Thi·∫øu
		else {
			statusDiv.innerHTML = `‚ùå Thi·∫øu: ${selected} / C·∫ßn: ${needed} (Vui l√≤ng ch·ªçn th√™m)`;
			statusDiv.className = "status-lack";
		}
	}

	// H√†m x√°c nh·∫≠n v√† L∆∞u - ƒê√É C·∫¨P NH·∫¨T
	async function confirmNbSelection() {
		// 1. X√°c ƒë·ªãnh l·∫°i l∆∞·ª£ng c·∫ßn
		let needed = 1.0;
		if (pendingNbCode.includes("/2") || pendingNbCode.includes("0.5")) needed = 0.5;

		// 2. T√≠nh l∆∞·ª£ng ƒë√£ ch·ªçn
		let selected = 0;
		let reasons = [];
		const checkedBoxes = document.querySelectorAll(".nb-src-cb:checked");
		
		checkedBoxes.forEach(cb => {
			selected += parseFloat(cb.getAttribute("data-amt"));
			reasons.push(cb.value);
		});
		
		selected = parseFloat(selected.toFixed(2));

		// 3. VALIDATE (KI·ªÇM TRA)
		let isValid = false;
		
		// Ch·∫•p nh·∫≠n n·∫øu b·∫±ng nhau
		if (selected === needed) isValid = true;
		// Ch·∫•p nh·∫≠n n·∫øu ch·ªçn 1 c√°i l·ªõn h∆°n (Logic t·ª± chia)
		if (checkedBoxes.length === 1 && selected > needed) isValid = true;

		if (!isValid) {
			return alert(`L·ª±a ch·ªçn ch∆∞a h·ª£p l·ªá!\n- C·∫ßn: ${needed}\n- ƒêang ch·ªçn: ${selected}\n\n(Ch·ªâ ƒë∆∞·ª£c ph√©p ch·ªçn D∆Ø khi t√≠ch v√†o ƒë√∫ng 1 √¥ ngu·ªìn).`);
		}

		// 4. T·∫°o l√Ω do chi ti·∫øt
		// VD: "[B√π cho: 01/05 (Tr·ª±c l·ªÖ)] Admin nh·∫≠p tr·ª±c ti·∫øp"
		const finalReason = `[B√π cho: ${reasons.join(", ")}] ƒê∆∞·ª£c x·∫øp b·ªüi Admin`;

		// 5. ƒê√≥ng Popup
		closePopup('nbSourcePopup');

		// 6. G·ªåI H√ÄM L∆ØU CH√çNH TH·ª®C
		// Quan tr·ªçng: Truy·ªÅn tham s·ªë 'needed' (vd: 0.5) v√†o h√†m l∆∞u.
		// H·ªá th·ªëng s·∫Ω t·∫°o ƒë∆°n ngh·ªâ 0.5. 
		// V√¨ l√Ω do (finalReason) c√≥ ch·ª©a t√™n ngu·ªìn (VD: 01/05), n√™n l·∫ßn sau h·ªá th·ªëng t·ª± bi·∫øt ngu·ªìn ƒë√≥ ƒë√£ b·ªã tr·ª´ 0.5.
		applyShiftToCell(pendingNbCode, pendingNbCls, finalReason, needed);
	}

	// H√†m c·∫≠p nh·∫≠t v√†o √¥ (ƒê√£ n√¢ng c·∫•p ƒë·ªÉ x·ª≠ l√Ω t·∫°o Leave Request)
	async function applyShiftToCell(code, cls, customReason = null, customVal = null) {
		if (!currentCell) return;

		saveUndoState();

		// A. C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
		currentCell.className = `shift ${cls} selected`;
		currentCell.innerText = code;
		employeesData[selectedR].shifts[selectedC] = code;
		
		// V·∫Ω l·∫°i b·∫£ng (ƒë·ªÉ c·∫≠p nh·∫≠t c·ªôt T·ªïng)
		renderTable();

		// B. N·∫øu l√† NB/P -> T·ª∞ ƒê·ªòNG T·∫†O LEAVE REQUEST (ƒê√£ duy·ªát)
		// Vi·ªác n√†y gi√∫p h·ªá th·ªëng tr·ª´ kho qu·ªπ ch√≠nh x√°c v√†o ngu·ªìn ƒë√£ ch·ªçn
		if ((code.includes("NB") || code.includes("P")) && customReason) {
			
			const emp = employeesData[selectedR];
			const val = customVal || (code.includes("/2") ? 0.5 : 1.0);

			// Hi·ªÉn th·ªã loading nh·ªè
			const oldText = document.getElementById("autoSaveStatus")?.innerText;
			if(document.getElementById("autoSaveStatus")) document.getElementById("autoSaveStatus").innerText = "‚è≥ ƒêang t·∫°o ƒë∆°n...";

			try {
				// Insert v√†o b·∫£ng leave_requests
				const { error } = await _supabase.from('leave_requests').insert({
					emp_code: emp.code,
					emp_name: emp.name,
					type: code,
					date: pendingNbDateStr, // Ng√†y t√≠nh to√°n ·ªü setShift
					reason: customReason,
					val: val,
					status: 'ƒê√£ duy·ªát' // Duy·ªát lu√¥n v√¨ Admin nh·∫≠p
				});

				if (error) throw error;
				
				// Th√¥ng b√°o nh·ªè
				showToastNotification(`‚úÖ ƒê√£ t·∫°o ƒë∆°n ${code} th√†nh c√¥ng!`);

			} catch (e) {
				console.error("L·ªói t·∫°o ƒë∆°n:", e);
				alert("L·ªói khi l∆∞u ƒë∆°n ngh·ªâ: " + e.message);
			}
		}

		// C. L∆∞u l·ªãch ch√≠nh (Schedule Table)
		triggerAutoSave();
	}

    document.addEventListener("click", (e) => {
        if (!e.target.closest('.shift') && !e.target.closest('#shiftMenu')) {
            document.getElementById("shiftMenu").style.display = "none";
        }
    });

    // ================= 9. POPUP UTILS =================
    function formatDateISO(date) {
        const offset = date.getTimezoneOffset(); 
        const d = new Date(date.getTime() - (offset*60*1000)); 
        return d.toISOString().split('T')[0];
    }
    //function showLoading(x) { document.getElementById("loading").style.display = x ? "block" : "none"; }
    function closePopup(id) { document.getElementById(id).style.display='none'; }
    
    // --- 1. M·ªû POPUP V√Ä T·∫¢I DANH S√ÅCH TU·∫¶N ---
    async function openWeekPopup() {
        document.getElementById("weekPopup").style.display = "flex";
        
        // Reset c√°c √¥ nh·∫≠p li·ªáu
        const sel = document.getElementById("weekSelect");
        document.getElementById("newWeekPicker").value = "";
        sel.innerHTML = '<option value="">‚è≥ ƒêang t·∫£i danh s√°ch...</option>';

        try {
            // L·∫•y danh s√°ch tu·∫ßn t·ª´ Supabase (S·∫Øp x·∫øp m·ªõi nh·∫•t l√™n ƒë·∫ßu)
            const { data, error } = await _supabase
                .from('weeks')
                .select('*')
                .eq('group_name', currentGroup)
                .order('week_start', { ascending: false });

            if (error) throw error;

            sel.innerHTML = '<option value="">-- Ch·ªçn tu·∫ßn c√≥ s·∫µn --</option>';

            if (data && data.length > 0) {
                data.forEach(w => {
                    // Format ng√†y cho ƒë·∫πp (yyyy-mm-dd -> dd/mm/yyyy)
                    const d = new Date(w.week_start);
                    const dateStr = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
                    
                    const opt = document.createElement("option");
                    opt.value = w.week_start;
                    // Hi·ªÉn th·ªã: "Tu·∫ßn t·ª´ 01/12... (01/12/2025)"
                    opt.text = `${w.week_range} [Start: ${dateStr}]`;
                    sel.appendChild(opt);
                });
            } else {
                sel.innerHTML = '<option value="">(Ch∆∞a c√≥ tu·∫ßn n√†o ƒë∆∞·ª£c l∆∞u)</option>';
            }

        } catch (e) {
            console.error(e);
            sel.innerHTML = '<option value="">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</option>';
        }
    }

    // --- 2. X√ÅC NH·∫¨N CH·ªåN TU·∫¶N ---
    function confirmWeekSelection() {
        const selVal = document.getElementById("weekSelect").value;     
        const newVal = document.getElementById("newWeekPicker").value;  
        
        let finalDate = selVal || newVal;

        if (!finalDate) {
            return alert("Vui l√≤ng ch·ªçn m·ªôt tu·∫ßn t·ª´ danh s√°ch HO·∫∂C ch·ªçn ng√†y ƒë·ªÉ t·∫°o m·ªõi!");
        }
        
        if (newVal && !selVal) {
            const d = new Date(newVal);
            if (d.getDay() !== 1) {
                return alert("‚ö†Ô∏è Ng√†y b·∫Øt ƒë·∫ßu tu·∫ßn m·ªõi ph·∫£i l√† Th·ª© 2!");
            }
        }

        currentWeekStart = finalDate;
        
        // --- [M·ªöI] L∆ØU L·∫†I KHI CHUY·ªÇN TU·∫¶N ---
        localStorage.setItem("LAST_WEEK_" + currentGroup, currentWeekStart);

        closePopup('weekPopup');
        loadSchedule();
    }

    function openAddEmpPopup() {
        document.getElementById("newEmpCode").value = "";
        document.getElementById("newEmpName").value = "";
        document.getElementById("newEmpRole").value = "";
        document.getElementById("addEmpPopup").style.display = "flex";
        document.getElementById("newEmpCode").focus();
    }
    
    async function confirmAddEmployee() {
		const code = document.getElementById("newEmpCode").value.trim().toUpperCase(); 
		const name = document.getElementById("newEmpName").value.trim();
		const role = document.getElementById("newEmpRole").value.trim();

		if(!code || !name) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
		
		if(employeesData.some(e => e.code === code)) return alert("M√£ NV ƒë√£ hi·ªÉn th·ªã tr√™n b·∫£ng!");

		// --- [M·ªöI] T√çNH TO√ÅN STT TI·∫æP THEO ---
		// T√¨m s·ªë STT l·ªõn nh·∫•t hi·ªán c√≥ trong danh s√°ch
		let maxStt = 0;
		if (employeesData.length > 0) {
			// L·∫•y danh s√°ch STT, chuy·ªÉn null/undefined th√†nh 0
			const sttList = employeesData.map(e => (e.stt !== null && e.stt !== undefined) ? e.stt : 0);
			maxStt = Math.max(...sttList);
		}
		// Nh√¢n vi√™n m·ªõi s·∫Ω c√≥ STT = Max hi·ªán t·∫°i + 1
		const nextStt = maxStt + 1;

		showLoading(true);
		try {
			const { error } = await _supabase.from('employees').upsert({
				code: code, 
				name: name, 
				role: role, 
				group_name: currentGroup,
				status: 'active',
				stt: nextStt // <--- QUAN TR·ªåNG: L∆∞u STT m·ªõi v√†o Database ngay
			}, { onConflict: 'code' });

			if(error) throw error;

			// Th√™m v√†o m·∫£ng hi·ªÉn th·ªã ngay l·∫≠p t·ª©c
			employeesData.push({ 
				code, name, role, 
				
				stt: nextStt, // <--- C·∫≠p nh·∫≠t STT cho bi·∫øn local ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng ngay
				
				shifts: Array(7).fill(""), 
				pn: 0, nb: 0, pn_old: 0, nb_old: 0 
			});
			
			renderTable();
			closePopup('addEmpPopup');
			alert("‚úÖ ƒê√£ th√™m nh√¢n vi√™n th√†nh c√¥ng!");
			
		} catch(e) { console.error(e); alert("L·ªói: " + e.message); }
		showLoading(false);
	}

    function openBulkLeavePopup() {
        const listDiv = document.getElementById("blEmpList");
        listDiv.innerHTML = "";
        document.getElementById("checkAllBox").checked = true;
        
        employeesData.forEach(e => {
            listDiv.innerHTML += `
            <div class="emp-item">
                <label style="display:flex;align-items:center;width:100%;cursor:pointer;margin:0;">
                    <input type="checkbox" value="${e.code}" checked class="emp-checkbox" onchange="checkIndividualBulkLeave()">
                    <span><b>${e.code}</b> - ${e.name}</span>
                </label>
            </div>`;
        });
        document.getElementById("bulkLeavePopup").style.display = "flex";
    }

    function toggleCheckAll(source) {
        document.querySelectorAll(".emp-checkbox").forEach(cb => cb.checked = source.checked);
    }

    // [M·ªöI] H√†m ki·ªÉm tra tr·∫°ng th√°i checkbox con ƒë·ªÉ update checkbox T·ªïng
    function checkIndividualBulkLeave() {
        const all = document.querySelectorAll(".emp-checkbox");
        const checked = document.querySelectorAll(".emp-checkbox:checked");
        const chkAll = document.getElementById("checkAllBox");
        
        if (chkAll) {
            // N·∫øu s·ªë l∆∞·ª£ng tick = T·ªïng s·ªë l∆∞·ª£ng -> Tick √¥ T·ªïng
            // Ng∆∞·ª£c l·∫°i -> B·ªè tick √¥ T·ªïng
            chkAll.checked = (all.length > 0 && all.length === checked.length);
        }
    }

    async function submitBulkLeave() {
        const type = document.getElementById("blType").value;
        const amount = document.getElementById("blAmount").value;
        const reason = document.getElementById("blReason").value;
        const checks = document.querySelectorAll(".emp-checkbox:checked");
        
        if(checks.length === 0 || !amount || !reason) return alert("Thi·∫øu th√¥ng tin!");

        showLoading(true);
        const payload = [];
        checks.forEach(cb => {
            payload.push({ emp_code: cb.value, type, amount, reason, date: new Date() });
            const emp = employeesData.find(e => e.code === cb.value);
            if(emp) {
                if(type==='NB') emp.nb += Number(amount);
                else emp.pn += Number(amount);
            }
        });

        await _supabase.from('supplemental_leave').insert(payload);
        
        const upserts = employeesData.map(e => ({
            emp_code: e.code, year: new Date(currentWeekStart).getFullYear(), nb_val: e.nb, pn_val: e.pn
        }));
        await _supabase.from('leave_balance').upsert(upserts, { onConflict: 'emp_code, year' });

        alert("ƒê√£ c·ªông th√†nh c√¥ng!");
        closePopup('bulkLeavePopup');
        renderTable();
        showLoading(false);
    }

    // X√ìA NH√ÇN VI√äN Vƒ®NH VI·ªÑN
    async function removeRow(idx) {
        const emp = employeesData[idx];
        if(!emp) return;
        
        // H·ªèi x√°c nh·∫≠n k·ªπ h∆°n
        if(confirm(`‚ö†Ô∏è X√ÅC NH·∫¨N:\n\nƒê√°nh d·∫•u nh√¢n vi√™n [${emp.name}] l√† ƒê√É NGH·ªà VI·ªÜC?\n\n- Nh√¢n vi√™n s·∫Ω b·ªã ·∫©n kh·ªèi l·ªãch tu·∫ßn sau.\n- D·ªØ li·ªáu l·ªãch s·ª≠ c≈© v·∫´n ƒë∆∞·ª£c gi·ªØ l·∫°i.`)) {
            showLoading(true);
            try {
                // 1. X√≥a kh·ªèi l·ªãch tu·∫ßn hi·ªán t·∫°i (ƒë·ªÉ d√≤ng bi·∫øn m·∫•t ngay)
                await _supabase.from('schedule').delete().eq('week_start', currentWeekStart).eq('emp_code', emp.code);
                
                // 2. C·∫≠p nh·∫≠t tr·∫°ng th√°i 'inactive' trong b·∫£ng employees (Thay v√¨ delete)
                const { error } = await _supabase
                    .from('employees')
                    .update({ status: 'inactive' }) 
                    .eq('code', emp.code);
                
                if(error) throw error;
                
                alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i nh√¢n vi√™n ${emp.name} th√†nh "ƒê√£ ngh·ªâ".`);
                
                employeesData.splice(idx, 1);
                renderTable();
            } catch(e) { console.error(e); alert("L·ªói c·∫≠p nh·∫≠t: "+e.message); }
            showLoading(false);
        }
    }

    // ================= C·∫§U H√åNH D·ªÆ LI·ªÜU B·∫¢NG NOTE (TH·ªêNG K√ä) =================
	// B·∫°n c√≥ th·ªÉ s·ª≠a ƒë·ªïi text hi·ªÉn th·ªã ·ªü ƒë√¢y
	const EXPORT_SUMMARY_CONFIG = [
		{ title: "Th·ª© 2 Ca S+: Ch√†o c·ªù", codes: ["S+", "S"] }, // D√≤ng 1: T√≠nh c·∫£ S v√† S+ v√†o Th·ª© 2
		{ title: "Ca S1: (06h30-14h30). Ngh·ªâ gi·ªØa ca 45 ph√∫t", codes: ["S1"] },
		{ title: "Ca S: (8h00-16h00). Ngh·ªâ gi·ªØa ca 45 ph√∫t", codes: ["S"] },
		{ title: "Ca C: (15h00-23h00). Ngh·ªâ gi·ªØa ca 45 ph√∫t", codes: ["C"] },
		{ title: "Ca HC: (8h00-17h00). Ngh·ªâ gi·ªØa ca 60 ph√∫t", codes: ["HC"] },
		{ title: "Ngh·ªâ n·ªØa ca, bu·ªïi: P/2, NB/2", codes: ["P/2", "NB/2", "0.5"] },
		{ title: "Ngh·ªâ ca: NC", codes: ["NC"] },
		{ title: "Ngh·ªâ ph√©p: P, NB", codes: ["P", "NB"] },
		{ title: "Ngh·ªâ kh√¥ng l∆∞∆°ng: KL", codes: ["KL"] },
		{ title: "Ngh·ªâ L·ªÖ: L", codes: ["L"] },
		{ title: "Ngh·ªâ: ·ªêm, Con ·ªëm: √î", codes: ["√î", "CO"] }
	];

	async function exportToExcel() {
        // 1. ƒê·ªäNH NGHƒ®A B·∫¢NG M√ÄU
        const LOCAL_COLOR_MAP = {
            "ca-s": "FFFFFF", "ca-s1": "FFFFFF", "ca-s-plus": "F8CBAD",
            "ca-c": "92D050", "ca-hc": "FFFFFF", "ca-nc": "FFFF00",
            "ca-p": "FF0000", "ca-nb": "FF0000", "ca-ct": "9BC2E6",
            "ca-kl": "9BC2E6", "ca-o": "9BC2E6", "ca-te": "FF0000",
            "ca-l": "FF0000", "ca-nm": "9BC2E6"
        };

        const configs = (typeof EXPORT_SUMMARY_CONFIG !== 'undefined') ? EXPORT_SUMMARY_CONFIG : [
             { title: "Ca S", codes: ["S"] }, { title: "Ca C", codes: ["C"] } 
        ];

        const wb = XLSX.utils.book_new();
        const wsData = []; 

        // --- PH·∫¶N 1: TI√äU ƒê·ªÄ L·ªöN ---
        //wsData.push(["L·ªäCH L√ÄM VI·ªÜC"]);
		
		const LLVTUAN = document.getElementById("groupNameDisplay");

		const LLVTUANText = LLVTUAN ? LLVTUAN.innerText.toUpperCase() : "";

		wsData.push([`L·ªäCH L√ÄM VI·ªÜC ${LLVTUANText}`.trim()]);
		
        const weekEl = document.getElementById("weekRange") || document.getElementById("weekRangeDisplay");
        const weekText = weekEl ? weekEl.innerText : "Tu·∫ßn l√†m vi·ªác";
        wsData.push([weekText]);        
        wsData.push([]);                

        // --- [QUAN TR·ªåNG] X√ÅC ƒê·ªäNH C·ªòT S·ªê D∆Ø C·∫¶N HI·ªÇN TH·ªä ---
		const pOldEl = document.getElementById("cardPOld") || document.getElementById("lblPOld"); 
		const bOldEl = document.getElementById("cardBOld") || document.getElementById("lblBOld");
		
		// Ki·ªÉm tra xem th·∫ª c√≥ b·ªã ·∫©n (display: none) kh√¥ng
		const showPOld = employeesData.some(e => e.pn_old > 0); // Check theo d·ªØ li·ªáu th·ª±c t·∫ø gi·ªëng h√†m renderTable
		const showBOld = employeesData.some(e => e.nb_old > 0); // Check theo d·ªØ li·ªáu th·ª±c t·∫ø gi·ªëng h√†m renderTable

        // 1. L·∫•y n·ªôi dung ch·ªØ t·ª´ c√°c th·∫ª ti√™u ƒë·ªÅ tr√™n b·∫£ng (ƒë·ªÉ l·∫•y ƒë∆∞·ª£c s·ªë nƒÉm 2024, 2025...)
		// S·ª≠ d·ª•ng trim() ƒë·ªÉ lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a n·∫øu c√≥
		const txtPOld = document.getElementById("th_p_old") ? document.getElementById("th_p_old").innerText.trim() : "PH√âP C≈®";
		const txtPNew = document.getElementById("th_p_new") ? document.getElementById("th_p_new").innerText.trim() : "PH√âP M·ªöI";
		const txtBOld = document.getElementById("th_b_old") ? document.getElementById("th_b_old").innerText.trim() : "B√ô C≈®";
		const txtBNew = document.getElementById("th_b_new") ? document.getElementById("th_b_new").innerText.trim() : "B√ô M·ªöI";

		// 2. X√¢y d·ª±ng danh s√°ch c·ªôt ƒë·ªông d·ª±a tr√™n text v·ª´a l·∫•y
		let balanceHeaders = [];
		if (showPOld) balanceHeaders.push(txtPOld); // S·∫Ω l√† "PH√âP 2024"
		balanceHeaders.push(txtPNew);               // S·∫Ω l√† "PH√âP 2025"
		if (showBOld) balanceHeaders.push(txtBOld); // S·∫Ω l√† "B√ô 2024"
		balanceHeaders.push(txtBNew);               // S·∫Ω l√† "B√ô 2025"
		balanceHeaders.push("T·ªîNG");

		// [M·ªöI] Th√™m c·ªôt Ghi ch√∫ v√†o danh s√°ch header ƒë·ªông (sau c·ªôt T·ªïng)
        balanceHeaders.push("GHI CH√ö");

        // T·ªïng s·ªë c·ªôt = 11 c·ªôt c·ªë ƒë·ªãnh (STT..CN) + s·ªë c·ªôt balance ƒë·ªông
        const totalCols = 11 + balanceHeaders.length;

        // --- PH·∫¶N 2: HEADER B·∫¢NG CH√çNH ---
        const headerThs = document.querySelectorAll("#headerDatesRow th");
        const dateHeaders = headerThs.length > 0 
            ? Array.from(headerThs).map(th => th.innerText) 
            : ["T2", "T3", "T4", "T5", "T6", "T7", "CN"];
        
        const headerRow = [
            "STT", "M√É NV", "H·ªå T√äN", "CH·ª®C V·ª§", 
            "T2", "T3", "T4", "T5", "T6", "T7", "CN", 
            ...balanceHeaders // Ch√®n c√°c c·ªôt ƒë·ªông v√†o ƒë√¢y
        ];
        wsData.push(headerRow);
        
        // D√≤ng ng√†y th√°ng: C·∫ßn th√™m √¥ tr·ªëng t∆∞∆°ng ·ª©ng s·ªë c·ªôt balance
        const emptyBalanceCells = new Array(balanceHeaders.length).fill("");
        wsData.push(["", "", "", "", ...dateHeaders, ...emptyBalanceCells]);

        // --- PH·∫¶N 3: D·ªÆ LI·ªÜU NH√ÇN VI√äN ---
        let maxRoleLength = 15; 

        if (typeof employeesData !== 'undefined' && Array.isArray(employeesData)) {
            employeesData.forEach((emp, index) => {
                const pNew = Number(emp.pn) || 0;
                const bNew = Number(emp.nb) || 0;
                const pOld = Number(emp.pn_old) || 0; 
                const bOld = Number(emp.nb_old) || 0; 
                const total = pNew + bNew + pOld + bOld;
                
                // T√≠nh ƒë·ªô r·ªông c·ªôt ch·ª©c v·ª•
                if (emp.role) {
                    const len = emp.role.toString().length;
                    if (len > maxRoleLength) maxRoleLength = len;
                }

                // X√¢y d·ª±ng d·ªØ li·ªáu s·ªë d∆∞ ƒë·ªông
                let balanceValues = [];
                if (showPOld) balanceValues.push(pOld);
                balanceValues.push(pNew);
                if (showBOld) balanceValues.push(bOld);
                balanceValues.push(bNew);
                balanceValues.push(total);
				
				// [M·ªöI] Th√™m d·ªØ li·ªáu Ghi ch√∫ v√†o cu·ªëi
                balanceValues.push(emp.note || "");

                wsData.push([index + 1, emp.code, emp.name, emp.role, ...emp.shifts, ...balanceValues]);
            });
        }
        maxRoleLength += 2;

        // --- PH·∫¶N 4: TI√äU ƒê·ªÄ NOTE ---
        wsData.push([]); 
        wsData.push(["", "NOTE :"]); 

        // --- PH·∫¶N 5: T√çNH TO√ÅN D·ªÆ LI·ªÜU NOTE ---
        let countMap = Array(configs.length).fill(0).map(() => Array(7).fill(0));

        if (typeof employeesData !== 'undefined' && Array.isArray(employeesData)) {
            employeesData.forEach(emp => {
                emp.shifts.forEach((code, dayIdx) => {
                    if (dayIdx >= 0 && dayIdx < 7 && code) {
                        const cleanCode = code.trim().toUpperCase();
                        configs.forEach((cfg, rIdx) => {
                            if (rIdx === 0 && dayIdx === 0 && (cleanCode === 'S' || cleanCode === 'S+')) {
                                countMap[rIdx][dayIdx]++;
                            }
                            else if (cfg.codes.includes(cleanCode)) {
                                if (rIdx === 2 && dayIdx === 0 && cleanCode === 'S') return;
                                countMap[rIdx][dayIdx]++;
                            }
                        });
                    }
                });
            });
        }

        configs.forEach((cfg, idx) => {
            const counts = countMap[idx];
            wsData.push(["", "", cfg.title, "", ...counts]); 
        });

        // ================= T·∫†O SHEET & STYLE =================
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // --- STYLE & MERGE ---
        const lastRowIdx = wsData.length - 1;
        const startNoteIdx = wsData.length - configs.length;
        const lastColIdx = totalCols - 1; // Ch·ªâ s·ªë c·ªôt cu·ªëi c√πng

        ws['!merges'] = [
            { s: {r:0, c:0}, e: {r:0, c:lastColIdx} }, // Merge Title
            { s: {r:1, c:0}, e: {r:1, c:lastColIdx} }, 
            
            { s: {r:3, c:0}, e: {r:4, c:0} }, 
            { s: {r:3, c:1}, e: {r:4, c:1} }, 
            { s: {r:3, c:2}, e: {r:4, c:2} }, 
            { s: {r:3, c:3}, e: {r:4, c:3} }, 
            
            // Merge Header Balance (ƒê·ªông)
            ...Array.from({length: balanceHeaders.length}, (_, i) => ({
                s: {r:3, c: 11 + i}, e: {r:4, c: 11 + i}
            })),

            { s: {r: startNoteIdx - 1, c:1}, e: {r: startNoteIdx - 1, c:3} }
        ];

        for(let i=0; i<configs.length; i++) {
            ws['!merges'].push({ s: {r: startNoteIdx+i, c:2}, e: {r: startNoteIdx+i, c:3} });
        }

        // --- STYLE CHI TI·∫æT ---
        const borderStyle = {
            top: {style: "thin"}, bottom: {style: "thin"},
            left: {style: "thin"}, right: {style: "thin"}
        };
        const centerStyle = { horizontal: "center", vertical: "center" };
        const fontBase = { name: "Times New Roman", sz: 11 };
        const fontBold = { name: "Times New Roman", sz: 11, bold: true };
        const fontTitle = { name: "Times New Roman", sz: 18, bold: true };
        const fontSubTitle = { name: "Times New Roman", sz: 14, bold: true };

        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cellRef = XLSX.utils.encode_cell({r: R, c: C});
                if (!ws[cellRef]) ws[cellRef] = {v: "", t: "s"};
                const cell = ws[cellRef];

                if (!cell.s) cell.s = {};
                cell.s.font = fontBase;

                // Title
                if (R === 0) cell.s = { font: fontTitle, alignment: centerStyle };
                if (R === 1) cell.s = { font: fontSubTitle, alignment: centerStyle };

                // Main Table
                const startMainRow = 3;
                const endMainRow = startNoteIdx - 3; 
                
                if (R >= startMainRow && R <= endMainRow) {
                    cell.s.border = borderStyle;
                    cell.s.alignment = centerStyle;
                    cell.s.font = fontBase;

                    if (R <= 4) { 
                        cell.s.fill = { fgColor: { rgb: "FFFFFF" } };
                        cell.s.font = fontBold; 
                    }
                    if (C === 2 && R > 4) cell.s.alignment = { horizontal: "left", vertical: "center" };
                    
					// t√¥ m√†u cho √¥ t·ª´ 11 tr·ªü ƒëi
					if (R <= 4 && C >= 11) {
						cell.s.fill = { fgColor: { rgb: "F4B084" } };
						//cell.s.font = fontBold;
						cell.s.alignment = { wrapText: "true", horizontal: "center", vertical: "center" };
					}
					
                    // T√¥ m√†u c√°c c·ªôt s·ªë d∆∞ (T·ª´ c·ªôt 11 tr·ªü ƒëi)
                    if (R > 4 && C >= 11) {
						cell.s.fill = { fgColor: { rgb: "EEEEEE" } };
						cell.s.font = fontBold;
					}

                    // T√¥ m√†u √¥ ca l√†m vi·ªác (C·ªôt 4 -> 10)
                    if (R > 4 && C >= 4 && C <= 10) {
                        cell.s.font = fontBold;
                        const val = String(cell.v).trim().toUpperCase();
                        const shiftInfo = SHIFTS.find(s => s.code.toUpperCase() === val);
                        if (shiftInfo && LOCAL_COLOR_MAP[shiftInfo.cls]) {
                            cell.s.fill = { fgColor: { rgb: LOCAL_COLOR_MAP[shiftInfo.cls] } };
                        }
                    }
                }

                // Note Title
                if (R === startNoteIdx - 1 && C === 1) {
                    cell.s = { font: { name: "Times New Roman", sz: 12, bold: true, underline: true } };
                }

                // Note Table
                if (R >= startNoteIdx) {
                    if (C >= 2 && C <= 10) {
                        if (!cell.s) cell.s = {};
                        cell.s.border = borderStyle;
                        cell.s.font = fontBase;

                        if (C === 2) { 
                            cell.s.alignment = { horizontal: "left", vertical: "center" };
                        } else if (C >= 4) { 
                            cell.s.alignment = centerStyle;
                            if (typeof cell.v === 'number' && cell.v > 0) cell.s.font = fontBold; 
                        }
                    }
                }
            }
        }

        // --- C. ƒê·ªò R·ªòNG C·ªòT ---
        let colWidths = [
            {wch: 5}, {wch: 10}, {wch: 25}, {wch: maxRoleLength}, 
            {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}
        ];
        // Th√™m ƒë·ªô r·ªông cho c√°c c·ªôt balance
        for(let i=0; i<balanceHeaders.length; i++) {
            colWidths.push({wch: 7.15});
        }
        ws['!cols'] = colWidths;

        XLSX.utils.book_append_sheet(wb, ws, "LichLamViec");
        //const fileName = weekText.replace(/[^a-zA-Z0-9]/g, "_") || "Lich_Lam_Viec";
        //XLSX.writeFile(wb, `${fileName}.xlsx`);

		// 1. L·∫•y t·∫•t c·∫£ c√°c c·ª•m s·ªë trong chu·ªói ra m·ªôt m·∫£ng
		const numbers = weekText.match(/\d+/g); 
		// K·∫øt qu·∫£ numbers s·∫Ω l√†: ["08", "12", "14", "12", "2025"]

		let fileName = "Lich_Lam_Viec"; // T√™n m·∫∑c ƒë·ªãnh
		
		let fileNameClean = LLVTUANText
			.normalize("NFD")                   // 1. T√°ch d·∫•u ra kh·ªèi ch·ªØ c√°i (v√≠ d·ª•: ·ª• -> u + d·∫•u n·∫∑ng)
			.replace(/[\u0300-\u036f]/g, "")    // 2. X√≥a c√°c k√Ω t·ª± d·∫•u v·ª´a t√°ch
			.replace(/ƒë/g, "d").replace(/ƒê/g, "D") // 3. X·ª≠ l√Ω ri√™ng ch·ªØ ƒë/ƒê (v√¨ h√†m tr√™n kh√¥ng b·∫Øt ƒë∆∞·ª£c)
			.replace(/\s+/g, "_");

		// 2. N·∫øu t√¨m th·∫•y ƒë·ªß d·ªØ li·ªáu ng√†y th√°ng
		if (numbers && numbers.length >= 5) {
			// numbers[0]: Ng√†y ƒë·∫ßu (08)
			// numbers[2]: Ng√†y cu·ªëi (14)
			// numbers[3]: Th√°ng cu·ªëi (12)
			// numbers[4]: NƒÉm (2025)
			
			// Gh√©p l·∫°i
			fileName = `${numbers[0]}.${numbers[1]} - ${numbers[2]}.${numbers[3]}.${numbers[4]}`;
		}

		// 3. L∆∞u file
		XLSX.writeFile(wb, `LLV-${fileNameClean}_${fileName}.xlsx`);
    }
	
	// ================= 10. T√çNH NƒÇNG DUY·ªÜT Y√äU C·∫¶U =================
    
    // G·ªçi h√†m n√†y ngay khi t·∫£i trang ƒë·ªÉ check th√¥ng b√°o
    document.addEventListener("DOMContentLoaded", () => {
        //checkPendingRequests();
        // ... (c√°c code kh·ªüi t·∫°o c≈© gi·ªØ nguy√™n)
    });

    // ================= KI·ªÇM TRA Y√äU C·∫¶U CH·ªú DUY·ªÜT (C√ì L·ªåC NH√ìM) =================
	async function checkPendingRequests() {
		try {
			// L·∫•y t·∫•t c·∫£ ƒë∆°n ch·ªù duy·ªát t·ª´ DB
			const { data, error } = await _supabase
				.from('leave_requests')
				.select('*')
				.eq('status', 'Ch·ªù duy·ªát')
				.order('created_at', { ascending: false });

			if (data) {
				// [S·ª¨A L·ªñI] L·ªçc ch·ªâ l·∫•y ƒë∆°n c·ªßa nh√¢n vi√™n ƒëang hi·ªÉn th·ªã tr√™n b·∫£ng
				// employeesData l√† bi·∫øn to√†n c·ª•c ch·ª©a danh s√°ch NV nh√≥m hi·ªán t·∫°i
				const currentGroupCodes = employeesData.map(e => e.code);
				
				// Ch·ªâ gi·ªØ l·∫°i ƒë∆°n c·ªßa nh√¢n vi√™n trong nh√≥m n√†y
				const filteredData = data.filter(req => currentGroupCodes.includes(req.emp_code));

				// 1. C·∫≠p nh·∫≠t Badge (S·ªë ƒë·ªè)
				const count = filteredData.length;
				const badge = document.getElementById("badgeReq");
				if (count > 0) {
					badge.innerText = count;
					badge.style.display = "inline-block";
					badge.parentElement.style.animation = "pulseBtn 1s"; 
					setTimeout(() => badge.parentElement.style.animation = "", 1000);
				} else {
					badge.style.display = "none";
				}
				
				// 2. L∆∞u v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ Popup d√πng
				window.pendingRequests = filteredData; 
				
				// 3. N·∫øu Popup ƒëang m·ªü -> V·∫Ω l·∫°i lu√¥n
				const popup = document.getElementById("approvalPopup");
				if(popup && popup.style.display === "flex") {
					renderRequestList();
				}
			}
		} catch (e) { console.error("L·ªói check y√™u c·∫ßu:", e); }
	}

    function openApprovalPopup() {
        document.getElementById("approvalPopup").style.display = "flex";
        renderRequestList();
    }

    function renderRequestList() {
        const tbody = document.getElementById("reqListBody");
        const msg = document.getElementById("noReqMsg");
        tbody.innerHTML = "";
        
        const list = window.pendingRequests || [];
        
        if (list.length === 0) {
            msg.style.display = "block";
        } else {
            msg.style.display = "none";
            list.forEach(req => {
                const d = new Date(req.date);
                const dateStr = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
                
                // Badge Class
                const badgeType = req.type.includes("P") ? "P" : "NB";

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td style="text-align:center; font-weight:700; color:var(--primary); font-family:monospace;">
                        ${req.emp_code}
                    </td>
                    <td style="text-align:left; padding-left:10px; font-weight:600;">
                        ${req.emp_name}
                    </td>
                    <td style="text-align:center;">${dateStr}</td>
                    <td style="text-align:center;">
                        <span class="bg-badge ${badgeType}">${req.type}</span>
                    </td>
                    <td style="text-align:left; padding-left:10px; color:#555; font-style:italic;">
                        ${req.reason || '-'}
                    </td>
                    <td style="text-align:center;">
                        <div style="display:flex; justify-content:center; gap:5px;">
                            <button class="btn-s" style="padding:4px 8px; font-size:11px;" onclick="processRequest(${req.id}, 'APPROVE', '${req.emp_code}', '${req.type}', '${req.date}')">‚úî Duy·ªát</button>
                            <button class="btn-d" style="padding:4px 8px; font-size:11px;" onclick="processRequest(${req.id}, 'REJECT', null, null, null)">‚úò T·ª´ ch·ªëi</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- X·ª¨ L√ù DUY·ªÜT / T·ª™ CH·ªêI ---
    async function processRequest(id, action, empCode, type, dateStr) {
        const msg = action === 'APPROVE' 
            ? "Duy·ªát y√™u c·∫ßu n√†y? \n(H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t l·ªãch v√† L∆ØU l·∫°i ngay l·∫≠p t·ª©c)" 
            : "T·ª´ ch·ªëi y√™u c·∫ßu n√†y?";
            
        if (!confirm(msg)) return;

        showLoading(true);
        try {
            const status = action === 'APPROVE' ? 'ƒê√£ duy·ªát' : 'T·ª´ ch·ªëi';
            
            // 1. C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n trong b·∫£ng leave_requests
            const { error } = await _supabase
                .from('leave_requests')
                .update({ status: status })
                .eq('id', id);

            if (error) throw error;

            // 2. N·∫æU DUY·ªÜT -> C·∫≠p nh·∫≠t l·ªãch v√† T·ª∞ ƒê·ªòNG L∆ØU
            if (action === 'APPROVE') {
                // D√πng await ƒë·ªÉ ƒë·ª£i l∆∞u xong m·ªõi t·∫£i l·∫°i danh s√°ch
                await updateAndAutoSave(empCode, type, dateStr);
            } else {
                alert("ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu!");
            }

            // 3. T·∫£i l·∫°i danh s√°ch y√™u c·∫ßu
            await checkPendingRequests();
            renderRequestList();
            
        } catch(e) {
            console.error(e);
            alert("L·ªói x·ª≠ l√Ω: " + e.message);
        } finally {
            showLoading(false);
        }
    }

    // --- H√ÄM C·∫¨P NH·∫¨T V√Ä T·ª∞ ƒê·ªòNG L∆ØU ---
    async function updateAndAutoSave(empCode, type, dateStr) {
        const reqDate = new Date(dateStr);
        const weekStart = new Date(currentWeekStart);
        
        // T√≠nh kho·∫£ng c√°ch ng√†y
        const diffTime = reqDate.getTime() - weekStart.getTime(); 
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        // A. N·∫øu ng√†y n·∫±m trong tu·∫ßn hi·ªán t·∫°i (0 -> 6)
        if (diffDays >= 0 && diffDays <= 6) {
            const empIndex = employeesData.findIndex(e => e.code === empCode);
            
            if (empIndex !== -1) {
                // 1. C·∫≠p nh·∫≠t m·∫£ng d·ªØ li·ªáu trong b·ªô nh·ªõ
                employeesData[empIndex].shifts[diffDays] = type;
                
                // 2. V·∫Ω l·∫°i b·∫£ng ƒë·ªÉ user th·∫•y ngay
                renderTable();
                
                // 3. G·ªåI H√ÄM L∆ØU L·ªäCH (T·ª± ƒë·ªông tr·ª´ ph√©p v√† l∆∞u DB)
                // L∆∞u √Ω: H√†m saveSchedule() s·∫Ω hi·ªán alert "ƒê√£ l∆∞u th√†nh c√¥ng" khi xong
                await saveSchedule(); 
                
            } else {
                alert(`‚ö†Ô∏è ƒê√£ duy·ªát ƒë∆°n, nh∆∞ng nh√¢n vi√™n [${empCode}] kh√¥ng c√≥ trong b·∫£ng l·ªãch tu·∫ßn n√†y n√™n kh√¥ng th·ªÉ t·ª± ƒë·ªông l∆∞u.`);
            }
        } 
        // B. N·∫øu ng√†y n·∫±m ·ªü tu·∫ßn kh√°c
        else {
            alert(`‚úÖ ƒê√£ duy·ªát tr·∫°ng th√°i ƒë∆°n cho ng√†y ${dateStr}.\n(Ng√†y n√†y kh√¥ng n·∫±m trong tu·∫ßn hi·ªán t·∫°i n√™n l·ªãch l√†m vi·ªác kh√¥ng thay ƒë·ªïi).`);
        }
    }

    // --- H√ÄM C·∫¨P NH·∫¨T L·ªäCH TR√äN GIAO DI·ªÜN ---
    function updateScheduleTable(empCode, type, dateStr) {
        // A. Ki·ªÉm tra ng√†y ƒë∆∞·ª£c duy·ªát c√≥ n·∫±m trong tu·∫ßn ƒëang m·ªü kh√¥ng
        const reqDate = new Date(dateStr);
        const weekStart = new Date(currentWeekStart);
        
        // T√≠nh kho·∫£ng c√°ch ng√†y (reqDate - weekStart)
        // K·∫øt qu·∫£ tr·∫£ v·ªÅ s·ªë mili-gi√¢y, chia cho (24h*60p*60s*1000ms) ƒë·ªÉ ra s·ªë ng√†y
        const diffTime = reqDate.getTime() - weekStart.getTime(); 
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        // B. N·∫øu ng√†y n·∫±m trong kho·∫£ng t·ª´ 0 (Th·ª© 2) ƒë·∫øn 6 (Ch·ªß nh·∫≠t)
        if (diffDays >= 0 && diffDays <= 6) {
            
            // T√¨m nh√¢n vi√™n trong m·∫£ng d·ªØ li·ªáu
            const empIndex = employeesData.findIndex(e => e.code === empCode);
            
            if (empIndex !== -1) {
                // 1. C·∫≠p nh·∫≠t d·ªØ li·ªáu trong m·∫£ng (Memory)
                employeesData[empIndex].shifts[diffDays] = type;
                
                // 2. V·∫Ω l·∫°i b·∫£ng ngay l·∫≠p t·ª©c ƒë·ªÉ th·∫•y thay ƒë·ªïi
                renderTable();
                
                // 3. Th√¥ng b√°o nh·∫Øc nh·ªü quan tr·ªçng
                alert(`‚úÖ ƒê√£ duy·ªát th√†nh c√¥ng!\n\nL·ªãch c·ªßa [${empCode}] ng√†y T${diffDays + 2} (ho·∫∑c CN) ƒë√£ chuy·ªÉn th√†nh [${type}].\n\n‚ö†Ô∏è L∆ØU √ù: B·∫°n c·∫ßn b·∫•m n√∫t "L∆ØU L·ªäCH" ƒë·ªÉ √°p d·ª•ng thay ƒë·ªïi n√†y vƒ©nh vi·ªÖn v√† tr·ª´ ph√©p.`);
            } else {
                alert(`‚ö†Ô∏è ƒê√£ duy·ªát ƒë∆°n, nh∆∞ng nh√¢n vi√™n [${empCode}] kh√¥ng c√≥ trong b·∫£ng l·ªãch tu·∫ßn n√†y n√™n kh√¥ng th·ªÉ t·ª± ƒë·ªông ƒë·ªïi ca.`);
            }
        } else {
            // Ng√†y ngh·ªâ n·∫±m ·ªü tu·∫ßn kh√°c (kh√¥ng ph·∫£i tu·∫ßn ƒëang m·ªü)
            alert(`‚úÖ ƒê√£ duy·ªát ƒë∆°n cho ng√†y ${dateStr}.\n(Ng√†y n√†y kh√¥ng n·∫±m trong tu·∫ßn hi·ªán t·∫°i n√™n kh√¥ng hi·ªÉn th·ªã tr√™n b·∫£ng).`);
        }
    }

    function updateScheduleFromRequest(empCode, type, dateStr) {
        // Ki·ªÉm tra xem ng√†y ngh·ªâ c√≥ n·∫±m trong tu·∫ßn ƒëang m·ªü kh√¥ng
        const reqDate = new Date(dateStr);
        const weekStart = new Date(currentWeekStart);
        
        // T√≠nh kho·∫£ng c√°ch ng√†y
        const diffTime = reqDate - weekStart;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        // N·∫øu ng√†y n·∫±m trong kho·∫£ng t·ª´ 0 (T2) ƒë·∫øn 6 (CN)
        if (diffDays >= 0 && diffDays <= 6) {
            const empIndex = employeesData.findIndex(e => e.code === empCode);
            if (empIndex !== -1) {
                // C·∫≠p nh·∫≠t m·∫£ng d·ªØ li·ªáu
                employeesData[empIndex].shifts[diffDays] = type;
                
                // V·∫Ω l·∫°i b·∫£ng
                renderTable();
                alert(`‚úÖ ƒê√£ duy·ªát v√† c·∫≠p nh·∫≠t l·ªãch cho nh√¢n vi√™n ${empCode} v√†o ng√†y T${diffDays + 2} (ho·∫∑c CN). \n\nüëâ Vui l√≤ng b·∫•m "L∆ØU L·ªäCH" ƒë·ªÉ h·ªá th·ªëng t√≠nh to√°n tr·ª´ ph√©p.`);
            } else {
                alert("‚úÖ ƒê√£ duy·ªát! (Nh√¢n vi√™n n√†y kh√¥ng c√≥ trong b·∫£ng l·ªãch hi·ªán t·∫°i)");
            }
        } else {
            alert(`‚úÖ ƒê√£ duy·ªát! \n(Ng√†y ngh·ªâ ${dateStr} kh√¥ng n·∫±m trong tu·∫ßn ƒëang m·ªü n√™n kh√¥ng hi·ªÉn th·ªã l√™n l·ªãch ngay l·∫≠p t·ª©c).`);
        }
    }
	
	// ================= 11. C·∫§U H√åNH REALTIME (ƒê√É S·ª¨A L·ªñI H·ª¶Y ƒê∆†N & L·ªåC NH√ìM) =================

	_supabase
		.channel('realtime-leave-requests') 
		.on(
			'postgres_changes', 
			{ event: '*', schema: 'public', table: 'leave_requests' }, 
			(payload) => {
				console.log('üîî Realtime Update:', payload);
				
				// --- TR∆Ø·ªúNG H·ª¢P 1: X√ìA (DELETE) - NH√ÇN VI√äN H·ª¶Y ƒê∆†N ---
				// V√¨ DELETE ch·ªâ tr·∫£ v·ªÅ ID, ta ph·∫£i ki·ªÉm tra xem ID ƒë√≥ c√≥ ƒëang hi·ªÉn th·ªã tr√™n m√†n h√¨nh kh√¥ng
				if (payload.eventType === 'DELETE') {
					const deletedId = payload.old.id;
					
					// Ki·ªÉm tra xem ID b·ªã x√≥a c√≥ n·∫±m trong:
					// 1. Danh s√°ch ch·∫•m ƒë·ªè tr√™n l·ªãch (requestsData)
					// 2. Ho·∫∑c danh s√°ch ch·ªù duy·ªát trong chu√¥ng (window.pendingRequests)
					const isRelevant = (requestsData && requestsData.some(r => r.id === deletedId)) || 
									   (window.pendingRequests && window.pendingRequests.some(r => r.id === deletedId));
					
					if (isRelevant) {
						console.log("‚ôªÔ∏è Ph√°t hi·ªán ƒë∆°n thu·ªôc nh√≥m n√†y b·ªã h·ªßy -> T·∫£i l·∫°i");
						checkPendingRequests(); // C·∫≠p nh·∫≠t s·ªë tr√™n chu√¥ng
						loadSchedule();         // C·∫≠p nh·∫≠t b·∫£ng (x√≥a ch·∫•m ƒë·ªè/tam gi√°c)
					}
					return; // X·ª≠ l√Ω xong DELETE th√¨ d·ª´ng, kh√¥ng ch·∫°y code d∆∞·ªõi
				}

				// --- TR∆Ø·ªúNG H·ª¢P 2: TH√äM / S·ª¨A (INSERT / UPDATE) ---
				// L·∫•y m√£ nh√¢n vi√™n t·ª´ d·ªØ li·ªáu m·ªõi
				const targetEmpCode = payload.new ? payload.new.emp_code : null;
				
				// Ki·ªÉm tra: Nh√¢n vi√™n n√†y c√≥ thu·ªôc nh√≥m ƒëang m·ªü kh√¥ng?
				// (employeesData l√† danh s√°ch NV hi·ªán t·∫°i tr√™n b·∫£ng)
				const isMyGroup = employeesData.some(e => e.code === targetEmpCode);

				if (!isMyGroup) return; // ‚õî N·∫øu l√† ƒë∆°n c·ªßa nh√≥m kh√°c -> B·ªè qua ngay

				// Logic th√¥ng b√°o (Ch·ªâ b√°o n·∫øu l√† ƒë∆°n m·ªõi Ch·ªù duy·ªát, b·ªè qua ƒë∆°n Admin t·ª± t·∫°o)
				if (payload.eventType === 'INSERT' && payload.new.status === 'Ch·ªù duy·ªát') {
					playNotificationSound();
					showToastNotification(`üîî C√≥ y√™u c·∫ßu m·ªõi t·ª´ ${payload.new.emp_name || 'Nh√¢n vi√™n'}!`);
				}

				// C·∫≠p nh·∫≠t l·∫°i giao di·ªán
				checkPendingRequests();
				loadSchedule(); 
			}
		)
		.subscribe();

	// ================= 12. C·∫§U H√åNH REALTIME CHO L·ªäCH & NH√ÇN VI√äN =================
    
    // ƒêƒÉng k√Ω l·∫Øng nghe thay ƒë·ªïi tr√™n b·∫£ng 'schedule' v√† 'employees'
    _supabase
        .channel('realtime-schedule-sync') 
        .on(
            'postgres_changes', 
            { event: '*', schema: 'public', table: 'schedule', filter: `group_name=eq.${currentGroup}` }, 
            (payload) => {
				// [QUAN TR·ªåNG] Ki·ªÉm tra xem tin nh·∫Øn n√†y c√≥ ph·∫£i do ch√≠nh m√¨nh g·ª≠i kh√¥ng
				if (payload.new && payload.new.last_modifier_id === MY_CLIENT_ID) {
					console.log('üôà B·ªè qua update do ch√≠nh m√¨nh t·∫°o ra.');
					return; // D·ª´ng l·∫°i ngay, kh√¥ng v·∫Ω l·∫°i b·∫£ng
				}
			
                console.log('üîî C√ì THAY ƒê·ªîI TR√äN L·ªäCH:', payload);

                // Ki·ªÉm tra xem thay ƒë·ªïi c√≥ thu·ªôc tu·∫ßn ƒëang xem kh√¥ng
                if (payload.new && payload.new.week_start === currentWeekStart) {
                    
                    // C·∫≠p nh·∫≠t d·ªØ li·ªáu v√†o bi·∫øn employeesData m√† KH√îNG c·∫ßn t·∫£i l·∫°i trang
                    const empCode = payload.new.emp_code;
                    const empIndex = employeesData.findIndex(e => e.code === empCode);

                    if (empIndex !== -1) {
                        // C·∫≠p nh·∫≠t ca l√†m vi·ªác
                        employeesData[empIndex].shifts = payload.new.shifts;
                        employeesData[empIndex].note = payload.new.note;
                        
                        // C·∫≠p nh·∫≠t s·ªë d∆∞ (n·∫øu c√≥ thay ƒë·ªïi)
                        employeesData[empIndex].pn = payload.new.pn_new;
                        employeesData[empIndex].nb = payload.new.nb_new;
                        employeesData[empIndex].pn_old = payload.new.pn_old;
                        employeesData[empIndex].nb_old = payload.new.nb_old;

                        // V·∫Ω l·∫°i b·∫£ng ngay l·∫≠p t·ª©c
                        renderTable();
                        
                        // Hi·ªáu ·ª©ng nh√°y d√≤ng ƒë·ªÉ b√°o hi·ªáu
                        highlightUpdatedRow(empIndex);
                    } else {
                        // Tr∆∞·ªùng h·ª£p nh√¢n vi√™n m·ªõi ƒë∆∞·ª£c th√™m v√†o l·ªãch -> T·∫£i l·∫°i to√†n b·ªô cho ch·∫Øc
                        loadSchedule();
                    }
                }
            }
        )
        .on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'employees', filter: `group_name=eq.${currentGroup}` },
            (payload) => {
                console.log('üîî C√ì THAY ƒê·ªîI TH√îNG TIN NH√ÇN VI√äN:', payload);
                // V·ªõi nh√¢n vi√™n, t·ªët nh·∫•t l√† t·∫£i l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t STT, T√™n, Ch·ª©c v·ª• chu·∫©n x√°c
                loadSchedule();
            }
        )
        .subscribe();

    // H√†m hi·ªáu ·ª©ng nh√°y d√≤ng khi c√≥ update
    function highlightUpdatedRow(idx) {
        const tbody = document.getElementById("scheduleBody");
        if (tbody && tbody.children[idx]) {
            const row = tbody.children[idx];
            row.style.transition = "background-color 0.5s";
            //row.style.backgroundColor = "#fff3cd"; // M√†u v√†ng nh·∫°t
            setTimeout(() => {
                row.style.backgroundColor = ""; // Tr·∫£ v·ªÅ b√¨nh th∆∞·ªùng
            }, 1000);
        }
    }

    // --- H√†m t·∫°o √¢m thanh "Ding" nh·∫π nh√†ng ---
    function playNotificationSound() {
        // T·∫°o √¢m thanh t·∫ßn s·ªë cao ng·∫Øn (gi·∫£ l·∫≠p ti·∫øng chu√¥ng)
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.type = "sine";
        osc.frequency.setValueAtTime(500, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
        
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
        
        osc.start();
        osc.stop(ctx.currentTime + 0.5);
    }

    // --- H√†m hi·ªán th√¥ng b√°o g√≥c m√†n h√¨nh (Toast) ---
    function showToastNotification(mess) {
        // T·∫°o th·∫ª div th√¥ng b√°o
        const div = document.createElement("div");
        div.style.position = "fixed";
        div.style.bottom = "20px";
        div.style.left = "20px"; // Hi·ªán g√≥c tr√°i d∆∞·ªõi
        div.style.background = "#333";
        div.style.color = "white";
        div.style.padding = "12px 20px";
        div.style.borderRadius = "8px";
        div.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";
        div.style.zIndex = "9999";
        div.style.fontSize = "14px";
        div.style.animation = "slideInLeft 0.5s forwards";
        div.innerText = mess;
        
        document.body.appendChild(div);

        // T·ª± bi·∫øn m·∫•t sau 4 gi√¢y
        setTimeout(() => {
            div.style.opacity = "0";
            div.style.transition = "opacity 0.5s";
            setTimeout(() => div.remove(), 500);
        }, 4000);
    }

    // Th√™m keyframe animation cho Toast
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `@keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }`;
    document.head.appendChild(styleSheet);
	
	// ================= T·ª∞ ƒê·ªòNG L∆ØU (AUTO-SAVE) =================
    let autoSaveTimer = null;

    function triggerAutoSave() {
        const statusSpan = document.getElementById("autoSaveStatus");
        
        // 1. B√°o hi·ªáu cho ng∆∞·ªùi d√πng bi·∫øt c√≥ thay ƒë·ªïi
        if (statusSpan) {
            statusSpan.innerText = "‚úçÔ∏è ƒêang ch·ªù l∆∞u...";
            statusSpan.style.color = "#d35400"; // M√†u cam
        }

        // 2. X√≥a b·ªô ƒë·∫øm c≈© (n·∫øu ng∆∞·ªùi d√πng ƒëang thao t√°c li√™n t·ª•c)
        if (autoSaveTimer) clearTimeout(autoSaveTimer);

        // 3. ƒê·∫∑t b·ªô ƒë·∫øm m·ªõi: ƒê·ª£i 3 gi√¢y (3000ms) r·ªìi m·ªõi L∆∞u
        autoSaveTimer = setTimeout(() => {
            // G·ªçi h√†m l∆∞u v·ªõi ch·∫ø ƒë·ªô im l·∫∑ng (true)
            saveSchedule(true); 
        }, 1000);
    }
	
	/* ===========================================================
	   T√çNH NƒÇNG: XU·∫§T EXCEL THEO KHO·∫¢NG TH·ªúI GIAN
	=========================================================== */
	
	function openExportRangePopup() {
		document.getElementById("exportRangePopup").style.display = "flex";
		
		// M·∫∑c ƒë·ªãnh ch·ªçn ng√†y 1 ƒë·∫øn cu·ªëi th√°ng hi·ªán t·∫°i
		const date = new Date();
		const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
		const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
		
		// H√†m format ng√†y th√†nh yyyy-MM-dd cho input type="date"
		const toInputStr = (d) => {
			const offset = d.getTimezoneOffset();
			const localDate = new Date(d.getTime() - (offset * 60 * 1000));
			return localDate.toISOString().split('T')[0];
		};
		
		// Ch·ªâ g√°n n·∫øu √¥ ƒëang tr·ªëng
		if(!document.getElementById("expFrom").value) document.getElementById("expFrom").value = toInputStr(firstDay);
		if(!document.getElementById("expTo").value) document.getElementById("expTo").value = toInputStr(lastDay);
	}
	
	// --- C·∫§U H√åNH M√ÄU S·∫ÆC CHO EXCEL ---
    const EXCEL_COLORS = {
        "S": "FFFFFF", "S1": "FFFFFF", "S+": "F8CBAD",
        "C": "92D050", "HC": "FFFFFF",
        "NB": "FF0000", "NB/2": "FF0000",
        "P": "FF0000", "P/2": "FF0000",
        "CT": "9BC2E6", "NC": "FFFF00",
        "√î": "9BC2E6", "Te": "FF0000", "L": "FF0000", "NM": "9BC2E6"
    };

    // H√†m h·ªó tr·ª£: T√¨m ng√†y th·ª© 2 ƒë·∫ßu tu·∫ßn c·ªßa m·ªôt ng√†y b·∫•t k·ª≥
    function getWeekStartOfDate(dateObj) {
        const d = new Date(dateObj);
        const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); // adjust when day is sunday
        const monday = new Date(d.setDate(diff));
        return formatDateISO(monday);
    }

    async function doExportRange() {
        const fromDStr = document.getElementById("expFrom").value;
        const toDStr = document.getElementById("expTo").value;
        
        if (!fromDStr || !toDStr) return alert("Vui l√≤ng ch·ªçn ng√†y!");
        if (fromDStr > toDStr) return alert("Ng√†y b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ng√†y k·∫øt th√∫c!");

		const btn = document.querySelector("#exportRangePopup .btn-s");
        const oldText = btn.innerText;
        //btn.innerText = "‚è≥ ƒêang x·ª≠ l√Ω..."; btn.disabled = true;
		showLoading(true);

        try {
            // 1. T·∫†O DANH S√ÅCH NG√ÄY & DANH S√ÅCH TU·∫¶N C·∫¶N L·∫§Y
            const dateHeaders = []; // ["01/10", "02/10",...]
            const dateList = [];    // [DateObj, DateObj,...]
            const weeksNeeded = new Set(); // Ch·ª©a c√°c ng√†y th·ª© 2 c·∫ßn query DB

            let curr = new Date(fromDStr);
            const end = new Date(toDStr);

            while (curr <= end) {
                dateList.push(new Date(curr));
                
                // Header hi·ªÉn th·ªã
                const dStr = `${String(curr.getDate()).padStart(2,'0')}/${String(curr.getMonth()+1).padStart(2,'0')}`;
                dateHeaders.push(dStr);

                // X√°c ƒë·ªãnh tu·∫ßn ch·ª©a ng√†y n√†y
                weeksNeeded.add(getWeekStartOfDate(curr));

                // TƒÉng 1 ng√†y
                curr.setDate(curr.getDate() + 1);
            }

            // 2. L·∫§Y D·ªÆ LI·ªÜU T·ª™ SUPABASE
            // A. L·∫•y nh√¢n vi√™n (Active)
            // [M·ªöI 1] Ki·ªÉm tra xem c√≥ t√≠ch ch·ªçn l·∫•y Inactive kh√¥ng
			const includeInactive = document.getElementById("chkIncludeInactive").checked;

			// A. X√¢y d·ª±ng Query l·∫•y nh√¢n vi√™n
			let empQuery = _supabase.from('employees')
				.select('code, name, role, stt') // L·∫•y th√™m stt
				.eq('group_name', currentGroup);

			// [M·ªöI 2] N·∫øu KH√îNG t√≠ch checkbox -> Ch·ªâ l·∫•y nh√¢n vi√™n Active
			// (Ng∆∞·ª£c l·∫°i n·∫øu t√≠ch -> L·∫•y t·∫•t c·∫£, kh√¥ng l·ªçc status)
			if (!includeInactive) {
				empQuery = empQuery.eq('status', 'active');
			}

			// [M·ªöI 3] S·∫Øp x·∫øp theo STT (ƒê·ªÉ gi·ªëng m√†n h√¨nh L·ªãch) thay v√¨ Code
			const empRes = await empQuery.order('stt', { ascending: true });

			if (empRes.error) throw empRes.error;
			const employees = empRes.data;

            // B. L·∫•y l·ªãch c·ªßa c√°c tu·∫ßn li√™n quan
            const weekArray = Array.from(weeksNeeded);
            const schRes = await _supabase.from('schedule')
                .select('week_start, emp_code, shifts')
                .eq('group_name', currentGroup)
                .in('week_start', weekArray);

            if (schRes.error) throw schRes.error;
            const schedules = schRes.data;

            // 3. X·ª¨ L√ù MAP D·ªÆ LI·ªÜU (ƒê·ªÉ tra c·ª©u cho nhanh)
            // Key: "2025-12-01_NV01" -> Value: ["S", "C", ...]
            const scheduleMap = {};
            schedules.forEach(s => {
                scheduleMap[`${s.week_start}_${s.emp_code}`] = s.shifts;
            });

            // 4. T·∫†O DATA CHO EXCEL
            // Header
            const wsData = [
                ["M√£ NV", "H·ªç T√™n", "Ch·ª©c V·ª•", ...dateHeaders]
            ];

            // Body
            employees.forEach(emp => {
                const row = [emp.code, emp.name, emp.role];

                // Duy·ªát qua t·ª´ng ng√†y c·∫ßn xu·∫•t
                dateList.forEach(dObj => {
                    const wStart = getWeekStartOfDate(dObj);
                    const key = `${wStart}_${emp.code}`;
                    
                    let cellValue = ""; 
                    
                    // N·∫øu c√≥ l·ªãch tu·∫ßn ƒë√≥
                    if (scheduleMap[key]) {
                        // T√≠nh xem ng√†y n√†y l√† th·ª© m·∫•y trong tu·∫ßn (0=T2, 6=CN)
                        const mon = new Date(wStart);
                        // S·ªë ng√†y l·ªách so v·ªõi th·ª© 2
                        const diffTime = dObj.getTime() - mon.getTime();
                        const diffDays = Math.round(diffTime / (1000 * 3600 * 24));
                        
                        if (diffDays >= 0 && diffDays <= 6) {
                            cellValue = scheduleMap[key][diffDays] || "";
                        }
                    }
                    row.push(cellValue);
                });

                wsData.push(row);
            });

            // 5. T·∫†O FILE V√Ä T√î M√ÄU
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // T√¥ m√†u (S·ª≠ d·ª•ng xlsx-js-style)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellRef = XLSX.utils.encode_cell({r: R, c: C});
                    if (!ws[cellRef]) continue;

                    const cell = ws[cellRef];
                    
                    // Style chung: Vi·ªÅn ƒëen m·ªèng
                    const baseStyle = {
                        border: {
                            top: { style: "thin" }, bottom: { style: "thin" },
                            left: { style: "thin" }, right: { style: "thin" }
                        },
                        font: { name: "Arial", sz: 11 }
                    };

                    // HEADER
                    if (R === 0) {
                        cell.s = { 
                            ...baseStyle,
                            fill: { fgColor: { rgb: "EEEEEE" } },
                            font: { bold: true }
                        };
                    } 
                    // DATA
                    else {
                        // 3 c·ªôt ƒë·∫ßu cƒÉn tr√°i, c√≤n l·∫°i cƒÉn gi·ªØa
                        if (C > 2) {
                            baseStyle.alignment = { horizontal: "center" };
                            const val = String(cell.v).toUpperCase().trim();
                            
                            // T√¨m m√†u trong map
                            let hexColor = "FFFFFF";
                            
                            // Check ch√≠nh x√°c ho·∫∑c check ch·ª©a (cho NB/2...)
                            if (EXCEL_COLORS[val]) hexColor = EXCEL_COLORS[val];
                            else if (val.includes("NB")) hexColor = EXCEL_COLORS["NB"];
                            else if (val.includes("P")) hexColor = EXCEL_COLORS["P"];
							else if (val.includes("TE")) hexColor = EXCEL_COLORS["TE"] || EXCEL_COLORS["Te"] || "FFC0CB";

                            cell.s = {
                                ...baseStyle,
                                fill: { fgColor: { rgb: hexColor } }
                            };
                        } else {
                            cell.s = baseStyle; // C·ªôt th√¥ng tin nh√¢n vi√™n kh√¥ng t√¥ m√†u
                        }
                    }
                }
            }

            // Ch·ªânh ƒë·ªô r·ªông c·ªôt
            const wscols = [{wch:10}, {wch:25}, {wch:15}]; // M√£, T√™n, CV
            for(let i=0; i<dateHeaders.length; i++) wscols.push({wch: 5}); // C·ªôt ng√†y nh·ªè l·∫°i
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, "BaoCaoLich");
            XLSX.writeFile(wb, `Lich_${currentGroup}_${fromDStr}_${toDStr}.xlsx`);
            
            document.getElementById("exportRangePopup").style.display = "none";

        } catch(e) {
            console.error(e);
            alert("L·ªói xu·∫•t file: " + e.message);
        } finally {
            btn.innerText = oldText; btn.disabled = false;
        }
		showLoading(false);
    }
	
	// --- H√ÄM KI·ªÇM TRA S·ªê D∆Ø AN TO√ÄN ---
    function checkBalanceSafe(rIdx, code) {
        const emp = employeesData[rIdx];
        if (!emp) return { ok: true };

        // 1. X√°c ƒë·ªãnh lo·∫°i v√† gi√° tr·ªã kh·∫•u tr·ª´
        let cost = 0;
        let typeLabel = "";
        let available = 0;

        // Ch·ªâ ki·ªÉm tra n·∫øu l√† Ph√©p (P) ho·∫∑c Ngh·ªâ B√π (NB)
        if (code.includes("P") && !code.includes("S")) { // Tr√°nh nh·∫ßm v·ªõi S+
            typeLabel = "Ph√©p nƒÉm (P)";
            cost = (code.includes("/2") || code.includes("0.5")) ? 0.5 : 1.0;
            available = (Number(emp.pn) || 0) + (Number(emp.pn_old) || 0);
        } 
        else if (code.includes("NB")) {
            typeLabel = "Ngh·ªâ b√π (NB)";
            cost = (code.includes("/2") || code.includes("0.5")) ? 0.5 : 1.0;
            available = (Number(emp.nb) || 0) + (Number(emp.nb_old) || 0);
        } 
        else {
            // C√°c ca th∆∞·ªùng (S, C, HC...) kh√¥ng c·∫ßn check
            return { ok: true };
        }

        // 2. So s√°nh
        // L√†m tr√≤n s·ªë ƒë·ªÉ tr√°nh l·ªói th·∫≠p ph√¢n (VD: 0.99999 < 1)
        available = parseFloat(available.toFixed(2));

        if (available < cost) {
            return { 
                ok: false, 
                msg: `‚ö†Ô∏è C·∫¢NH B√ÅO S·ªê D∆Ø!\n\n- Nh√¢n vi√™n: ${emp.name}\n- Lo·∫°i: ${typeLabel}\n- Hi·ªán c√≥: ${available}\n- C·∫ßn tr·ª´: ${cost}\n\nüëâ N·∫øu ti·∫øp t·ª•c, s·ªë d∆∞ s·∫Ω b·ªã √ÇM (${(available - cost).toFixed(1)}).`
            };
        }

        return { ok: true };
    }
	
	// ============================================================
    // B·ªò X·ª¨ L√ù S·ª∞ KI·ªÜN DUY NH·∫§T (FINAL FIXED)
    // ============================================================

    // Khai b√°o l·∫°i b·∫±ng var ƒë·ªÉ tr√°nh l·ªói tr√πng l·∫∑p n·∫øu l·ª° c√≥
    var isDragging = false;
    var startCell = null;
    var copiedShift = null;

    // 1. X·ª¨ L√ù CHU·ªòT
    const tableGrid = document.getElementById("scheduleTable");

    tableGrid.addEventListener("mousedown", (e) => {
        if (typeof isSwapMode !== 'undefined' && isSwapMode) return; 

        const cell = e.target.closest(".shift");
        if (!cell) {
            if (!e.target.closest("#shiftMenu")) clearSelection();
            return;
        }

        if (e.button === 0) { // Chu·ªôt tr√°i
            isDragging = true;
            startCell = cell;
            if (!e.ctrlKey) clearSelection(); 
            toggleSelect(cell, true);
            // L∆∞u √Ω: Kh√¥ng d√πng e.preventDefault() ·ªü ƒë√¢y ƒë·ªÉ gi·ªØ focus cho s·ª± ki·ªán ph√≠m
        }
    });

    tableGrid.addEventListener("mouseover", (e) => {
        if (!isDragging || !startCell) return;
        const currentCell = e.target.closest(".shift");
        if (currentCell) selectRange(startCell, currentCell);
    });

    window.addEventListener("mouseup", () => {
        isDragging = false;
    });

    // ============================================================
    // B·ªò X·ª¨ L√ù S·ª∞ KI·ªÜN B√ÄN PH√çM (FINAL - C√ì C·∫¢NH B√ÅO S·ªê D∆Ø KHI PASTE)
    // ============================================================
    document.addEventListener("keydown", async (e) => {
	
		if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT") return;
		if (typeof isSwapMode !== 'undefined' && isSwapMode) return;
		
		if (isEditing) return;
		
		const menu = document.getElementById("shiftMenu");
		const isMenuOpen = menu.style.display === "block";
	
		// ================= [PH·∫¶N 1] X·ª¨ L√ù KHI MENU ƒêANG M·ªû =================
		if (isMenuOpen) {
			// L·∫•y danh s√°ch t·∫•t c·∫£ c√°c n√∫t trong menu
			const buttons = Array.from(menu.querySelectorAll("button"));
			const activeBtn = document.activeElement; // N√∫t ƒëang ƒë∆∞·ª£c ch·ªçn
			let idx = buttons.indexOf(activeBtn);

			// A. ƒêI·ªÄU H∆Ø·ªöNG L√äN / XU·ªêNG
			if (e.key === "ArrowDown" || e.key === "ArrowUp") {
				e.preventDefault(); // Ch·∫∑n cu·ªôn trang

				// N·∫øu ch∆∞a focus v√†o n√∫t n√†o th√¨ ch·ªçn n√∫t ƒë·∫ßu ti√™n
				if (idx === -1) {
					buttons[0].focus();
					return;
				}

				if (e.key === "ArrowDown") {
					idx++;
					if (idx >= buttons.length) idx = 0; // V√≤ng v·ªÅ ƒë·∫ßu
				} else {
					idx--;
					if (idx < 0) idx = buttons.length - 1; // V√≤ng xu·ªëng cu·ªëi
				}

				buttons[idx].focus(); // Chuy·ªÉn focus sang n√∫t m·ªõi
				return; // D·ª´ng, kh√¥ng ch·∫°y logic b√™n d∆∞·ªõi
			}

			// B. PH√çM ENTER (CH·ªåN CA)
			if (e.key === "Enter") {
				// M·∫∑c ƒë·ªãnh tr√¨nh duy·ªát: Button ƒëang focus + Enter = Click
				// Ta ch·ªâ c·∫ßn return ƒë·ªÉ kh√¥ng k√≠ch ho·∫°t logic "M·ªü menu" ·ªü d∆∞·ªõi
				return; 
			}

			// C. PH√çM ESC (ƒê√ìNG MENU) -> ƒê·ªÉ n√≥ ch·∫°y xu·ªëng logic ESC chung ·ªü d∆∞·ªõi
			if (e.key !== "Escape") return; 
		}
		
		// ======================================
	
		if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT") {
			return;
		}

		if (typeof isSwapMode !== 'undefined' && isSwapMode) return;
	
        if (typeof isSwapMode !== 'undefined' && isSwapMode) return; 

        // --- A. DELETE (X√ìA) ---
        if (e.key === "Delete") {
            let targets = Array.from(document.querySelectorAll(".cell-multi-selected"));
            if (targets.length === 0) {
                const single = document.querySelector(".selected");
                if (single) targets = [single];
            }

            if (targets.length > 0) {
				saveUndoState();
                e.preventDefault();
                const tbody = document.getElementById("scheduleBody");
                const allRows = Array.from(tbody.children);
                let hasChange = false;

                targets.forEach(cell => {
                    try {
                        cell.innerText = "";
                        cell.className = "shift"; 
                        cell.removeAttribute("style");
                        if (targets.length > 1) cell.classList.add("cell-multi-selected");
                        else cell.classList.add("selected");

                        const tr = cell.closest("tr");
                        if (tr) {
                            const rIdx = allRows.indexOf(tr);
                            const cIdx = Array.from(tr.children).indexOf(cell) - 4; 
                            if (employeesData[rIdx] && cIdx >= 0 && cIdx < 7) {
                                employeesData[rIdx].shifts[cIdx] = "";
                                hasChange = true;
                            }
                        }
                    } catch (err) { console.error(err); }
                });
                if (hasChange) triggerAutoSave();
            }
        }

        // --- B. COPY (CTRL + C) ---
        if (e.ctrlKey && (e.key === 'c' || e.key === 'C')) {
            const activeCell = document.querySelector(".selected") || document.querySelector(".cell-multi-selected");
            if (!activeCell) return;

            if (document.querySelector(".copy-source")) 
                document.querySelector(".copy-source").classList.remove("copy-source");

            const code = activeCell.innerText.trim();
            const conf = SHIFTS.find(s => s.code === code) || {cls:""};
            
            copiedShift = { code: code, cls: conf.cls };
            activeCell.classList.add("copy-source");
            
            try { await navigator.clipboard.writeText(code); } catch(err) { fallbackCopyTextToClipboard(code); }
        }

        // --- C. PASTE (CTRL + V) [FINAL V4: D√ÅN CA TH∆Ø·ªúNG - B·ªé QUA NB] ---
        if (e.ctrlKey && (e.key === 'v' || e.key === 'V')) {
            e.preventDefault();
            
            // 1. X√°c ƒë·ªãnh v√πng ƒë√≠ch
            let targetCells = Array.from(document.querySelectorAll(".cell-multi-selected"));
            let startCell = document.querySelector(".selected");
            
            if (targetCells.length === 0 && startCell) targetCells = [startCell];
            if (targetCells.length === 0) return;

            try {
                // 2. L·∫•y d·ªØ li·ªáu clipboard
                let text = "";
                try { text = await navigator.clipboard.readText(); } catch (err) {}
                if (!text && copiedShift) text = copiedShift.code;
                
                if (!text) return;
                
				saveUndoState();
				
                // 3. PH√ÇN T√çCH D·ªÆ LI·ªÜU
                const rowsStr = text.trim().split(/\r?\n/);
                // M·∫£ng ph·∫≥ng ƒë·ªÉ check nhanh
                const allValues = rowsStr.map(row => row.split('\t')).flat().map(v => v.trim().toUpperCase());
                
                const containsNB = allValues.some(v => v === 'NB' || v === 'NB/2' || v === '0.5NB');
                const isMultiValue = allValues.length > 1;

                // ============================================================
                // X·ª¨ L√ù LOGIC NB
                // ============================================================
                if (containsNB) {
                    // TR∆Ø·ªúNG H·ª¢P 1: Ch·ªâ d√°n ƒë√∫ng 1 √¥ NB -> M·ªû POPUP (Gi·ªØ nguy√™n ti·ªán √≠ch n√†y)
                    if (!isMultiValue && targetCells.length === 1) {
                        const cell = targetCells[0]; 
                        const tr = cell.closest("tr");
                        const tbody = document.getElementById("scheduleBody");
                        const allRows = Array.from(tbody.children);
                        
                        const rIdx = allRows.indexOf(tr);
                        const cIdx = Array.from(tr.children).indexOf(cell) - 4;

                        if (employeesData[rIdx] && cIdx >= 0 && cIdx < 7) {
                            selectedR = rIdx; selectedC = cIdx; currentCell = cell;
                            
                            const wDate = new Date(currentWeekStart);
                            wDate.setDate(wDate.getDate() + cIdx);
                            pendingNbDateStr = formatDateISO(wDate); 

                            const val = allValues[0];
                            pendingNbCode = val;
                            const conf = SHIFTS.find(s => s.code === val) || {cls:""};
                            pendingNbCls = conf.cls;

                            const emp = employeesData[rIdx];
                            openNbSourcePopup(emp.code, emp.name, pendingNbDateStr, val);
                        }
                        return; // D·ª´ng, chuy·ªÉn sang Popup
                    }

                    // TR∆Ø·ªúNG H·ª¢P 2: D√°n nhi·ªÅu √¥ -> C·∫¢NH B√ÅO & L·ªåC B·ªé NB
                    if (isMultiValue) {
                        if (!confirm("‚ö†Ô∏è PH√ÅT HI·ªÜN M√É [NB]!\n\nDo m·ªói ng√†y ngh·ªâ b√π c·∫ßn ch·ªçn ngu·ªìn ri√™ng, h·ªá th·ªëng s·∫Ω:\n- ‚úÖ D√°n c√°c ca th∆∞·ªùng (S, C, P...)\n- ‚ö™ ƒê·ªÇ TR·ªêNG c√°c √¥ [NB]\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c kh√¥ng?")) {
                            return; // H·ªßy d√°n n·∫øu user kh√¥ng ch·ªãu
                        }
                        // N·∫øu OK -> Code s·∫Ω ch·∫°y xu·ªëng d∆∞·ªõi, nh∆∞ng ta c·∫ßn c·ªù ƒë·ªÉ bi·∫øt l√† ph·∫£i filter
                    }
                }
                
                // ============================================================
                // LOGIC D√ÅN (C√ì L·ªåC NB TH√ÄNH R·ªñNG)
                // ============================================================
                
                const tbody = document.getElementById("scheduleBody");
                const allRows = Array.from(tbody.children);

                // ... (Logic Pre-check s·ªë d∆∞ P gi·ªØ nguy√™n) ...
                let warningList = new Set();
                let hasBalanceIssue = false;
                const checkRisk = (rIdx, val) => {
                    const v = val.trim().toUpperCase();
                    // Ch·ªâ check P (NB s·∫Ω b·ªã x√≥a r·ªóng n√™n kh√¥ng c·∫ßn check d∆∞)
                    if (v.includes("P")) { 
                        const check = checkBalanceSafe(rIdx, v);
                        if (!check.ok) { hasBalanceIssue = true; warningList.add(employeesData[rIdx].name); }
                    }
                }

                // Ch·∫°y check r·ªßi ro
                if (!isMultiValue && targetCells.length > 1) {
                    const val = text.trim();
                    targetCells.forEach(cell => { const tr=cell.closest("tr"); if(tr) checkRisk(Array.from(tbody.children).indexOf(tr), val); });
                } else {
                     const startTr = startCell.closest("tr");
                     const startRIdx = Array.from(tbody.children).indexOf(startTr);
                     const startCIdx = Array.from(startTr.children).indexOf(startCell) - 4; 
                     rowsStr.forEach((rowStr, i) => {
                        const cols = rowStr.split('\t'); const rIdx = startRIdx + i; if(rIdx>=employeesData.length)return;
                        cols.forEach((val, j) => { checkRisk(rIdx, val); });
                     });
                }

                if (hasBalanceIssue) {
                    const names = Array.from(warningList).join(", ");
                    if (!confirm(`‚ö†Ô∏è C·∫¢NH B√ÅO S·ªê D∆Ø PH√âP (P)!\nNh√¢n vi√™n: ${names}\nS·ªë d∆∞ s·∫Ω b·ªã √ÇM. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën d√°n kh√¥ng?`)) return;
                }

                // --- TH·ª∞C HI·ªÜN PASTE ---
                let hasChange = false;
                const newRequests = []; 
                const getDateByColIndex = (cIdx) => {
                    const wDate = new Date(currentWeekStart); wDate.setDate(wDate.getDate() + cIdx); return formatDateISO(wDate);
                };

                const processPasteCell = (cell, rawInput, rIdx, cIdx) => {
                    // [QUAN TR·ªåNG] X·ª≠ l√Ω l·ªçc m√£
                    let codeToPaste = rawInput;
                    
                    // N·∫øu l√† NB th√¨ chuy·ªÉn th√†nh r·ªóng ""
                    if (codeToPaste === 'NB' || codeToPaste === 'NB/2' || codeToPaste === '0.5NB') {
                        codeToPaste = ""; 
                    }

                    const conf = SHIFTS.find(s => s.code === codeToPaste) || { cls: "", code: codeToPaste };
                    
                    // C·∫≠p nh·∫≠t UI
                    cell.innerText = conf.code; 
                    cell.className = `shift ${conf.cls}`; 
                    cell.removeAttribute("style");
                    if (targetCells.length > 1) cell.classList.add('cell-multi-selected'); else cell.classList.add('selected');

                    // C·∫≠p nh·∫≠t Data
                    if (employeesData[rIdx] && cIdx >= 0 && cIdx < 7) {
                        const oldVal = employeesData[rIdx].shifts[cIdx];
                        employeesData[rIdx].shifts[cIdx] = conf.code;
                        
                        // N·∫øu l√† Ph√©p (P) -> T·∫°o request
                        if (conf.code.includes("P") && oldVal !== conf.code) {
                             newRequests.push({
                                emp_code: employeesData[rIdx].code, emp_name: employeesData[rIdx].name,
                                type: conf.code, date: getDateByColIndex(cIdx),
                                reason: "Admin nh·∫≠p tr·ª±c ti·∫øp (Ph√©p nƒÉm)", val: (conf.code.includes("/2")||conf.code.includes("0.5"))?0.5:1.0,
                                status: 'ƒê√£ duy·ªát'
                            });
                        }
                        return true;
                    }
                    return false;
                };

                // Logic Paste
                if (!isMultiValue && targetCells.length > 1) {
                    // Paste FILL
                    const val = text.trim().toUpperCase();
                    targetCells.forEach(cell => {
                        try {
                            const tr = cell.closest("tr"); const rIdx = Array.from(tbody.children).indexOf(tr); const cIdx = Array.from(tr.children).indexOf(cell) - 4;
                            if (processPasteCell(cell, val, rIdx, cIdx)) hasChange = true;
                        } catch (err) {}
                    });
                } else {
                    // Paste NORMAL
                    const startTr = startCell.closest("tr");
                    const startRIdx = Array.from(tbody.children).indexOf(startTr);
                    const startCIdx = Array.from(startTr.children).indexOf(startCell) - 4; 
                    rowsStr.forEach((rowStr, i) => {
                        const cols = rowStr.split('\t'); const rIdx = startRIdx + i; if (rIdx >= employeesData.length) return;
                        cols.forEach((val, j) => {
                            const cIdx = startCIdx + j;
                            if (cIdx >= 0 && cIdx < 7) {
                                let rawVal = val.trim().toUpperCase();
                                const targetRow = Array.from(tbody.children)[rIdx]; 
                                const targetCell = targetRow.children[cIdx + 4];
                                if (targetCell) { 
                                    if (processPasteCell(targetCell, rawVal, rIdx, cIdx)) hasChange = true; 
                                }
                            }
                        });
                    });
                }

                if (hasChange) {
                    triggerAutoSave();
                    if (newRequests.length > 0) {
                        _supabase.from('leave_requests').insert(newRequests).then(({error})=>{
                            if(!error) showToastNotification(`‚úÖ ƒê√£ t·∫°o t·ª± ƒë·ªông ${newRequests.length} ƒë∆°n Ph√©p!`);
                        });
                    }
                }

            } catch (err) { console.error("L·ªói paste:", err); }
        }

		// --- E. PH√çM ENTER (M·ªû MENU) ---
		if (e.key === "Enter") {
			e.preventDefault();
			// N·∫øu menu ch∆∞a m·ªü th√¨ m·ªü n√≥ ra
			if (currentCell && selectedR !== -1 && !isMenuOpen) {
				openMenu(currentCell, selectedR, selectedC);
			}
		}
		
		// --- G. UNDO (Ctrl+Z) & REDO (Ctrl+Y) ---
		if (e.ctrlKey || e.metaKey) {
			
			// Check Undo: Ctrl + Z
			if (e.key === 'z' || e.key === 'Z') {
				e.preventDefault();
				// N·∫øu c√≥ th√™m Shift -> Redo
				if (e.shiftKey) {
					performRedo();
				} else {
					performUndo();
				}
				return;
			}
			
			// Check Redo: Ctrl + Y
			if (e.key === 'y' || e.key === 'Y') {
				e.preventDefault();
				performRedo();
				return;
			}
		}
		
		// ================= [M·ªöI] B·∫ÆT S·ª∞ KI·ªÜN G√ï PH√çM (A-Z, 0-9) =================
        // Ch·ªâ b·∫Øt khi kh√¥ng gi·ªØ Ctrl/Alt (ƒë·ªÉ tr√°nh ph√≠m t·∫Øt nh∆∞ Ctrl+C, Ctrl+S)
        if (!e.ctrlKey && !e.altKey && !e.metaKey && e.key.length === 1) {
            
            // Ch·ªâ k√≠ch ho·∫°t n·∫øu ƒëang ch·ªçn 1 √¥ ca l√†m vi·ªác
            if (currentCell && selectedR !== -1 && selectedC !== -1) {
                // Ki·ªÉm tra k√Ω t·ª± in ƒë∆∞·ª£c (Ch·ªØ ho·∫∑c s·ªë)
                // Regex: /^[a-zA-Z0-9\/\+]$/ -> Cho ph√©p ch·ªØ, s·ªë, d·∫•u /, d·∫•u + (cho S+)
                if (/^[a-zA-Z0-9\/\+]$/.test(e.key)) {
                    e.preventDefault();
                    startEditing(currentCell, e.key); // B·∫Øt ƒë·∫ßu s·ª≠a v·ªõi k√Ω t·ª± v·ª´a g√µ
                    return;
                }
            }
        }

        // ================= [M·ªöI] PH√çM F2 (S·ª¨A GI√Å TR·ªä C≈®) =================
        if (e.key === "F2") {
            if (currentCell && selectedR !== -1) {
                e.preventDefault();
                startEditing(currentCell, currentCell.innerText); // B·∫Øt ƒë·∫ßu s·ª≠a v·ªõi gi√° tr·ªã c≈©
                return;
            }
        }
		
		// --- F. PH√çM ESCAPE (ƒê√ìNG) ---
		if (e.key === "Escape") {
			if (document.querySelector(".copy-source")) 
				document.querySelector(".copy-source").classList.remove("copy-source");
			
			if (isMenuOpen) {
				menu.style.display = "none";
				// [QUAN TR·ªåNG] Tr·∫£ l·∫°i focus cho √¥ Grid ƒë·ªÉ d√πng ph√≠m ti·∫øp
				// Tuy nhi√™n div/td th∆∞·ªùng kh√¥ng nh·∫≠n focus tr·ª´ khi c√≥ tabindex.
				// Nh∆∞ng code logic arrow key c·ªßa ta d·ª±a v√†o bi·∫øn selectedR/C n√™n kh√¥ng c·∫ßn focus th·ª±c s·ª±.
			} else {
				clearSelection();
				selectedR = -1; selectedC = -1; currentCell = null;
			}
		}
		
		// --- D. ƒêI·ªÄU H∆Ø·ªöNG M≈®I T√äN (ARROWS) ---
		if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
			// N·∫øu Menu ch·ªçn ca ƒëang m·ªü -> ƒê·ªÉ m·∫∑c ƒë·ªãnh cho browser x·ª≠ l√Ω (ch·ªçn n√∫t trong menu)
			if(document.getElementById("shiftMenu").style.display === "block") return;

			e.preventDefault(); // Ch·∫∑n cu·ªôn trang web

			// N·∫øu ch∆∞a ch·ªçn √¥ n√†o -> M·∫∑c ƒë·ªãnh ch·ªçn √¥ ƒë·∫ßu ti√™n (D√≤ng 0, C·ªôt 0)
			if (selectedR === -1 || selectedC === -1) {
				selectCell(0, 0);
				return;
			}

			let newR = selectedR;
			let newC = selectedC;

			if (e.key === "ArrowUp") newR--;
			if (e.key === "ArrowDown") newR++;
			if (e.key === "ArrowLeft") newC--;
			if (e.key === "ArrowRight") newC++;

			// Gi·ªõi h·∫°n bi√™n (Kh√¥ng cho ch·∫°y ra ngo√†i b·∫£ng)
			// D√≤ng: 0 ƒë·∫øn max
			if (newR < 0) newR = 0;
			if (newR >= employeesData.length) newR = employeesData.length - 1;
			
			// C·ªôt: 0 (T2) ƒë·∫øn 6 (CN)
			if (newC < 0) newC = 0;
			if (newC > 6) newC = 6; 

			// Th·ª±c hi·ªán ch·ªçn
			selectCell(newR, newC);
		}

		// --- E. PH√çM ENTER (M·ªû MENU) ---
		if (e.key === "Enter") {
			e.preventDefault();
			
			const menu = document.getElementById("shiftMenu");
			
			// Tr∆∞·ªùng h·ª£p 1: Menu ƒêANG m·ªü -> Enter ƒë√≥ng vai tr√≤ click ch·ªçn n√∫t ƒëang focus
			// (Browser t·ª± x·ª≠ l√Ω vi·ªác n√†y n·∫øu n√∫t ƒëang ƒë∆∞·ª£c focus)
			if(menu.style.display === "block") {
				return; 
			}

			// Tr∆∞·ªùng h·ª£p 2: Menu ƒêANG ƒê√ìNG -> M·ªü Menu t·∫°i √¥ ƒëang ch·ªçn
			if (currentCell && selectedR !== -1) {
				openMenu(currentCell, selectedR, selectedC);
			}
		}
		
		// --- F. PH√çM ESCAPE (ƒê√ìNG MENU / B·ªé CH·ªåN) ---
		if (e.key === "Escape") {
			if (document.querySelector(".copy-source")) 
				document.querySelector(".copy-source").classList.remove("copy-source");
			
			// N·∫øu menu ƒëang m·ªü th√¨ ƒë√≥ng menu, nh∆∞ng v·∫´n gi·ªØ √¥ ƒëang ch·ªçn (selected) ƒë·ªÉ thao t√°c ti·∫øp
			const menu = document.getElementById("shiftMenu");
			if (menu.style.display === "block") {
				menu.style.display = "none";
			} else {
				// N·∫øu menu ƒë√£ ƒë√≥ng r·ªìi th√¨ m·ªõi b·ªè ch·ªçn √¥
				clearSelection();
				selectedR = -1; selectedC = -1; currentCell = null;
			}
		}
    });

    // H√†m h·ªó tr·ª£
    function selectRange(start, end) {
        clearSelection();
        const startTr = start.closest("tr");
        const endTr = end.closest("tr");
        const tbody = document.getElementById("scheduleBody");
        const allRows = Array.from(tbody.children);
        
        const startR = allRows.indexOf(startTr);
        const endR = allRows.indexOf(endTr);
        const getColIdx = (c) => Array.from(c.parentNode.children).indexOf(c);
        const startC = getColIdx(start);
        const endC = getColIdx(end);

        const minR = Math.min(startR, endR); const maxR = Math.max(startR, endR);
        const minC = Math.min(startC, endC); const maxC = Math.max(startC, endC);

        for (let r = minR; r <= maxR; r++) {
            const row = allRows[r];
            if (!row) continue;
            for (let c = minC; c <= maxC; c++) {
                const cell = row.children[c];
                if (cell && cell.classList.contains("shift")) toggleSelect(cell, true);
            }
        }
    }

    function toggleSelect(cell, force) {
        if (force) cell.classList.add("cell-multi-selected");
        else cell.classList.remove("cell-multi-selected");
    }

    function clearSelection() {
        document.querySelectorAll(".cell-multi-selected").forEach(c => c.classList.remove("cell-multi-selected"));
        document.querySelectorAll(".selected").forEach(c => c.classList.remove("selected"));
    }

    function fallbackCopyTextToClipboard(text) {
        try {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px"; 
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        } catch (err) {}
    }
	
	// Bi·∫øn c·ªù ƒë·ªÉ bi·∫øt ƒëang nh·∫≠p li·ªáu (ƒë·ªÉ ch·∫∑n c√°c ph√≠m t·∫Øt kh√°c nh∆∞ Arrow di chuy·ªÉn)
    let isEditing = false;

    function startEditing(cell, initialValue = "") {
        if (!cell || isEditing) return;

        isEditing = true; // B·∫≠t c·ªù ƒëang s·ª≠a
        
        // 1. L∆∞u gi√° tr·ªã c≈© ƒë·ªÉ restore n·∫øu b·∫•m Esc
        const oldValue = cell.innerText;
        
        // 2. T·∫°o th·∫ª Input
        const input = document.createElement("input");
        input.type = "text";
        input.className = "cell-editor";
        input.value = initialValue; // Gi√° tr·ªã kh·ªüi t·∫°o (k√Ω t·ª± v·ª´a g√µ ho·∫∑c r·ªóng)

        // 3. X√≥a n·ªôi dung text c≈© t·∫°m th·ªùi v√† ch√®n Input v√†o
        cell.innerText = ""; 
        cell.appendChild(input);
        input.focus();

        // 4. X·ª≠ l√Ω s·ª± ki·ªán tr√™n Input n√†y
        input.addEventListener("keydown", (e) => {
            e.stopPropagation(); // Ch·∫∑n s·ª± ki·ªán n·ªïi b·ªçt l√™n window (ƒë·ªÉ kh√¥ng k√≠ch ho·∫°t ph√≠m t·∫Øt chung)

            // ENTER: L∆∞u v√† xu·ªëng d√≤ng
            if (e.key === "Enter") {
                e.preventDefault();
                finishEditing(cell, input.value, true); // true = move down
            }
            
            // TAB: L∆∞u v√† sang ph·∫£i
            if (e.key === "Tab") {
                e.preventDefault();
                finishEditing(cell, input.value, false, true); // true = move right
            }

            // ESC: H·ªßy b·ªè
            if (e.key === "Escape") {
                e.preventDefault();
                cancelEditing(cell, oldValue);
            }
        });

        // Click ra ngo√†i (Blur): T·ª± ƒë·ªông l∆∞u
        input.addEventListener("blur", () => {
            finishEditing(cell, input.value, false);
        });
    }

    // H√†m k·∫øt th√∫c nh·∫≠p v√† L∆ØU
    function finishEditing(cell, value, moveDown = false, moveRight = false) {
        if (!isEditing) return;
        
        // 1. Chu·∫©n h√≥a gi√° tr·ªã (Vi·∫øt hoa, Trim)
        const code = value.trim().toUpperCase();
        
        // 2. X√≥a input, tr·∫£ l·∫°i tr·∫°ng th√°i b√¨nh th∆∞·ªùng
        // (Vi·ªác c·∫≠p nh·∫≠t UI v√† DB s·∫Ω do h√†m applyShiftToCell lo)
        cell.innerHTML = ""; 
        isEditing = false;

        // 3. T√¨m th√¥ng tin ca l√†m vi·ªác ƒë·ªÉ l·∫•y m√†u s·∫Øc (cls)
        const conf = SHIFTS.find(s => s.code === code) || { cls: "", code: code };

        // 4. G·ªçi h√†m l∆∞u c√≥ s·∫µn c·ªßa b·∫°n
        // H√†m n√†y ƒë√£ c√≥ Undo, Check s·ªë d∆∞, L∆∞u DB... n√™n t√°i s·ª≠ d·ª•ng r·∫•t t·ªët
        applyShiftToCell(conf.code, conf.cls, "Nh·∫≠p tr·ª±c ti·∫øp t·ª´ b√†n ph√≠m");

        // 5. Di chuy·ªÉn con tr·ªè (gi·ªëng Excel)
        if (moveDown) {
            // Di chuy·ªÉn xu·ªëng d∆∞·ªõi
            let nextR = selectedR + 1;
            if (nextR < employeesData.length) selectCell(nextR, selectedC);
        } else if (moveRight) {
             // Di chuy·ªÉn sang ph·∫£i
            let nextC = selectedC + 1;
            if (nextC < 7) selectCell(selectedR, nextC);
        } else {
            // Focus l·∫°i √¥ hi·ªán t·∫°i (ƒë·ªÉ nh·∫≠n ph√≠m ti·∫øp)
            selectCell(selectedR, selectedC);
        }
    }

    // H√†m h·ªßy b·ªè (Esc)
    function cancelEditing(cell, oldValue) {
        isEditing = false;
        cell.innerHTML = oldValue; // Tr·∫£ l·∫°i text c≈©
        selectCell(selectedR, selectedC); // Focus l·∫°i
    }
	
	// ============================================================
    // T√çNH NƒÇNG HIGHLIGHT D√íNG & C·ªòT (CROSSHAIR)
    // ============================================================
    const tableEl = document.getElementById("scheduleTable");
    let lastHighlightRow = -1;
    let lastHighlightCol = -1;

    // 1. L·∫Øng nghe s·ª± ki·ªán di chu·ªôt v√†o b·∫£ng
    tableEl.addEventListener("mouseover", (e) => {
		// CH·ªà CH·∫†Y N·∫æU T√çNH NƒÇNG ƒê∆Ø·ª¢C B·∫¨T
        if (!isCrosshairEnabled) return;
	
        // Ch·ªâ x·ª≠ l√Ω n·∫øu chu·ªôt ch·∫°m v√†o √¥ d·ªØ li·ªáu (TD)
        const cell = e.target.closest("td");
        if (!cell) return;

        const row = cell.parentElement;
        const rowIndex = row.rowIndex;
        const colIndex = cell.cellIndex;

        // N·∫øu v·ªã tr√≠ chu·ªôt ch∆∞a thay ƒë·ªïi th√¨ kh√¥ng l√†m g√¨ (T·ªëi ∆∞u hi·ªáu nƒÉng)
        if (rowIndex === lastHighlightRow && colIndex === lastHighlightCol) return;

        // X√≥a highlight c≈©
        clearHighlight();

        // Ghi nh·∫≠n v·ªã tr√≠ m·ªõi
        lastHighlightRow = rowIndex;
        lastHighlightCol = colIndex;

        // --- T√î M√ÄU D√íNG (ROW) ---
        // Th√™m class cho t·∫•t c·∫£ c√°c √¥ trong d√≤ng hi·ªán t·∫°i
        // (Array.from ƒë·ªÉ duy·ªát qua HTMLCollection)
        Array.from(row.children).forEach(td => {
            td.classList.add("crosshair-highlight");
        });

        // --- T√î M√ÄU C·ªòT (COLUMN) ---
        // Duy·ªát qua t·∫•t c·∫£ c√°c d√≤ng ƒë·ªÉ t√¨m √¥ c√πng c·ªôt
        const rows = tableEl.rows;
        for (let i = 0; i < rows.length; i++) {
            const cellAtCol = rows[i].cells[colIndex];
            // Ch·ªâ t√¥ m√†u n·∫øu √¥ t·ªìn t·∫°i
            if (cellAtCol) {
                cellAtCol.classList.add("crosshair-highlight");
            }
        }

        // --- T√î M√ÄU √î TRUNG T√ÇM (CENTER) ---
        cell.classList.remove("crosshair-highlight"); // X√≥a l·ªõp m·ªù
        cell.classList.add("crosshair-center");       // Th√™m l·ªõp ƒë·∫≠m
    });

    // 2. Khi chu·ªôt r·ªùi kh·ªèi b·∫£ng th√¨ x√≥a s·∫°ch
    tableEl.addEventListener("mouseleave", () => {
        clearHighlight();
        lastHighlightRow = -1;
        lastHighlightCol = -1;
    });

    // H√†m d·ªçn d·∫πp (X√≥a class kh·ªèi t·∫•t c·∫£ c√°c √¥)
    function clearHighlight() {
        // T√¨m c√°c √¥ ƒëang c√≥ class highlight v√† x√≥a ƒëi
        const highlighted = tableEl.querySelectorAll(".crosshair-highlight, .crosshair-center");
        highlighted.forEach(el => {
            el.classList.remove("crosshair-highlight");
            el.classList.remove("crosshair-center");
        });
    }
	
	// 1. Kh·ªüi t·∫°o c√†i ƒë·∫∑t khi t·∫£i trang
    async function initSettings() {
        // L·∫•y user hi·ªán t·∫°i ƒëang ƒëƒÉng nh·∫≠p
        const userStr = localStorage.getItem("currentUser");
        if (!userStr) return; // Ch∆∞a ƒëƒÉng nh·∫≠p th√¨ th√¥i
        const currentUser = JSON.parse(userStr);

        try {
            // G·ªçi Supabase l·∫•y c√†i ƒë·∫∑t
            const { data, error } = await _supabase
                .from('user_settings')
                .select('*')
                .eq('username', currentUser.username)
                .single();

            if (data) {
                // N·∫øu ƒë√£ c√≥ c√†i ƒë·∫∑t trong DB -> √Åp d·ª•ng
                isCrosshairEnabled = data.is_crosshair_enabled;
            } else {
                // N·∫øu ch∆∞a c√≥ (User m·ªõi) -> M·∫∑c ƒë·ªãnh l√† B·∫≠t
                isCrosshairEnabled = true;
            }

        } catch (e) {
            console.error("L·ªói t·∫£i c√†i ƒë·∫∑t:", e);
            isCrosshairEnabled = true; // Fallback
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i switch tr√™n giao di·ªán
        const toggle = document.getElementById("toggleCrosshair");
        if (toggle) {
            toggle.checked = isCrosshairEnabled;
        }
    }

    // 2. H√†m x·ª≠ l√Ω khi ng∆∞·ªùi d√πng b·∫≠t/t·∫Øt switch
    async function toggleCrosshairFeature(isChecked) {
        isCrosshairEnabled = isChecked;
        
        // A. X·ª≠ l√Ω giao di·ªán ngay l·∫≠p t·ª©c (cho m∆∞·ª£t)
        if (!isChecked) {
            clearHighlight(); // N·∫øu t·∫Øt th√¨ x√≥a highlight ngay
        }

        // B. L∆∞u v√†o Database
        const userStr = localStorage.getItem("currentUser");
        if (userStr) {
            const currentUser = JSON.parse(userStr);
            
            // D√πng UPSERT: N·∫øu ch∆∞a c√≥ th√¨ t·∫°o m·ªõi, c√≥ r·ªìi th√¨ c·∫≠p nh·∫≠t
            const { error } = await _supabase
                .from('user_settings')
                .upsert({ 
                    username: currentUser.username, 
                    is_crosshair_enabled: isChecked 
                });

            if (error) {
                console.error("L·ªói l∆∞u c√†i ƒë·∫∑t:", error);
                showToastNotification("‚ö†Ô∏è Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t!");
            } else {
                showToastNotification("ƒê√£ " + (isChecked ? "B·∫≠t" : "T·∫Øt") + " Highlight & ƒê√£ l∆∞u!");
            }
        }
    }
	
	initSettings();
	
	// ============================================================
    // LOGIC B·∫¢NG T·ªîNG H·ª¢P CHI TI·∫æT (NOTE)
    // ============================================================

    // 1. C·∫§U H√åNH C√ÅC D√íNG C·∫¶N ƒê·∫æM (Gi·ªëng h·ªát trong ·∫£nh)
    const SUMMARY_ROWS = [
        { title: "Th·ª© 2 Ca S+: Ch√†o c·ªù", codes: ["S+"] }, // C·∫ßn c√≥ m√£ S+ trong h·ªá th·ªëng ho·∫∑c ƒë·∫øm S v√†o T2
        { title: "Ca S1: (06h30-14h30). Ngh·ªâ gi·ªØa ca 45 ph√∫t", codes: ["S1"] },
        { title: "Ca S: (8h00-16h00). Ngh·ªâ gi·ªØa ca 45 ph√∫t", codes: ["S"] },
        { title: "Ca C: (15h00-23h00). Ngh·ªâ gi·ªØa ca 45 ph√∫t", codes: ["C"] },
        { title: "Ca HC: (8h00-17h00). Ngh·ªâ gi·ªØa ca 60 ph√∫t", codes: ["HC"] },
        { title: "Ngh·ªâ n·ªØa ca, bu·ªïi: P/2, NB/2", codes: ["P/2", "NB/2", "0.5"] },
        { title: "Ngh·ªâ ca: NC", codes: ["NC"] },
        { title: "Ngh·ªâ ph√©p: P, NB", codes: ["P", "NB"] },
        { title: "Ngh·ªâ kh√¥ng l∆∞∆°ng: KL", codes: ["KL"] },
        { title: "Ngh·ªâ L·ªÖ: L", codes: ["L"] },
        { title: "Ngh·ªâ: ·ªêm, Con ·ªëm: √î", codes: ["√î", "CO"] }
    ];

    // 2. H√ÄM T√çNH TO√ÅN V√Ä V·∫º B·∫¢NG
    function updateDetailSummary() {
        const tbody = document.getElementById("summaryBody");
        if (!tbody) return;
        tbody.innerHTML = "";

        // Kh·ªüi t·∫°o b·ªô ƒë·∫øm: M·∫£ng 2 chi·ªÅu [S·ªë d√≤ng c·∫•u h√¨nh][7 ng√†y]
        // countMap[rowIndex][dayIndex] = s·ªë l∆∞·ª£ng
        let countMap = Array(SUMMARY_ROWS.length).fill(0).map(() => Array(7).fill(0));

        // Duy·ªát qua d·ªØ li·ªáu nh√¢n vi√™n ƒë·ªÉ ƒë·∫øm
        employeesData.forEach(emp => {
            emp.shifts.forEach((code, dayIdx) => {
                if (dayIdx >= 0 && dayIdx < 7 && code) {
                    const cleanCode = code.trim().toUpperCase();
                    
                    // T√¨m xem code n√†y thu·ªôc d√≤ng n√†o trong c·∫•u h√¨nh
                    SUMMARY_ROWS.forEach((rowConfig, rIdx) => {
                        // Logic ƒë·∫∑c bi·ªát cho d√≤ng 1 (S+ ch√†o c·ªù th·ª© 2)
                        if (rIdx === 0 && dayIdx === 0 && (cleanCode === 'S' || cleanCode === 'S+')) {
                             countMap[rIdx][dayIdx]++;
                        }
                        // Logic c√°c d√≤ng kh√°c
                        else if (rowConfig.codes.includes(cleanCode)) {
                             // Tr·ª´ tr∆∞·ªùng h·ª£p S v√†o th·ª© 2 ƒë√£ t√≠nh cho d√≤ng 1 r·ªìi th√¨ th√¥i d√≤ng 3
                             if (rIdx === 2 && dayIdx === 0 && cleanCode === 'S') return; 
                             
                             countMap[rIdx][dayIdx]++;
                        }
                    });
                }
            });
        });

        // V·∫Ω d√≤ng ra HTML
        SUMMARY_ROWS.forEach((rowConfig, rIdx) => {
            const tr = document.createElement("tr");
            
            // C·ªôt ti√™u ƒë·ªÅ
            let html = `<td style="text-align: left; padding: 8px; border: 1px solid #ddd; font-weight: 500;">${rowConfig.title}</td>`;
            
            // 7 c·ªôt ng√†y
            for (let d = 0; d < 7; d++) {
                const val = countMap[rIdx][d];
                // N·∫øu > 0 th√¨ in ƒë·∫≠m cho d·ªÖ nh√¨n, = 0 th√¨ ƒë·ªÉ nh·∫°t
                const style = val > 0 ? "font-weight:bold; color:#333;" : "color:#ccc;";
                html += `<td style="text-align: center; border: 1px solid #ddd; ${style}">${val}</td>`;
            }
            
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });
    }

    // 3. H√ÄM B·∫¨T/T·∫ÆT X·ªî XU·ªêNG
    function toggleSummaryTable() {
        const container = document.getElementById("summaryContainer");
        const icon = document.getElementById("summaryIcon");
        
        if (container.style.display === "none") {
            container.style.display = "block";
            icon.innerText = "‚ñ≤"; // M≈©i t√™n l√™n
            // C·∫≠p nh·∫≠t s·ªë li·ªáu ngay khi m·ªü ra
            updateDetailSummary();
        } else {
            container.style.display = "none";
            icon.innerText = "‚ñº"; // M≈©i t√™n xu·ªëng
        }
    }
	
	// --- DANH S√ÅCH C√ÅC M√É ƒê∆Ø·ª¢C COI L√Ä "NGH·ªà" ---
	// N·∫øu ca l√†m vi·ªác KH√îNG thu·ªôc nh√≥m n√†y th√¨ t√≠nh l√† "L√†m vi·ªác"
	const REST_CODES = ["NC"];

	function checkContinuousWorkWarning() {
		const violators = [];

		employeesData.forEach(emp => {
			let workDaysCount = 0;

			// Duy·ªát qua 7 ng√†y trong tu·∫ßn c·ªßa nh√¢n vi√™n
			emp.shifts.forEach(shiftCode => {
				if (!shiftCode) return; // √î tr·ªëng t√≠nh l√† kh√¥ng l√†m (ho·∫∑c t√πy b·∫°n)

				// Ki·ªÉm tra xem ca n√†y c√≥ ph·∫£i l√† ca NGH·ªà kh√¥ng
				// D√πng startWith ƒë·ªÉ b·∫Øt c·∫£ P/2, NB/2...
				const isRestDay = REST_CODES.some(rest => shiftCode.startsWith(rest));

				// N·∫øu KH√îNG PH·∫¢I ca ngh·ªâ -> T√≠nh l√† ng√†y l√†m vi·ªác (S, C, HC, CT...)
				if (!isRestDay) {
					workDaysCount++;
				}
			});

			// N·∫øu l√†m ƒë·ªß 7 ng√†y (Kh√¥ng c√≥ ng√†y ngh·ªâ n√†o)
			if (workDaysCount >= 7) {
				violators.push(`- ${emp.name} (L√†m ${workDaysCount} ng√†y)`);
			}
		});

		return violators;
	}
	
	// BI·∫æN L∆ØU V·ªä TR√ç NH√ÇN VI√äN ƒêANG S·ª¨A
    let currentEditIdx = -1;

    // 1. H√ÄM M·ªû POPUP
    function openEditEmpPopup(idx, event) {
        // NgƒÉn ch·∫∑n s·ª± ki·ªán click c·ªßa d√≤ng (ƒë·ªÉ kh√¥ng b·ªã k√≠ch ho·∫°t ch·∫ø ƒë·ªô ƒê·∫£o/Swap n·∫øu c√≥)
        if(event) event.stopPropagation();
        if (typeof isSwapMode !== 'undefined' && isSwapMode) return;

        currentEditIdx = idx;
        const emp = employeesData[idx];

        if (!emp) return;

        // ƒêi·ªÅn d·ªØ li·ªáu c≈© v√†o form
        document.getElementById("lblEditCode").innerText = emp.code;
        document.getElementById("txtEditName").value = emp.name;
        document.getElementById("txtEditRole").value = emp.role || "";
        document.getElementById("selEditStatus").value = "active"; // M·∫∑c ƒë·ªãnh l√† active v√¨ ƒëang hi·ªán tr√™n b·∫£ng

        document.getElementById("editEmpPopup").style.display = "flex";
        document.getElementById("txtEditName").focus();
    }

    // 2. H√ÄM L∆ØU THAY ƒê·ªîI
    async function submitEditEmployee() {
        if (currentEditIdx === -1) return;

        const emp = employeesData[currentEditIdx];
        const newName = document.getElementById("txtEditName").value.trim();
        const newRole = document.getElementById("txtEditRole").value.trim();
        const newStatus = document.getElementById("selEditStatus").value;

        if (!newName) return alert("H·ªç t√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");

        const btnSave = document.querySelector("#editEmpPopup .btn-p");
        const oldText = btnSave.innerText;
        btnSave.innerText = "‚è≥ ƒêang l∆∞u..."; btnSave.disabled = true;

        try {
            // C·∫≠p nh·∫≠t l√™n Supabase
            const { error } = await _supabase
                .from('employees')
                .update({ 
                    name: newName, 
                    role: newRole,
                    status: newStatus
                })
                .eq('code', emp.code);

            if (error) throw error;

            // C·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu d∆∞·ªõi m√°y (Local)
            if (newStatus === 'inactive') {
                // N·∫øu ch·ªçn ngh·ªâ vi·ªác -> X√≥a kh·ªèi b·∫£ng
                employeesData.splice(currentEditIdx, 1);
            } else {
                // N·∫øu v·∫´n l√†m -> C·∫≠p nh·∫≠t th√¥ng tin m·ªõi
                emp.name = newName;
                emp.role = newRole;
            }

            // V·∫Ω l·∫°i b·∫£ng v√† ƒë√≥ng popup
            renderTable();
            closePopup('editEmpPopup');
            alert("‚úÖ C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!");

        } catch (e) {
            console.error(e);
            alert("L·ªói c·∫≠p nh·∫≠t: " + e.message);
        } finally {
            btnSave.innerText = oldText; btnSave.disabled = false;
        }
    }
	
	// --- H√ÄM H·ªñ TR·ª¢ CH·ªåN √î B·∫∞NG CODE (D√ôNG CHO PH√çM) ---
	function selectCell(r, c) {
		const tbody = document.getElementById("scheduleBody");
		// Ki·ªÉm tra d√≤ng t·ªìn t·∫°i
		if (!tbody || !tbody.children[r]) return;

		const tr = tbody.children[r];
		// C·∫•u tr√∫c b·∫£ng: 0=STT, 1=Code, 2=Name, 3=Role => Ca l√†m vi·ªác b·∫Øt ƒë·∫ßu t·ª´ index 4
		const cellIndex = c + 4; 
		const cell = tr.children[cellIndex];

		if (cell) {
			// 1. X√≥a highlight c≈©
			if (document.querySelector(".selected")) {
				document.querySelector(".selected").classList.remove("selected");
			}
			
			// 2. C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
			selectedR = r;
			selectedC = c;
			currentCell = cell;

			// 3. Highlight √¥ m·ªõi
			cell.classList.add("selected");
			
			// 4. T·ª± ƒë·ªông cu·ªôn m√†n h√¨nh n·∫øu √¥ b·ªã khu·∫•t
			cell.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "nearest" });
		}
	}
	
	// --- KHAI B√ÅO BI·∫æN UNDO / REDO ---
    let undoStack = []; // L∆∞u qu√° kh·ª©
    let redoStack = []; // L∆∞u t∆∞∆°ng lai (nh·ªØng c√°i v·ª´a b·ªã undo)
    const MAX_HISTORY_STEPS = 20; 

    // 1. L∆∞u tr·∫°ng th√°i (G·ªçi tr∆∞·ªõc khi thay ƒë·ªïi d·ªØ li·ªáu)
    function saveUndoState() {
        const snapshot = JSON.parse(JSON.stringify(employeesData));
        undoStack.push(snapshot);
        
        // [QUAN TR·ªåNG] Khi c√≥ h√†nh ƒë·ªông m·ªõi, t∆∞∆°ng lai (Redo) b·ªã v√¥ hi·ªáu h√≥a
        redoStack = []; 
        
        if (undoStack.length > MAX_HISTORY_STEPS) undoStack.shift();
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t b·∫•m (n·∫øu c√≥ UI)
        updateHistoryButtons();
    }

    // 2. Th·ª±c hi·ªán Undo (Quay lui)
    function performUndo() {
        if (undoStack.length === 0) {
            showToastNotification("‚ö†Ô∏è Kh√¥ng th·ªÉ Undo n·ªØa!");
            return;
        }

        // A. C·∫•t tr·∫°ng th√°i HI·ªÜN T·∫†I v√†o t√∫i REDO
        const currentState = JSON.parse(JSON.stringify(employeesData));
        redoStack.push(currentState);

        // B. L·∫•y qu√° kh·ª© ra d√πng
        const prevState = undoStack.pop();
        employeesData = prevState;
        
        // C. V·∫Ω l·∫°i v√† l∆∞u
        renderTable();
        triggerAutoSave();
        updateHistoryButtons();
        
        showToastNotification("‚Ü©Ô∏è ƒê√£ ho√†n t√°c (Undo)!");
    }
	
	// 3. Th·ª±c hi·ªán Redo (Ti·∫øn t·ªõi)
    function performRedo() {
        if (redoStack.length === 0) {
            showToastNotification("‚ö†Ô∏è Kh√¥ng th·ªÉ Redo n·ªØa!");
            return;
        }

        // A. C·∫•t tr·∫°ng th√°i HI·ªÜN T·∫†I v·ªÅ t√∫i UNDO (ƒë·ªÉ t√≠ n·ªØa c√≤n Undo l·∫°i ƒë∆∞·ª£c)
        const currentState = JSON.parse(JSON.stringify(employeesData));
        undoStack.push(currentState);

        // B. L·∫•y t∆∞∆°ng lai ra d√πng
        const nextState = redoStack.pop();
        employeesData = nextState;
        
        // C. V·∫Ω l·∫°i v√† l∆∞u
        renderTable();
        triggerAutoSave();
        updateHistoryButtons();
        
        showToastNotification("‚Ü™Ô∏è ƒê√£ l√†m l·∫°i (Redo)!");
    }
    
    // (T√πy ch·ªçn) H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i Disable cho n√∫t b·∫•m UI
    function updateHistoryButtons() {
        const btnUndo = document.getElementById("btnUndoUI");
        const btnRedo = document.getElementById("btnRedoUI");
        
        if(btnUndo) btnUndo.disabled = (undoStack.length === 0);
        if(btnRedo) btnRedo.disabled = (redoStack.length === 0);
        
        // Thay ƒë·ªïi m√†u s·∫Øc cho tr·ª±c quan (Opacity)
        if(btnUndo) btnUndo.style.opacity = (undoStack.length === 0) ? "0.5" : "1";
        if(btnRedo) btnRedo.style.opacity = (redoStack.length === 0) ? "0.5" : "1";
    }
	
	// H√†m l∆∞u ghi ch√∫ khi ng∆∞·ªùi d√πng g√µ xong
	function updateEmpNote(idx, val) {
		if (employeesData[idx]) {
			employeesData[idx].note = val;
			// G·ªçi Auto Save ƒë·ªÉ l∆∞u ngay l·∫≠p t·ª©c
			triggerAutoSave();
		}
	}
	
	async function approveAndSet(shiftCode, reqId) {
		// 1. G√°n l·ªãch tr√™n giao di·ªán tr∆∞·ªõc (ƒë·ªÉ Admin th·∫•y ngay)
		// T√¨m class t∆∞∆°ng ·ª©ng (m√†u s·∫Øc)
		const shiftObj = SHIFTS.find(s => s.code === shiftCode) || { cls: '' };
		applyShiftToCell(shiftCode, shiftObj.cls, "Duy·ªát nhanh t·ª´ Menu");
		
		// ·∫®n menu
		document.getElementById("shiftMenu").style.display = "none";

		// 2. G·ªçi API c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n trong Database (ch·∫°y ng·∫ßm)
		try {
			const { error } = await _supabase
				.from('leave_requests')
				.update({ status: 'ƒê√£ duy·ªát' })
				.eq('id', reqId);
				
			if (error) throw error;
			
			// X√≥a class c·∫£nh b√°o ƒëi v√¨ ƒë√£ duy·ªát r·ªìi
			if (currentCell) {
				currentCell.classList.remove("cell-request-pending");
				currentCell.title = ""; // X√≥a tooltip
				delete currentCell.dataset.reqId;
			}
			
			showToastNotification("‚úÖ ƒê√£ duy·ªát ƒë∆°n v√† c·∫≠p nh·∫≠t l·ªãch!");
			
		} catch (err) {
			console.error(err);
			alert("L·ªói khi duy·ªát ƒë∆°n tr√™n server: " + err.message);
		}
	}
</script>
</body>
</html>