<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Đăng nhập</title>

<style>
body {
    font-family: Arial;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    background:#f4f6f9;
}
.box {
    width:310px;
    background:#fff;
    padding:25px;
    border-radius:12px;
    box-shadow:0 4px 10px rgba(0,0,0,0.2);
}
input,button { width:100%; padding:10px; margin-top:10px; }
button { background:#3498db; color:white; border:none; border-radius:6px; }
button:disabled { opacity:0.6; cursor:not-allowed; }
.remember {
    display:flex;
    align-items:center;
    margin-top:5px;
    font-size:14px;
}
.remember input {
    width:auto;
    margin-right:6px;
}
</style>
</head>

<body>
<div class="box">
    <h2 style="text-align:center">Đăng nhập</h2>

    <input id="inputUser" placeholder="Tên đăng nhập">
    <input id="inputPass" type="password" placeholder="Mật khẩu">

    <div class="remember">
        <input type="checkbox" id="rememberMe">
        <label for="rememberMe">Ghi nhớ tài khoản</label>
    </div>

    <button id="btnLogin" onclick="login()">Đăng nhập</button>
</div>

<script>
/* =============================
    GÁN CỐ ĐỊNH API
============================= */
const SCRIPT_URL = 
    "https://script.google.com/macros/s/AKfycbxRJeVTiI0g1yp-ehdX_HCQpNog0aZ--HlYyqZ7qy6UWebJDVpwkqjLg3NDK56MwNSl/exec";

localStorage.setItem("SCRIPT_URL", SCRIPT_URL);


/* =============================
    LOAD USERNAME (nếu có)
============================= */
window.onload = function() {
    const savedUser = localStorage.getItem("remember_username");
    if (savedUser) {
        inputUser.value = savedUser;
        document.getElementById("rememberMe").checked = true;
        inputPass.focus();
    }
};


/* =============================
           LOGIN
============================= */
async function login() {
    const username = inputUser.value.trim();
    const password = inputPass.value.trim();
    const btn = document.getElementById("btnLogin");

    if (!username || !password) {
        return alert("Vui lòng nhập đủ tài khoản & mật khẩu!");
    }

    // Xử lý "Ghi nhớ tài khoản"
    if (document.getElementById("rememberMe").checked) {
        localStorage.setItem("remember_username", username);
    } else {
        localStorage.removeItem("remember_username");
    }

    // Loading effect
    btn.disabled = true;
    btn.innerHTML = "⏳ Đang đăng nhập...";

    const api = `${SCRIPT_URL}?action=login`
        + `&username=${encodeURIComponent(username)}`
        + `&password=${encodeURIComponent(password)}`;

    try {
        const res = await fetch(api);
        const json = await res.json();

        if (!json.success) {
            btn.disabled = false;
            btn.innerHTML = "Đăng nhập";
            return alert("Sai tài khoản hoặc mật khẩu!");
        }

        // Lưu thông tin
        localStorage.setItem("username", json.username);
        localStorage.setItem("group", json.group);
        localStorage.setItem("groups_list", json.groups);
        localStorage.setItem("role", json.role);

        window.location.href = "dashboard.html";
    }
    catch (err) {
        console.error(err);
        alert("Không kết nối được Google Script!");
        btn.disabled = false;
        btn.innerHTML = "Đăng nhập";
    }
}


/* =============================
   ENTER = LOGIN
============================= */
document.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();

        if (document.activeElement.id === "inputUser") {
            document.getElementById("inputPass").focus();
        }
        else {
            login();
        }
    }
});
</script>

</body>
</html>
