<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        --primary-color: #4a90e2;
        --success-color: #2ecc71;
        --danger-color: #e74c3c;
        --text-color: #2c3e50;
        --bg-color: #f0f2f5;
        --card-bg: #ffffff;
    }

    body { 
        font-family: 'Inter', sans-serif; 
        background: var(--bg-color); 
        color: var(--text-color);
        margin: 0; 
        padding: 20px; 
    }
    
    /* Container ch√≠nh d·∫°ng Card l·ªõn */
    .container { 
        max-width: 1200px; 
        margin: 0 auto; 
        background: var(--card-bg); 
        padding: 30px; 
        border-radius: 16px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
    }
    
    /* Header Area */
    .dashboard-header {
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        border-bottom: 1px solid #eee; 
        padding-bottom: 20px; 
        margin-bottom: 25px;
    }
    
    h2 { 
        margin: 0; 
        color: var(--primary-color); 
        font-weight: 700; 
        letter-spacing: -0.5px;
    }

    .user-info-bar { 
        font-size: 14px; 
        color: #666; 
        margin-top: 5px; 
    }
    
    /* Quick Access Toolbar */
    .quick-access {
        display: flex; 
        gap: 10px; 
        align-items: center; 
        background: #f8f9fa; 
        padding: 8px 15px; 
        border-radius: 10px;
        border: 1px solid #e1e4e8;
    }
    
    /* Tabs hi·ªán ƒë·∫°i */
    .tabs { 
        display: flex; 
        border-bottom: 2px solid #f1f1f1; 
        margin-bottom: 25px; 
    }
    .tab { 
        padding: 12px 25px; 
        cursor: pointer; 
        font-weight: 600; 
        color: #9ca3af; 
        transition: 0.3s; 
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
    }
    .tab:hover { color: var(--primary-color); }
    .tab.active { 
        color: var(--primary-color); 
        border-bottom: 2px solid var(--primary-color); 
    }
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }

    /* Tables Style (Gi·ªëng Scheduler) */
    table { 
        width: 100%; 
        border-collapse: separate; 
        border-spacing: 0; 
        margin-top: 15px; 
        border: 1px solid #eee;
        border-radius: 12px;
        overflow: hidden;
    }
    th, td { 
        padding: 12px 15px; 
        text-align: left; 
        border-bottom: 1px solid #eee; 
    }
    th { 
        background: #f9fafb; 
        color: #4b5563; 
        font-weight: 700; 
        text-transform: uppercase; 
        font-size: 12px;
        border-bottom: 2px solid #eee;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: #f9fbfc; }
    
    /* Buttons & Inputs */
    button { 
        padding: 9px 16px; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        transition: 0.2s; 
        font-weight: 600; 
        font-family: 'Inter', sans-serif;
        font-size: 13px;
        display: inline-flex; align-items: center; gap: 5px;
    }
    button:hover { transform: translateY(-1px); filter: brightness(105%); }
    
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-success { background: var(--success-color); color: white; }
    .btn-danger  { background: var(--danger-color); color: white; }
    .btn-edit    { background: #f39c12; color: white; }
    .btn-sm      { padding: 6px 12px; font-size: 12px; }
    
    select, input { 
        padding: 10px; 
        border: 1px solid #d1d5db; 
        border-radius: 8px; 
        font-family: 'Inter', sans-serif;
    }
    select:focus, input:focus { outline: none; border-color: var(--primary-color); }

    /* === POPUP FIXED (B·∫£n v√° l·ªói ti√™u ƒë·ªÅ) === */
    .popup-bg { 
        display: none; 
        position: fixed; 
        top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(44, 62, 80, 0.6); 
        backdrop-filter: blur(2px);
        justify-content: center; align-items: center; 
        z-index: 1000; 
    }
    .popup-box { 
        background: white; 
        /* Padding top = 0 ƒë·ªÉ ti√™u ƒë·ªÅ s√°t m√©p */
        padding: 0 25px 25px 25px; 
        width: 450px; 
        border-radius: 16px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        animation: slideIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }
    .popup-box h3 { 
        background: var(--primary-color); 
        color: white; 
        /* K√©o tr√†n sang 2 b√™n, kh√¥ng k√©o l√™n tr√™n */
        margin: 0 -25px 20px -25px; 
        padding: 15px 25px;
        border-radius: 16px 16px 0 0;
        font-size: 16px;
    }
    
    @keyframes slideIn {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .popup-box input, .popup-box select { width: 100%; margin: 5px 0 15px; box-sizing: border-box; }
    .popup-footer { text-align: right; margin-top: 10px; }

    /* Multi-select Style */
    .multi-select-box { 
        border: 1px solid #d1d5db; 
        padding: 10px; 
        max-height: 120px; 
        overflow-y: auto; 
        margin-bottom: 15px; 
        border-radius: 8px; 
        background: #f9fafb;
    }
    .multi-select-box label { display: block; margin-bottom: 5px; cursor: pointer; font-size: 13px; }
    .multi-select-box input { width: auto; margin-right: 8px; }

    #loading { display: none; text-align: center; color: #666; margin-top: 20px; font-style: italic; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .hidden { display: none !important; }
</style>
</head>
<body>

<div class="container">
    <div class="dashboard-header">
        <div>
            <h2>H·ªÜ TH·ªêNG QU·∫¢N TR·ªä</h2>
            <div class="user-info-bar">
                Xin ch√†o, <b id="lblCurrentUser" style="color:var(--text-color)">...</b> 
                (<span id="lblCurrentRole" style="background:#e0f2fe; color:var(--primary-color); padding:2px 6px; border-radius:4px; font-size:12px;">...</span>)
            </div>
        </div>
        
        <div class="quick-access">
            <span style="font-weight:600; color:#4b5563; font-size:13px;">‚ö° Ch·ªçn nh√≥m:</span>
            <select id="quickGroupSelect" style="padding:6px; font-size:13px;">
                <option value="">-- ƒêang t·∫£i --</option>
            </select>
            <button class="btn-success" onclick="goToSchedule()">V√†o L·ªãch ‚Üí</button>
            <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
            <button class="btn-danger" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>

    <div class="tabs" id="adminTabs">
        <div class="tab active" onclick="switchTab('users')">Qu·∫£n l√Ω T√†i kho·∫£n</div>
        <div class="tab" onclick="switchTab('groups')">Qu·∫£n l√Ω Nh√≥m</div>
    </div>

    <div id="tab-users" class="tab-content active">
        <button class="btn-primary" onclick="openUserPopup()">+ Th√™m T√†i Kho·∫£n M·ªõi</button>
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Vai tr√≤</th>
                    <th>Nh√≥m Ch√≠nh</th>
                    <th>Nh√≥m Ph·ª•</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
        </table>
    </div>

    <div id="tab-groups" class="tab-content">
        <div style="display:flex; gap:10px; align-items: center; margin-bottom: 15px; background: #f9fafb; padding: 15px; border-radius: 12px; border: 1px solid #eee;">
            <input id="newGroupInput" placeholder="Nh·∫≠p t√™n nh√≥m m·ªõi..." style="width: 300px;">
            <button class="btn-primary" onclick="addGroup()">+ T·∫°o Nh√≥m</button>
        </div>
        <table>
            <thead><tr><th>T√™n Nh√≥m</th><th style="width: 150px; text-align:center;">Thao t√°c</th></tr></thead>
            <tbody id="groupTableBody"></tbody>
        </table>
    </div>
    
    <div id="userWelcomeMsg" class="hidden" style="text-align:center; padding: 50px; color:#666;">
        <div style="font-size: 50px; margin-bottom: 20px;">üëã</div>
        <h3>Ch√†o m·ª´ng quay tr·ªü l·∫°i!</h3>
        <p>Vui l√≤ng ch·ªçn nh√≥m l√†m vi·ªác ·ªü g√≥c tr√™n b√™n ph·∫£i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
    </div>
    
    <div id="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
</div>

<div id="userPopup" class="popup-bg">
    <div class="popup-box">
        <h3 id="popupTitle">Th√™m T√†i Kho·∫£n</h3>
        
        <label style="font-size:13px; font-weight:600; color:#555;">T√™n ƒëƒÉng nh·∫≠p:</label>
        <input id="uUsername" placeholder="V√≠ d·ª•: admin">
        
        <label style="font-size:13px; font-weight:600; color:#555;">M·∫≠t kh·∫©u:</label>
        <input id="uPassword" type="text">
        
        <label style="font-size:13px; font-weight:600; color:#555;">Vai tr√≤:</label>
        <select id="uRole">
            <option value="Admin">Admin (To√†n quy·ªÅn)</option>
            <option value="Manager">Manager (Qu·∫£n l√Ω)</option>
            <option value="User">User (Nh√¢n vi√™n)</option>
        </select>
        
        <label style="font-size:13px; font-weight:600; color:#555;">Nh√≥m Ch√≠nh (B·∫Øt bu·ªôc):</label>
        <select id="uGroup">
            <option value="">-- Ch·ªçn nh√≥m ch√≠nh --</option>
        </select>
        
        <label style="font-size:13px; font-weight:600; color:#555;">Nh√≥m Ph·ª• (Xem th√™m):</label>
        <div id="uGroupsMulti" class="multi-select-box"></div>

        <div class="popup-footer">
            <button class="btn-danger" onclick="closeUserPopup()">H·ªßy</button>
            <button class="btn-primary" onclick="saveUser()">L∆∞u l·∫°i</button>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = localStorage.getItem("SCRIPT_URL");
    
    const currentUser = localStorage.getItem("currentUser") || "Guest"; 
    const currentRole = localStorage.getItem("currentRole") || "User"; 
    const currentGroup = localStorage.getItem("currentGroup") || ""; 
    const currentGroupsSub = localStorage.getItem("currentGroupsSub") || ""; 

    if (!SCRIPT_URL) {
        alert("Ch∆∞a c·∫•u h√¨nh URL!");
    }

    document.getElementById("lblCurrentUser").innerText = currentUser;
    document.getElementById("lblCurrentRole").innerText = currentRole;

    let isEditing = false;
    let allGroups = [];

    document.addEventListener("DOMContentLoaded", () => {
        if (currentRole !== "Admin") {
            document.getElementById("adminTabs").style.display = "none";
            document.getElementById("tab-users").classList.remove("active");
            document.getElementById("tab-groups").classList.remove("active");
            document.getElementById("userWelcomeMsg").classList.remove("hidden");
        }
        loadData();
    });

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        if(tabName === 'users') {
            document.querySelector('.tab:nth-child(1)').classList.add('active');
            document.getElementById('tab-users').classList.add('active');
        } else {
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('tab-groups').classList.add('active');
        }
    }

    function logout() {
        localStorage.clear(); 
        window.location.href = "index.html";
    }

    function goToSchedule() {
        const group = document.getElementById("quickGroupSelect").value;
        if (!group) return alert("Vui l√≤ng ch·ªçn m·ªôt nh√≥m!");
        window.location.href = `scheduler.html?group=${encodeURIComponent(group)}`;
    }

    async function loadData() {
        document.getElementById("loading").style.display = "block";
        try {
            const resG = await fetch(`${SCRIPT_URL}?action=listGroups`);
            const jsonG = await resG.json();
            if (jsonG.success) {
                allGroups = jsonG.groups;
                renderGroups(allGroups);
                
                let allowedGroups = [];
                if (currentRole === "Admin") {
                    allowedGroups = allGroups; 
                } else {
                    if (currentGroup) allowedGroups.push(currentGroup);
                    if (currentGroupsSub) {
                        const subs = currentGroupsSub.split(",").map(s => s.trim());
                        allowedGroups = [...allowedGroups, ...subs];
                    }
                    allowedGroups = [...new Set(allowedGroups)].filter(g => allGroups.includes(g));
                }
                
                updateQuickAccess(allowedGroups);
                updatePopupGroupSelects(allGroups); 
            }

            if (currentRole === "Admin") {
                const resU = await fetch(`${SCRIPT_URL}?action=listUsers`);
                const jsonU = await resU.json();
                if (jsonU.success) {
                    renderUsers(jsonU.users);
                }
            }
        } catch(e) { console.error(e); }
        document.getElementById("loading").style.display = "none";
    }

    function updateQuickAccess(groups) {
        const sel = document.getElementById("quickGroupSelect");
        sel.innerHTML = '<option value="">-- Ch·ªçn nh√≥m l√†m vi·ªác --</option>';
        groups.forEach(g => {
            const opt = document.createElement("option");
            opt.value = g; opt.innerText = g;
            sel.appendChild(opt);
        });
    }

    function updatePopupGroupSelects(groups) {
        const selUser = document.getElementById("uGroup");
        selUser.innerHTML = '<option value="">-- Ch·ªçn nh√≥m ch√≠nh --</option>';
        groups.forEach(g => {
            const opt = document.createElement("option");
            opt.value = g; opt.innerText = g;
            selUser.appendChild(opt);
        });

        const divMulti = document.getElementById("uGroupsMulti");
        divMulti.innerHTML = "";
        groups.forEach(g => {
            const lbl = document.createElement("label");
            lbl.innerHTML = `<input type="checkbox" value="${g}" class="chk-group-sub"> ${g}`;
            divMulti.appendChild(lbl);
        });
    }

    function renderUsers(users) {
        const tbody = document.getElementById("userTableBody");
        tbody.innerHTML = "";
        users.forEach(u => {
            const tr = document.createElement("tr");
            let subGroupsDisplay = u.groups ? u.groups : "-";
            
            tr.innerHTML = `
                <td style="font-family:monospace; color:#666;">${u.username}</td>
                <td><span style="background:#e0f2fe; color:#0284c7; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:600;">${u.role}</span></td>
                <td style="color:#d97706; font-weight:600;">${u.group || "-"}</td>
                <td style="font-size:13px; color:#666;">${subGroupsDisplay}</td>
                <td>
                    <button class="btn-edit btn-sm" onclick='editUser(${JSON.stringify(u)})'>‚úè S·ª≠a</button>
                    <button class="btn-danger btn-sm" onclick="deleteUser('${u.username}')">üóë X√≥a</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function openUserPopup() {
        isEditing = false;
        document.getElementById("popupTitle").innerText = "Th√™m T√†i Kho·∫£n M·ªõi";
        document.getElementById("uUsername").value = "";
        document.getElementById("uUsername").disabled = false;
        document.getElementById("uPassword").value = "";
        document.getElementById("uRole").value = "User";
        document.getElementById("uGroup").value = "";
        document.querySelectorAll(".chk-group-sub").forEach(c => c.checked = false);
        document.getElementById("userPopup").style.display = "flex";
    }

    function editUser(u) {
        isEditing = true;
        document.getElementById("popupTitle").innerText = "S·ª≠a: " + u.username;
        document.getElementById("uUsername").value = u.username;
        document.getElementById("uUsername").disabled = true; 
        document.getElementById("uPassword").value = u.password;
        document.getElementById("uRole").value = u.role;
        document.getElementById("uGroup").value = u.group || "";
        
        const subList = (u.groups || "").split(",").map(s => s.trim());
        document.querySelectorAll(".chk-group-sub").forEach(c => {
            c.checked = subList.includes(c.value);
        });
        document.getElementById("userPopup").style.display = "flex";
    }

    function closeUserPopup() { document.getElementById("userPopup").style.display = "none"; }

    async function saveUser() {
        const selectedSubs = [];
        document.querySelectorAll(".chk-group-sub:checked").forEach(c => selectedSubs.push(c.value));
        const subGroupsStr = selectedSubs.join(",");

        const u = {
            username: document.getElementById("uUsername").value.trim(),
            password: document.getElementById("uPassword").value.trim(),
            role: document.getElementById("uRole").value,
            group: document.getElementById("uGroup").value,
            groups: subGroupsStr 
        };

        if(!u.username || !u.password) return alert("Thi·∫øu th√¥ng tin ƒëƒÉng nh·∫≠p!");

        const btn = document.querySelector("#userPopup .btn-primary");
        const oldText = btn.innerText;
        btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;
        const action = isEditing ? "updateUser" : "createUser";
        
        try {
            await fetch(`${SCRIPT_URL}?action=${action}&data=` + encodeURIComponent(JSON.stringify(u)));
            alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
            closeUserPopup();
            loadData();
        } catch(e) { alert("L·ªói l∆∞u user!"); }
        finally { btn.innerText = oldText; btn.disabled = false; }
    }

    async function deleteUser(username) {
        if(!confirm(`X√≥a t√†i kho·∫£n ${username}?`)) return;
        try {
            await fetch(`${SCRIPT_URL}?action=deleteUser&username=${encodeURIComponent(username)}`);
            loadData();
        } catch(e) { alert("L·ªói x√≥a user!"); }
    }

    function renderGroups(groups) {
        const tbody = document.getElementById("groupTableBody");
        tbody.innerHTML = "";
        groups.forEach(g => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td style="font-weight:600; color:#2c3e50;">${g}</td>
                <td style="text-align:center;"><button class="btn-danger btn-sm" onclick="deleteGroup('${g}')">üóë X√≥a nh√≥m</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function addGroup() {
        const name = document.getElementById("newGroupInput").value.trim();
        if(!name) return alert("Nh·∫≠p t√™n nh√≥m!");
        try {
            await fetch(`${SCRIPT_URL}?action=addGroup&group=${encodeURIComponent(name)}`);
            document.getElementById("newGroupInput").value = "";
            loadData();
        } catch(e) { alert("L·ªói th√™m nh√≥m"); }
    }

    async function deleteGroup(name) {
        if(!confirm(`C·∫¢NH B√ÅO: X√≥a nh√≥m [${name}]?`)) return;
        try {
            await fetch(`${SCRIPT_URL}?action=deleteGroup&group=${encodeURIComponent(name)}`);
            loadData();
        } catch(e) { alert("L·ªói x√≥a nh√≥m"); }
    }
</script>

</body>
</html>